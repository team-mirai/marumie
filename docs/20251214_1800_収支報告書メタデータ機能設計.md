# 収支報告書 団体プロフィール機能設計

## 概要

収支報告書XML書き出し機能において、政治団体のプロフィール情報（第14号様式 その1）を管理・出力するための機能を追加する。

## 背景

現在の収支報告書XML出力機能では、政治団体の基本情報（団体名称、所在地、代表者情報など）が未実装である。総務省の仕様に準拠した報告書を出力するためには、`SYUUSHI07_01` セクションに相当する団体プロフィール情報の入力・管理機能が必要となる。

## 要件

### 機能要件

1. 管理画面から政治団体ごとに報告書用プロフィールを登録・編集できる
2. 登録されたプロフィールを収支報告書XMLの `SYUUSHI07_01` セクションとして出力できる
3. プロフィールが未登録の場合でも既存のXML出力機能に影響を与えない

## データ設計

### テーブル構成

`PoliticalOrganization` とは別テーブルとして `OrganizationReportProfile` を新設する。

#### 分離の理由

| 観点 | 説明 |
|------|------|
| 責務の分離 | 団体マスタ（アプリ内での識別・表示用）と報告書データ（総務省提出用）はドメインが異なる |
| ライフサイクル | 団体マスタは基本不変、報告書プロフィールは報告書作成時に更新される |
| 拡張性 | 年度別管理が必要になった場合、`financialYear` カラム追加で対応可能 |
| マイグレーション | 既存テーブルを変更せず、新テーブル追加のみで実装可能 |

### スキーマ定義

```prisma
model OrganizationReportProfile {
  id                      BigInt   @id @default(autoincrement())
  politicalOrganizationId BigInt   @map("political_organization_id")
  financialYear           Int      @map("financial_year")  // 報告年（西暦）

  // 基本情報（カラム化：他機能でも参照可能性あり）
  officialName            String?  @map("official_name") @db.VarChar(120)
  officialNameKana        String?  @map("official_name_kana") @db.VarChar(120)
  officeAddress           String?  @map("office_address") @db.VarChar(80)
  officeAddressBuilding   String?  @map("office_address_building") @db.VarChar(60)

  // その他の詳細情報（JSON）
  details                 Json?    @default("{}")

  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  politicalOrganization   PoliticalOrganization @relation(fields: [politicalOrganizationId], references: [id], onDelete: Cascade)

  @@unique([politicalOrganizationId, financialYear])
  @@map("organization_report_profiles")
}
```

### JSON構造（details カラム）

```typescript
type OrganizationReportProfileDetails = {
  // 代表者
  representative?: {
    lastName: string   // DAI_NM1
    firstName: string  // DAI_NM2
  }

  // 会計責任者
  accountant?: {
    lastName: string   // KAI_NM1
    firstName: string  // KAI_NM2
  }

  // 事務担当者（最大3名）
  contactPersons?: Array<{
    lastName: string   // TANTOU*_NM1
    firstName: string  // TANTOU*_NM2
    tel: string        // TANTOU*_TEL
  }>

  // 団体区分
  organizationType?: string       // DANTAI_KBN (2桁コード)

  // 活動区域
  activityArea?: '1' | '2'        // KATU_KUKI
                                  // 1: 二以上の都道府県
                                  // 2: 一つの都道府県

  // 資金管理団体情報（SIKIN_UMU=1 の場合のみ）
  fundManagement?: {
    publicPositionName?: string   // KOSYOKU_NM
    publicPositionType?: '1' | '2' | '3' | '4'  // KOSYOKU_KBN
                                  // 1:現職 2:候補者 3:候補者となろうとする者 4:候補者等
    applicant?: {
      lastName: string            // SIKIN_TODOKE_NM1
      firstName: string           // SIKIN_TODOKE_NM2
    }
    periods?: Array<{
      from: string                // SIKIN_KIKAN1 (和暦 ge/m/d)
      to: string                  // SIKIN_KIKAN2 (和暦 ge/m/d)
    }>
  }

  // 国会議員関係政治団体情報（GIIN_DANTAI_KBN!=0 の場合のみ）
  dietMemberRelation?: {
    type: '0' | '1' | '2' | '3'   // GIIN_DANTAI_KBN
                                  // 0:指定無し 1:1号団体 2:2号団体 3:両方
    members?: Array<{
      lastName: string            // GIIN*_KOSYOKU_NM_1
      firstName: string           // GIIN*_KOSYOKU_NM_2
      chamber: '1' | '2'          // GIIN*_KOSYOKU_NM
                                  // 1:衆議院議員 2:参議院議員
      positionType: '1' | '2' | '3' | '4'  // GIIN*_KOSYOKU_KBN
    }>
    periods?: Array<{
      from: string                // GIIN_KIKAN1 (和暦 ge/m/d)
      to: string                  // GIIN_KIKAN2 (和暦 ge/m/d)
    }>
  }

  // 特定パーティー開催日（該当する場合のみ）
  specificPartyDate?: string      // KAISAI_DT (和暦 ge/m/d)
}
```

## XMLマッピング

### SYUUSHI07_01 出力仕様

| XML タグ | データソース |
|----------|-------------|
| HOUKOKU_NEN | 出力時に指定する報告年 |
| KAISAI_DT | details.specificPartyDate |
| DANTAI_NM | officialName |
| DANTAI_KANA | officialNameKana |
| JIM_ADR | officeAddress |
| JIM_APA_ADR | officeAddressBuilding |
| DAI_NM1, DAI_NM2 | details.representative |
| KAI_NM1, KAI_NM2 | details.accountant |
| TANTOU*_NM1, TANTOU*_NM2, TANTOU*_TEL | details.contactPersons[0-2] |
| DANTAI_KBN | details.organizationType |
| KATU_KUKI | details.activityArea |
| SIKIN_UMU | details.fundManagement の有無で判定 |
| SIKIN_* | details.fundManagement.* |
| GIIN_DANTAI_KBN | details.dietMemberRelation.type |
| GIIN*_* | details.dietMemberRelation.members[0-2] |

### 出力時の注意点

1. **日付形式**: DB保存時は `ge/m/d` 形式の文字列、XML出力時はそのまま使用
2. **エンコーディング**: XML出力時に Shift_JIS へ変換
3. **NULL処理**: 未設定項目は空タグとして出力（仕様に準拠）

## 設計上の考慮事項

### 年度別管理

スキーマは最初から `financialYear` を含む設計としている。これにより:

- 報告年ごとに代表者や住所が変わるケースに対応可能
- 過去年度のプロフィールを保持したまま、新年度分を作成できる
- XML出力時に報告年を指定すれば、該当年度のプロフィールを自動的に取得

## 管理画面 UI 設計方針

1. 団体詳細画面に「報告書設定」タブを追加
2. 入力フォームは以下のセクションに分割:
   - 基本情報（団体名称、住所）
   - 代表者・会計責任者
   - 事務担当者（動的に追加可能、最大3名）
   - 団体区分・活動区域
   - 資金管理団体情報（トグルで表示切替）
   - 国会議員関係情報（トグルで表示切替）

## バックエンド実装設計

### ディレクトリ構成

`report` コンテキスト内に追加する。

```
admin/src/server/contexts/report/
├── domain/
│   ├── models/
│   │   ├── report-data.ts                    # 既存（profile追加）
│   │   └── organization-report-profile.ts    # 新規: ドメインモデル
│   ├── repositories/
│   │   └── organization-report-profile-repository.interface.ts  # 新規
│   └── services/
│       └── profile-serializer.ts             # 新規: SYUUSHI07_01 XML変換
├── application/
│   └── usecases/
│       ├── xml-export-usecase.ts             # 既存（profile取得追加）
│       ├── get-organization-profile-usecase.ts    # 新規
│       └── save-organization-profile-usecase.ts   # 新規
├── infrastructure/
│   └── repositories/
│       └── prisma-organization-report-profile.repository.ts  # 新規
└── presentation/
    ├── loaders/
    │   └── organization-profile-loader.ts    # 新規
    └── actions/
        └── save-organization-profile.ts      # 新規
```

### 実装方針

- **ドメインモデル**: JSON構造の型定義と、DBレコードに対応する `OrganizationReportProfile` 型
- **リポジトリ**: `findByOrganizationIdAndYear`, `create`, `update` の3メソッド
- **ユースケース**: 取得用・新規作成用・更新用の3つ（フロントで存在チェックして分岐）
- **XML出力**: `ReportData` に `profile` を追加し、`XmlExportUsecase` で並列取得
- **Presentation層**: Loader（サーバーコンポーネント用）と Server Action（フォーム送信用）
- **バリデーション**: Zod スキーマで文字数制限・enum値をチェック

## フロントエンド実装設計

### ページ構成

団体詳細ページにタブを追加し、「報告書設定」タブで本機能を提供する。

```
admin/src/app/(auth)/political-organizations/[orgId]/
├── page.tsx                      # 既存: 団体基本情報編集
└── report-profile/
    └── page.tsx                  # 新規: 報告書プロフィール編集ページ
```

### コンポーネント構成

```
admin/src/client/components/
└── report-profile/
    ├── ReportProfileForm.tsx           # メインフォーム（タブ構成）
    ├── BasicInfoSection.tsx            # 基本情報セクション（団体名、住所）
    ├── RepresentativeSection.tsx       # 代表者・会計責任者セクション
    ├── ContactPersonsSection.tsx       # 事務担当者セクション（動的追加/削除）
    ├── OrganizationTypeSection.tsx     # 団体区分・活動区域セクション
    ├── FundManagementSection.tsx       # 資金管理団体情報セクション（条件付き表示）
    └── DietMemberRelationSection.tsx   # 国会議員関係情報セクション（条件付き表示）
```

### 実装方針

- **ページ**: サーバーコンポーネントで Loader からデータ取得、フォームコンポーネントに渡す
- **フォーム**: `"use client"` でクライアントコンポーネント、react-hook-form + Zod でバリデーション
- **セクション分割**: 各セクションは独立したコンポーネントに分離し、見通しを良くする
- **条件付き表示**: 資金管理団体・国会議員関係はトグル（チェックボックス）で表示切替
- **動的フィールド**: 事務担当者・国会議員は `useFieldArray` で追加/削除可能に
- **保存**: Server Action を呼び出し、成功時に `revalidatePath` で再検証

### 画面遷移

```
政治団体一覧 → 団体詳細（基本情報）
                    ↓ タブ切替 or リンク
              報告書プロフィール編集
                    ↓ 保存
              （同ページにとどまり成功メッセージ表示）
```

### UI/UX 方針

- 既存の `PoliticalOrganizationForm` のスタイルに合わせる（Tailwind CSS）
- 長いフォームなので、セクションごとにカード or アコーディオンで区切る
- 資金管理団体・国会議員関係は初期状態で折りたたみ、必要な場合のみ展開
- 和暦入力は `ge/m/d` 形式のテキスト入力（例: `R6/4/1`）
- 文字数制限はリアルタイムでカウント表示

## 実装タスク

### バックエンド

1. Prisma スキーマ追加・マイグレーション
2. ドメインモデル・型定義作成
3. リポジトリ（インターフェース・実装）作成
4. ユースケース作成（取得・保存）
5. ProfileSerializer 作成（XML変換）
6. XmlExportUsecase への組み込み
7. Presentation層（Loader・Action）作成
8. バリデーションスキーマ作成

### フロントエンド

9. ページコンポーネント作成（report-profile/page.tsx）
10. ReportProfileForm 作成
11. 各セクションコンポーネント作成
12. 団体詳細ページへのナビゲーション追加

### テスト・その他

13. バックエンドテスト作成
