# 個人寄附の名寄せ・小計行実装設計

## 目的

**政治団体の会計担当者**が、**同一寄附者から複数回の寄附があった場合に、法令・手引に準拠した小計行を含むXMLを出力できない状態**を解消するため。

---

## スコープ

[docs/scope-by-2026Jan.md](scope-by-2026Jan.md) に基づき、以下の範囲に限定する：

| 対象 | 備考 |
|------|------|
| **SYUUSHI07_07 KUBUN1（個人からの寄附）** | 対応必須 |
| KUBUN2（法人からの寄附） | スコープ外（政党以外は受領不可） |
| KUBUN3（政治団体からの寄附） | スコープ外（別途対応予定） |
| その8・その11・その12 | スコープ外（実績なし/パーティー未開催） |

---

## 現状分析

### 実装済みの機能

`donation-transaction.ts` の `PersonalDonationSection.fromTransactions()` で以下が実装済み：

1. **donorId によるグループ化**: 同一寄附者のトランザクションをグループ化
2. **5万円閾値の判定**: 年間合計5万円超 → 明細行、以下 → sonotaGk に合算
3. **明細行の生成**: `PersonalDonationTransaction.toRow()` で行を生成

### 未実装の機能

1. **小計行（ROWKBN=1）の生成**: 同一寄附者の明細が2件以上の場合、最後に小計行を追加
2. **通し番号（SEQ_NO）の採番**: 同一寄附者グループに同じ番号を付与
3. **日付順ソート**: グループ内の明細を年月日順に並べる

---

## 実装タスク

### タスク1: ドメインモデルの拡張

**対象ファイル**: `admin/src/server/contexts/report/domain/models/donation-transaction.ts`

**実装場所の判断**:
- `PersonalDonationSection` は「複数のトランザクションを集約してセクションを構築する」責務を持つモデル
- 名寄せ・小計行生成はこの集約処理の一部であり、既存の `fromTransactions()` を拡張するのが適切
- ドメインサービスへの切り出しは不要

**変更内容**:

1. `PersonalDonationSection.fromTransactions()` を拡張
   - グループ内の明細を日付順にソートする
   - グループ内の明細が2件以上の場合、小計行を追加する
   - 通し番号（seqNo）を採番する

2. 小計行生成ロジックの追加
   - `kifusyaNm`: 「（小計）」固定
   - `kingaku`: グループ内の合計金額
   - `dt`, `adr`, `syokugyo`, `bikou`: 空文字列
   - `seqNo`: グループの通し番号
   - `rowkbn`: "1"（小計行）
   - `zeigakukoujyo`: "0"

3. 一連番号（ichirenNo）の採番
   - 明細行・小計行を含めて通し連番で振る

### タスク2: XMLシリアライザの確認

**対象ファイル**: `admin/src/server/contexts/report/domain/services/donation-serializer.ts`

**確認内容**:

- `seqNo` が空の場合に空タグとして出力されているか確認
- 小計行の場合に日付等が空で出力されることを確認

### タスク3: 合計金額（KINGAKU_GK）の算出方法確認

**対象ファイル**: `admin/src/server/contexts/report/domain/models/donation-transaction.ts`

**確認内容**:

- `totalAmount` が**小計行を除いた明細行のみ**で算出されていることを確認
- 現在の実装では、小計行を追加する前の `totalAmount` を算出しているため、追加ロジック導入後も問題ないことを確認

### タスク4: バリデーションの拡張

**対象ファイル**: `admin/src/server/contexts/report/domain/models/donation-transaction.ts`

**変更内容**:

- `PersonalDonationSection.validate()` で小計行（rowkbn="1"）はバリデーション対象外とする

### タスク5: テストの追加

**対象ファイル**: 新規作成 `admin/src/server/contexts/report/domain/models/__tests__/donation-transaction.test.ts`

**テストケース**:

1. 同一寄附者から2件以上 → 小計行が生成される
2. 同一寄附者から1件のみ → 小計行なし
3. 複数の寄附者（2件以上と1件混在） → 該当グループのみ小計行あり
4. 一連番号が明細・小計通しで連番になっている
5. 通し番号が同一グループで同じ値になっている
6. 日付順にソートされている
7. 合計金額に小計行が含まれていない

---

## データ構造

### 入力

```
PersonalDonationTransaction[]
  - transactionNo
  - transactionDate
  - debitAmount / creditAmount
  - donorId        ← グループ化キー
  - donorName
  - donorAddress
  - donorOccupation
```

### 出力

```
PersonalDonationSection
  - totalAmount    ← 明細行（rowkbn=0）のみの合計
  - sonotaGk       ← 5万円以下グループの合計
  - rows[]
    - ichirenNo    ← 1始まり連番（明細・小計通し）
    - seqNo        ← グループごとの通し番号
    - rowkbn       ← "0"=明細, "1"=小計
    - kifusyaNm    ← 小計行は「（小計）」
    - kingaku
    - dt           ← 小計行は空
    - adr          ← 小計行は空
    - syokugyo     ← 小計行は空
    - bikou        ← 小計行は空
    - zeigakukoujyo
```

---

## 処理フロー

```
1. トランザクションを donorId でグループ化

2. 各グループについて:
   a. 年間合計金額を算出
   b. 5万円以下 → sonotaGk に加算してスキップ
   c. 5万円超 → 処理対象グループとして保持

3. 処理対象グループを「グループ内最初の取引日付順」でソート

4. 各グループについて:
   a. グループ内の明細を日付順にソート
   b. 各明細を PersonalDonationRow に変換（seqNo 付与）
   c. グループ内明細が2件以上の場合、小計行を追加

5. 全行に一連番号（ichirenNo）を振る

6. PersonalDonationSection を構築して返す
```

---

## 注意事項

### donorId が null の場合

`donorId` が null のトランザクションは名寄せの対象外となる。

- 現在の実装では `donorId === null` の場合、各取引を別グループとして扱う
- 同一人物からの寄附であっても、寄附者マスタに紐付いていなければ名寄せされない
- 結果として、donorId が null の取引は常に1件扱いとなり、小計行は生成されない

**UI上の考慮**: 寄附者マスタへの紐付けが名寄せの前提条件であることを、ユーザーに明示することが望ましい。

### グループの並び順

処理対象グループ（5万円超）の並び順は「グループ内最初の取引日付順」とする。

- 各グループの中で最も古い取引日付を基準にソート
- 同一日付のグループ間の順序は不定（実装依存）

---

## エラーハンドリング

既存のバリデーション（`PersonalDonationSection.validate()`）に以下を追加：

| コード | severity | 条件 | メッセージ |
|--------|----------|------|-----------|
| （なし） | - | 小計行（rowkbn=1）は検証スキップ | - |

小計行は自動生成されるため、バリデーションエラーが発生しうる状況はない。
明細行のバリデーションは既存実装で対応済み。

---

## 影響範囲

| ファイル | 変更種別 | 内容 |
|----------|----------|------|
| `domain/models/donation-transaction.ts` | 変更 | 小計行生成ロジック追加 |
| `domain/services/donation-serializer.ts` | 確認のみ | 空タグ出力の動作確認 |
| `domain/models/__tests__/donation-transaction.test.ts` | 新規 | テスト追加 |

---

## 参考資料

- [docs/20260104_1220_寄附の名寄せ小計行機能要件.md](20260104_1220_寄附の名寄せ小計行機能要件.md) - 要件定義
- [data/reports/donation-aggregation-sample.xml](../data/reports/donation-aggregation-sample.xml) - サンプルXML
