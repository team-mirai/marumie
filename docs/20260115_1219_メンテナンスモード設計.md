# メンテナンスモード設計

## 目的

**運用者が**DBマイグレーションやSupabaseメンテナンス時に、**アプリケーションを安全に停止できる状態にするため**

メンテナンスモードを有効にすることで、以下を実現する：
- ユーザーにメンテナンス中であることを明確に伝える
- DBへのリクエストを完全にゼロにし、データ整合性を保護する

## 設計方針

### 環境変数による制御

| 環境変数 | 値 | 説明 |
|----------|-----|------|
| `MAINTENANCE_MODE` | `"true"` / 未設定 | メンテナンスモードの有効/無効 |
| `MAINTENANCE_MESSAGE` | 任意の文字列 / 未設定 | メンテナンス画面に表示する追加メッセージ |

- `MAINTENANCE_MODE` が `"true"` の場合のみメンテナンスモードが有効
- 未設定または他の値の場合は通常動作
- `MAINTENANCE_MESSAGE` で予定時間などを表示可能（例: `"予定時間 22:00-26:00"`）

### 実装方式: Next.js Middleware

webapp/admin 両方で `middleware.ts` を使用してメンテナンスモードを実装する。

**Middlewareを選択する理由:**
- Edge Runtimeで動作し、ページレンダリング**前**に実行される
- サーバーコンポーネントやAPIルートへのアクセスを完全にブロックできる
- DBアクセスを確実にゼロにできる
- 静的HTMLを直接返すことで、外部依存なしでレスポンス可能

**page.tsx は不要:**
- Middlewareから直接 `new Response(html, { status: 503 })` でHTMLを返す
- `page.tsx` や `layout.tsx` を経由しないため、それらで行われるDB接続も回避できる
- メンテナンスページ用のルート（例: `/maintenance`）を作成する必要がない

## 処理フロー

```
リクエスト
  │
  ▼
middleware.ts
  │
  ├─ MAINTENANCE_MODE !== "true"
  │     └─ 通常処理へ（next()）
  │
  └─ MAINTENANCE_MODE === "true"
        │
        ├─ 静的アセット（_next/static, favicon等）
        │     └─ 通常処理へ（next()）
        │
        └─ その他すべてのリクエスト
              └─ メンテナンスページ（HTML）を返す
                 └─ Status: 503 Service Unavailable
```

## 各アプリケーションでの実装詳細

### webapp (公開フロントエンド)

**配置**: `webapp/src/middleware.ts`

**動作:**
- 全ページでメンテナンス画面を表示
- APIルート `/api/refresh` もブロック
- 静的アセットのみ通過を許可

**メンテナンス画面:**
- エンドユーザー向けのためデザインを適用
- インラインCSSでスタイリング（外部CSS読み込み不可のため）
- レスポンシブ対応

### admin (管理画面)

**配置**: `admin/src/middleware.ts`

**動作:**
- 全ページでメンテナンス画面を表示
- 認証コールバック `/api/auth/callback` もブロック
- その他APIルートもすべてブロック
- 静的アセットのみ通過を許可

**メンテナンス画面:**
- 管理者向けのシンプルなデザイン

## HTTPレスポンス仕様

| 項目 | 値 |
|------|-----|
| Status Code | `503 Service Unavailable` |
| Content-Type | `text/html; charset=utf-8` |
| Retry-After | `3600`（1時間、目安として） |
| Cache-Control | `no-store, no-cache, must-revalidate` |

**503を選択する理由:**
- 一時的なサービス停止を示す標準的なステータスコード
- 検索エンジンがインデックスを削除しない（503は一時的な状態と解釈される）
- `Retry-After` ヘッダーでクライアントに再試行のタイミングを伝えられる

## Middlewareの除外パス

以下のパスはメンテナンスモード中も通常処理を行う（静的アセット配信のため）:

```
/_next/static/*   # Next.jsビルド済みアセット
/_next/image/*    # Next.js Image Optimization
/favicon.ico      # ファビコン
/robots.txt       # 検索エンジン向け
```

## 環境変数の設定方法

### Vercel（本番環境）

Vercel Dashboard → Settings → Environment Variables で設定:
- `MAINTENANCE_MODE` = `"true"`

**注意**: 環境変数変更後、再デプロイが必要（環境変数はビルド時に埋め込まれる）

> **動的な切り替えが必要な場合**: Vercel Edge Config（`@vercel/edge-config`）を使用すると、再デプロイなしでフラグを切り替えられる。ただし本設計では環境変数方式を採用する。

### ローカル開発

`.env.local` に追加:
```
MAINTENANCE_MODE="true"
```

## 運用手順

### メンテナンス開始

1. Vercel Dashboardで環境変数を設定（webapp/admin両方）
   - `MAINTENANCE_MODE` = `"true"`
   - `MAINTENANCE_MESSAGE` = `"予定時間 22:00-26:00"` など（任意）
2. 再デプロイを実行（Vercel Dashboard → Deployments → Redeploy）
3. デプロイ完了後、メンテナンスモードが有効化される
4. DBマイグレーション等の作業を実施

### メンテナンス終了

1. Vercel Dashboardで `MAINTENANCE_MODE` を削除または空に設定
2. 再デプロイを実行
3. デプロイ完了後、通常動作に復帰

## ディレクトリ構成（変更箇所）

```
webapp/
└── src/
    ├── middleware.ts                      # 新規作成
    └── lib/
        └── maintenance-html.ts            # 新規作成: HTMLテンプレート

admin/
└── src/
    ├── middleware.ts                      # 新規作成
    └── lib/
        └── maintenance-html.ts            # 新規作成: HTMLテンプレート
```

**HTMLテンプレートを別ファイルに分離する理由:**
- middleware.tsの可読性を保つ
- HTMLとスタイルの修正がしやすい
- webapp/adminで異なるデザインを適用できる

## 考慮事項

### メンテナンス画面のスタイリング

- インラインCSSのみを使用（Edge Runtimeでは外部CSS読み込み不可のため）
- webapp: エンドユーザー向けのため、ブランドに合わせたデザインを適用
- admin: 管理者向けのシンプルなデザイン
- レスポンシブ対応（モバイルでも適切に表示）

### APIクライアントへの影響

- 503ステータスコードを返すため、APIクライアントは適切にエラーハンドリングする必要がある
- 現時点で外部APIクライアントは存在しないため、影響なし

### 認証セッション

- メンテナンス中は認証処理もブロックされる
- メンテナンス終了後、ユーザーは再ログインが必要になる可能性がある（セッションタイムアウト次第）
