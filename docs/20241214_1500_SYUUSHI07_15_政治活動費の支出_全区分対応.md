# SYUUSHI07_15（第14号様式 その15）政治活動費の支出 全区分対応設計

## 概要

現在、政治活動費の支出（SYUUSHI07_15）はKUBUN1（組織活動費）のみ実装されている。本設計では、KUBUN2〜KUBUN9を追加し、全9区分の政治活動費をエクスポートできるようにする。

## 現状の実装

### 対応済み

| 区分 | 名称 | categoryKey | 実装状態 |
|------|------|-------------|----------|
| KUBUN1 | 組織活動費 | `organizational-activities` | ✅ 実装済み |

### 未対応（本設計で追加）

| 区分 | 名称 | categoryKey（新規追加） |
|------|------|-------------------------|
| KUBUN2 | 選挙関係費 | `election-expenses` |
| KUBUN3 | 機関紙誌の発行事業費 | `publication-expenses` |
| KUBUN4 | 宣伝事業費 | `advertising-expenses` |
| KUBUN5 | 政治資金パーティー開催事業費 | `fundraising-party-expenses` |
| KUBUN6 | その他の事業費 | `other-business-expenses` |
| KUBUN7 | 調査研究費 | `research-expenses` |
| KUBUN8 | 寄附・交付金 | `donations-grants-expenses` |
| KUBUN9 | その他の経費 | `other-expenses` |

## XML仕様（政治資金収支報告書XMLデータフォーマット仕様書より抜粋）

### SYUUSHI07_15（第14号様式 その15）

政治活動費の支出の明細を格納する。支出項目別（組織活動費・選挙関係費・機関紙誌の発行事業費など9種類）ごとに区分され、費目、目的、金額、年月日、支払先の氏名・住所などを記載する。

```xml
<SYUUSHI07_15>
  <KUBUN1>  <!-- 組織活動費 -->
    <SHEET>
      <HIMOKU>費目</HIMOKU>
      <KINGAKU_GK>合計金額</KINGAKU_GK>
      <SONOTA_GK>その他の支出</SONOTA_GK>
      <ROW>...</ROW>  <!-- 繰り返し -->
    </SHEET>
  </KUBUN1>
  <KUBUN2>  <!-- 選挙関係費 -->
    <SHEET>...</SHEET>
  </KUBUN2>
  <!-- KUBUN3〜KUBUN9 省略 -->
</SYUUSHI07_15>
```

#### 支出項目別区分（KUBUN*）

| 区分値 | 説明 |
|--------|------|
| KUBUN1 | 組織活動費 |
| KUBUN2 | 選挙関係費 |
| KUBUN3 | 機関紙誌の発行事業費 |
| KUBUN4 | 宣伝事業費 |
| KUBUN5 | 政治資金パーティー開催事業費 |
| KUBUN6 | その他の事業費 |
| KUBUN7 | 調査研究費 |
| KUBUN8 | 寄附・交付金 |
| KUBUN9 | その他の経費 |

#### SHEET直下の項目

| 項目名 | タグ名 | 設定条件 | 項目属性 | 項目長（最大） | フォーマット |
|--------|--------|----------|----------|----------------|--------------|
| 費目 | HIMOKU | 必須 | VARCHAR | 200 | 初期値NULL |
| 合計 | KINGAKU_GK | 必須 | NUMBER | 12 | 初期値ゼロ（NULL不可） |
| その他の支出 | SONOTA_GK | 必須 | NUMBER | 12 | 初期値NULL |

#### ROW要素（繰り返し）

| 項目名 | タグ名 | 設定条件 | 項目属性 | 項目長（最大） | フォーマット |
|--------|--------|----------|----------|----------------|--------------|
| 一連番号 | ICHIREN_NO | 任意 | NUMBER | 6 | NULL不可 |
| 目的 | MOKUTEKI | 任意 | VARCHAR | 200 | NULL不可 |
| 金額 | KINGAKU | 任意 | NUMBER | 12 | NULL不可 |
| 年月日 | DT | 任意 | DATE | - | NULL不可、和暦（ge/m/d） |
| 氏名 | NM | 任意 | VARCHAR | 120 | NULL不可 |
| 住所 | ADR | 任意 | VARCHAR | 120 | NULL不可 |
| 備考 | BIKOU | 任意 | VARCHAR | 100 | 初期値NULL |
| 領収書区分 | RYOUSYU | 任意 | NUMBER | 1 | 初期値NULL |

※ROW要素には訂正・補正された行の場合、タグの属性ALTが存在する

### ビジネスルール

- **閾値**: 5万円以上の支出は明細行（ROW）として個別記載
- **閾値未満**: 5万円未満の支出はSONOTA_GK（その他の支出）として合算
- **HIMOKU（費目）**: SHEETレベルの項目。各区分の費目名を設定（現在は空白で実装）

## 修正対象ファイル

### 1. ドメインモデル

**ファイル**: `admin/src/server/contexts/report/domain/models/expense-transaction.ts`

#### 追加するTransaction型

既存の`OrganizationExpenseTransaction`と同じ構造で、以下の型を追加：

```typescript
// SYUUSHI07_15 KUBUN2: 選挙関係費のトランザクション
export interface ElectionExpenseTransaction extends BaseExpenseTransaction {}

// SYUUSHI07_15 KUBUN3: 機関紙誌の発行事業費のトランザクション
export interface PublicationExpenseTransaction extends BaseExpenseTransaction {}

// SYUUSHI07_15 KUBUN4: 宣伝事業費のトランザクション
export interface AdvertisingExpenseTransaction extends BaseExpenseTransaction {}

// SYUUSHI07_15 KUBUN5: 政治資金パーティー開催事業費のトランザクション
export interface FundraisingPartyExpenseTransaction extends BaseExpenseTransaction {}

// SYUUSHI07_15 KUBUN6: その他の事業費のトランザクション
export interface OtherBusinessExpenseTransaction extends BaseExpenseTransaction {}

// SYUUSHI07_15 KUBUN7: 調査研究費のトランザクション
export interface ResearchExpenseTransaction extends BaseExpenseTransaction {}

// SYUUSHI07_15 KUBUN8: 寄附・交付金のトランザクション
export interface DonationGrantExpenseTransaction extends BaseExpenseTransaction {}

// SYUUSHI07_15 KUBUN9: その他の経費のトランザクション
export interface OtherPoliticalExpenseTransaction extends BaseExpenseTransaction {}
```

#### 追加するSection型

既存の`OrganizationExpenseSection`と同じ構造で、以下の型を追加：

```typescript
// SYUUSHI07_15 KUBUN2: 選挙関係費
export interface ElectionExpenseSection {
  himoku: string;
  totalAmount: number;
  underThresholdAmount: number;
  rows: PoliticalActivityExpenseRow[];
}

// 同様にKUBUN3〜KUBUN9のSection型を追加
```

#### 追加するドメインロジック

各Section型に対して`fromTransactions`と`shouldOutputSheet`メソッドを持つオブジェクトを追加。
閾値は全て **5万円（50,000円）** を使用（既存のOrganizationExpenseSectionと同じ）。

### 2. リポジトリインターフェース

**ファイル**: `admin/src/server/contexts/report/domain/repositories/report-transaction-repository.interface.ts`

以下のメソッドをインターフェースに追加：

```typescript
findElectionExpenseTransactions(filters: TransactionFilters): Promise<ElectionExpenseTransaction[]>;
findPublicationExpenseTransactions(filters: TransactionFilters): Promise<PublicationExpenseTransaction[]>;
findAdvertisingExpenseTransactions(filters: TransactionFilters): Promise<AdvertisingExpenseTransaction[]>;
findFundraisingPartyExpenseTransactions(filters: TransactionFilters): Promise<FundraisingPartyExpenseTransaction[]>;
findOtherBusinessExpenseTransactions(filters: TransactionFilters): Promise<OtherBusinessExpenseTransaction[]>;
findResearchExpenseTransactions(filters: TransactionFilters): Promise<ResearchExpenseTransaction[]>;
findDonationGrantExpenseTransactions(filters: TransactionFilters): Promise<DonationGrantExpenseTransaction[]>;
findOtherPoliticalExpenseTransactions(filters: TransactionFilters): Promise<OtherPoliticalExpenseTransaction[]>;
```

### 3. リポジトリ実装

**ファイル**: `admin/src/server/contexts/report/infrastructure/repositories/prisma-report-transaction.repository.ts`

#### カテゴリキー定数の追加

```typescript
const CATEGORY_KEYS = {
  // ... 既存のキー ...
  // SYUUSHI07_15用の追加
  ELECTION_EXPENSES: PL_CATEGORIES["選挙関係費"].key,
  PUBLICATION_EXPENSES: PL_CATEGORIES["機関紙誌の発行事業費"].key,
  ADVERTISING_EXPENSES: PL_CATEGORIES["宣伝事業費"].key,
  FUNDRAISING_PARTY_EXPENSES: PL_CATEGORIES["政治資金パーティー開催事業費"].key,
  OTHER_BUSINESS_EXPENSES: PL_CATEGORIES["その他の事業費"].key,
  RESEARCH_EXPENSES: PL_CATEGORIES["調査研究費"].key,
  DONATIONS_GRANTS_EXPENSES: PL_CATEGORIES["寄附・交付金"].key,
  OTHER_POLITICAL_EXPENSES: PL_CATEGORIES["その他の経費"].key,
} as const;
```

#### クエリメソッドの追加

既存の`findOrganizationExpenseTransactions`と同じパターンで8つのメソッドを追加。
各メソッドは対応するcategoryKeyでフィルタリング。

### 4. ReportDataモデル

**ファイル**: `admin/src/server/contexts/report/domain/models/report-data.ts`

#### ExpenseDataインターフェースの更新

```typescript
export interface ExpenseData {
  // SYUUSHI07_14: 経常経費
  utilityExpenses: UtilityExpenseSection;
  suppliesExpenses: SuppliesExpenseSection;
  officeExpenses: OfficeExpenseSection;

  // SYUUSHI07_15: 政治活動費（全9区分）
  organizationExpenses: OrganizationExpenseSection;     // KUBUN1: 組織活動費
  electionExpenses: ElectionExpenseSection;             // KUBUN2: 選挙関係費
  publicationExpenses: PublicationExpenseSection;       // KUBUN3: 機関紙誌の発行事業費
  advertisingExpenses: AdvertisingExpenseSection;       // KUBUN4: 宣伝事業費
  fundraisingPartyExpenses: FundraisingPartyExpenseSection; // KUBUN5: 政治資金パーティー開催事業費
  otherBusinessExpenses: OtherBusinessExpenseSection;   // KUBUN6: その他の事業費
  researchExpenses: ResearchExpenseSection;             // KUBUN7: 調査研究費
  donationGrantExpenses: DonationGrantExpenseSection;   // KUBUN8: 寄附・交付金
  otherPoliticalExpenses: OtherPoliticalExpenseSection; // KUBUN9: その他の経費
}
```

#### shouldOutputPoliticalActivitySheetメソッドの追加

```typescript
export const ExpenseData = {
  shouldOutputRegularExpenseSheet(data: ExpenseData): boolean { /* 既存 */ },

  /**
   * 政治活動費シート (SYUUSHI07_15) を出力すべきかどうかを判定
   * KUBUN1〜KUBUN9のいずれかにデータがあれば出力
   */
  shouldOutputPoliticalActivitySheet(data: ExpenseData): boolean {
    return (
      OrganizationExpenseSection.shouldOutputSheet(data.organizationExpenses) ||
      ElectionExpenseSection.shouldOutputSheet(data.electionExpenses) ||
      PublicationExpenseSection.shouldOutputSheet(data.publicationExpenses) ||
      AdvertisingExpenseSection.shouldOutputSheet(data.advertisingExpenses) ||
      FundraisingPartyExpenseSection.shouldOutputSheet(data.fundraisingPartyExpenses) ||
      OtherBusinessExpenseSection.shouldOutputSheet(data.otherBusinessExpenses) ||
      ResearchExpenseSection.shouldOutputSheet(data.researchExpenses) ||
      DonationGrantExpenseSection.shouldOutputSheet(data.donationGrantExpenses) ||
      OtherPoliticalExpenseSection.shouldOutputSheet(data.otherPoliticalExpenses)
    );
  },
};
```

### 5. Assembler

**ファイル**: `admin/src/server/contexts/report/application/services/expense-assembler.ts`

#### assembleメソッドの更新

```typescript
async assemble(input: ExpenseAssemblerInput): Promise<ExpenseData> {
  const filters = {
    politicalOrganizationId: input.politicalOrganizationId,
    financialYear: input.financialYear,
  };

  const [
    // SYUUSHI07_14
    utilityTransactions,
    suppliesTransactions,
    officeTransactions,
    // SYUUSHI07_15
    organizationTransactions,
    electionTransactions,
    publicationTransactions,
    advertisingTransactions,
    fundraisingPartyTransactions,
    otherBusinessTransactions,
    researchTransactions,
    donationGrantTransactions,
    otherPoliticalTransactions,
  ] = await Promise.all([
    // SYUUSHI07_14
    this.repository.findUtilityExpenseTransactions(filters),
    this.repository.findSuppliesExpenseTransactions(filters),
    this.repository.findOfficeExpenseTransactions(filters),
    // SYUUSHI07_15
    this.repository.findOrganizationExpenseTransactions(filters),
    this.repository.findElectionExpenseTransactions(filters),
    this.repository.findPublicationExpenseTransactions(filters),
    this.repository.findAdvertisingExpenseTransactions(filters),
    this.repository.findFundraisingPartyExpenseTransactions(filters),
    this.repository.findOtherBusinessExpenseTransactions(filters),
    this.repository.findResearchExpenseTransactions(filters),
    this.repository.findDonationGrantExpenseTransactions(filters),
    this.repository.findOtherPoliticalExpenseTransactions(filters),
  ]);

  return {
    // SYUUSHI07_14
    utilityExpenses: UtilityExpenseSection.fromTransactions(utilityTransactions),
    suppliesExpenses: SuppliesExpenseSection.fromTransactions(suppliesTransactions),
    officeExpenses: OfficeExpenseSection.fromTransactions(officeTransactions),
    // SYUUSHI07_15
    organizationExpenses: OrganizationExpenseSection.fromTransactions(organizationTransactions),
    electionExpenses: ElectionExpenseSection.fromTransactions(electionTransactions),
    publicationExpenses: PublicationExpenseSection.fromTransactions(publicationTransactions),
    advertisingExpenses: AdvertisingExpenseSection.fromTransactions(advertisingTransactions),
    fundraisingPartyExpenses: FundraisingPartyExpenseSection.fromTransactions(fundraisingPartyTransactions),
    otherBusinessExpenses: OtherBusinessExpenseSection.fromTransactions(otherBusinessTransactions),
    researchExpenses: ResearchExpenseSection.fromTransactions(researchTransactions),
    donationGrantExpenses: DonationGrantExpenseSection.fromTransactions(donationGrantTransactions),
    otherPoliticalExpenses: OtherPoliticalExpenseSection.fromTransactions(otherPoliticalTransactions),
  };
}
```

### 6. Serializer

**ファイル**: `admin/src/server/contexts/report/domain/services/expense-serializer.ts`

#### serializeOrganizationExpenseSectionの修正

関数名を`serializePoliticalActivityExpenseSection`に変更し、全9区分を受け取るように変更：

```typescript
/**
 * Serializes political activity expense sections into XML format for SYUUSHI07_15.
 * Handles all 9 KUBUN sections.
 */
export function serializePoliticalActivityExpenseSection(
  organizationSection: OrganizationExpenseSection,      // KUBUN1
  electionSection: ElectionExpenseSection,              // KUBUN2
  publicationSection: PublicationExpenseSection,        // KUBUN3
  advertisingSection: AdvertisingExpenseSection,        // KUBUN4
  fundraisingPartySection: FundraisingPartyExpenseSection, // KUBUN5
  otherBusinessSection: OtherBusinessExpenseSection,    // KUBUN6
  researchSection: ResearchExpenseSection,              // KUBUN7
  donationGrantSection: DonationGrantExpenseSection,    // KUBUN8
  otherPoliticalSection: OtherPoliticalExpenseSection,  // KUBUN9
): XMLBuilder {
  const frag = fragment();
  const root = frag.ele("SYUUSHI07_15");

  // KUBUN1: 組織活動費
  const kubun1 = root.ele("KUBUN1");
  serializePoliticalActivityKubun(kubun1, organizationSection);

  // KUBUN2: 選挙関係費
  const kubun2 = root.ele("KUBUN2");
  serializePoliticalActivityKubun(kubun2, electionSection);

  // KUBUN3: 機関紙誌の発行事業費
  const kubun3 = root.ele("KUBUN3");
  serializePoliticalActivityKubun(kubun3, publicationSection);

  // KUBUN4: 宣伝事業費
  const kubun4 = root.ele("KUBUN4");
  serializePoliticalActivityKubun(kubun4, advertisingSection);

  // KUBUN5: 政治資金パーティー開催事業費
  const kubun5 = root.ele("KUBUN5");
  serializePoliticalActivityKubun(kubun5, fundraisingPartySection);

  // KUBUN6: その他の事業費
  const kubun6 = root.ele("KUBUN6");
  serializePoliticalActivityKubun(kubun6, otherBusinessSection);

  // KUBUN7: 調査研究費
  const kubun7 = root.ele("KUBUN7");
  serializePoliticalActivityKubun(kubun7, researchSection);

  // KUBUN8: 寄附・交付金
  const kubun8 = root.ele("KUBUN8");
  serializePoliticalActivityKubun(kubun8, donationGrantSection);

  // KUBUN9: その他の経費
  const kubun9 = root.ele("KUBUN9");
  serializePoliticalActivityKubun(kubun9, otherPoliticalSection);

  return frag;
}
```

### 7. Report Serializer（メインエントリポイント）

**ファイル**: `admin/src/server/contexts/report/domain/services/report-serializer.ts`

#### serializeReportData関数の更新

```typescript
// SYUUSHI07_15: 第14号様式（その15）政治活動費の支出
if (ExpenseData.shouldOutputPoliticalActivitySheet(reportData.expenses)) {
  sections.push({
    formId: "SYUUSHI07_15",
    xml: serializePoliticalActivityExpenseSection(
      reportData.expenses.organizationExpenses,
      reportData.expenses.electionExpenses,
      reportData.expenses.publicationExpenses,
      reportData.expenses.advertisingExpenses,
      reportData.expenses.fundraisingPartyExpenses,
      reportData.expenses.otherBusinessExpenses,
      reportData.expenses.researchExpenses,
      reportData.expenses.donationGrantExpenses,
      reportData.expenses.otherPoliticalExpenses,
    ),
  });
}
```

## 実装順序

1. **ドメインモデル（expense-transaction.ts）**
   - 8つの新しいTransaction型を追加
   - 8つの新しいSection型を追加
   - 8つのドメインロジックオブジェクトを追加

2. **リポジトリインターフェース（report-transaction-repository.interface.ts）**
   - 8つの新しいメソッドシグネチャを追加
   - 新しい型のre-exportを追加

3. **リポジトリ実装（prisma-report-transaction.repository.ts）**
   - カテゴリキー定数を追加
   - 8つの新しいクエリメソッドを実装

4. **ReportDataモデル（report-data.ts）**
   - ExpenseDataインターフェースを更新
   - shouldOutputPoliticalActivitySheetメソッドを追加

5. **Assembler（expense-assembler.ts）**
   - assembleメソッドを更新して全区分を取得

6. **Serializer（expense-serializer.ts）**
   - serializeOrganizationExpenseSectionをserializePoliticalActivityExpenseSectionにリネーム・拡張

7. **Report Serializer（report-serializer.ts）**
   - serializeReportDataのSYUUSHI07_15部分を更新

## テスト

### 単体テスト

各レイヤーで以下をテスト：

1. **ドメインモデル**
   - 各Section型の`fromTransactions`が正しく集計すること
   - 5万円閾値が正しく適用されること
   - `shouldOutputSheet`が正しく判定すること

2. **Serializer**
   - 各KUBUNが正しいXML構造で出力されること
   - 空のセクションでも空のSHEETが出力されること

### 結合テスト

- 実際のDBデータを使って全体のXML出力が正しいことを確認

## 注意事項

1. **後方互換性**: 既存の`serializeOrganizationExpenseSection`を使っている箇所がある場合は、移行期間を設けるか、deprecatedとしてラッパーを残す

2. **パフォーマンス**: Promise.allで12個のクエリを並列実行するため、DBコネクションプールのサイズに注意

3. **TODO**: 現在counterpartName/counterpartAddressは仮の値。CounterPartテーブル実装後に実際の値を取得するよう修正が必要（これは本設計のスコープ外）
