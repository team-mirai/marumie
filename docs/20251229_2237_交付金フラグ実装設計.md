# 交付金フラグ実装設計

## 1. 概要

### 1.1 背景

現在の実装では「本部又は支部に対する交付金」（`branch-grants-expenses`）を独立したカテゴリとして扱っているが、これはXML仕様と異なる。

XML仕様では、シート14/15の各支出明細に `KOUFUKIN` フラグ（0 or 1）があり、**どの費目の支出でも**「これは本部/支部への交付金として支出した」とマークできる仕組みになっている。

### 1.2 現状の問題

1. **カテゴリの誤り**: `branch-grants-expenses` という独立カテゴリは本来存在しない
2. **シート16の内容**: 現状は専用カテゴリの明細だが、本来はシート14/15からの抽出ビュー
3. **シート13のKOUFU列**: 各費目ごとに `KOUFUKIN=1` の合計を集計する必要がある
4. **E184バリデーションエラー**: シート13とシート16の整合性が取れない

---

## 2. XML仕様の確認

### 2.1 シート14/15の明細構造

VBAコード（`data/reports/syushi_soft_vba.txt`）より、シート14/15の各明細行には以下のカラムがある：

| タグ名 | 説明 |
|--------|------|
| MOKUTEKI | 目的 |
| KINGAKU | 金額 |
| DT | 年月日 |
| NM | 氏名（支払先） |
| ADR | 住所 |
| BIKOU | 備考 |
| RYOUSYU | 領収書区分（0: あり, 1: 徴し難かったもの） |
| **KOUFUKIN** | **交付金フラグ（0: 通常, 1: 交付金に係る支出）** |

### 2.2 シート13のKOUFU列

シート13（支出項目別金額の内訳）には、各費目ごとに2つの列がある：
- `*_GK`: 金額合計
- `*_KOUFU`: 交付金に係る支出の合計

例：
- `JIMUSYO_GK`: 事務所費の合計
- `JIMUSYO_KOUFU`: 事務所費のうち交付金に係る支出の合計

### 2.3 シート16の構造

シート16（本部又は支部に対する交付金の支出）は、シート14/15で `KOUFUKIN=1` の明細を抽出したビュー。

| タグ名 | 説明 |
|--------|------|
| SHISYUTU_KMK | 支出項目（元の費目名：「事務所費」「組織活動費」など） |
| KINGAKU | 金額 |
| DT | 年月日 |
| HONSIBU_NM | 本支部名称 |
| JIMU_ADR | 主たる事務所の所在地 |
| BIKOU | 備考 |

### 2.4 バリデーションルール（E183/E184）

```
シート13.KEIHI_SKEI_KOUFU + シート13.KATUDOU_SKEI_KOUFU = シート16.KINGAKU_GK
```

---

## 3. 変更方針

### 3.1 カテゴリの廃止

`branch-grants-expenses`（本部又は支部に対する交付金）カテゴリを廃止する。

**影響範囲**:
- `shared/utils/category-mapping.ts`: カテゴリ定義の削除
- DB/シードデータ: 既存の `branch-grants-expenses` トランザクションのマイグレーション

### 3.2 データモデル拡張

各支出トランザクションに交付金フラグを追加する。

**Prismaスキーマ変更**:
```prisma
model Transaction {
  // ... 既存フィールド
  isGrantExpense Boolean @default(false) // 交付金に係る支出フラグ
}
```

### 3.3 UI変更

支出入力画面に「交付金に係る支出」チェックボックスを追加する。

対象となる費目（チェックボックスを表示する費目）:
- 経常経費: 人件費、光熱水費、備品・消耗品費、事務所費
- 政治活動費: 組織活動費、選挙関係費、機関紙誌の発行事業費、宣伝事業費、政治資金パーティー開催事業費、その他の事業費、調査研究費、寄附・交付金、その他の経費

### 3.4 シリアライズ処理変更

#### シート14/15
各明細に `KOUFUKIN` タグを出力する。

```xml
<ROW>
  <ICHIREN_NO>1</ICHIREN_NO>
  <MOKUTEKI>支部家賃補助</MOKUTEKI>
  <KINGAKU>50000</KINGAKU>
  <DT>r7/3/15</DT>
  <NM>○○支部</NM>
  <ADR>東京都...</ADR>
  <BIKOU/>
  <RYOUSYU>0</RYOUSYU>
  <KOUFUKIN>1</KOUFUKIN>  <!-- 交付金フラグ -->
</ROW>
```

#### シート16
`isGrantExpense=true` の明細を抽出して出力する。

- `SHISYUTU_KMK`: 元の費目名（「事務所費」「組織活動費」など）
- その他のフィールド: 元の明細からコピー

#### シート13
各費目の `*_KOUFU` 列に、該当費目で `isGrantExpense=true` の明細の合計を集計する。

```
JIMUSYO_KOUFU = 事務所費のうち isGrantExpense=true の合計
SOSIKI_KOUFU = 組織活動費のうち isGrantExpense=true の合計
...
KEIHI_SKEI_KOUFU = 経常経費のKOUFU列の合計
KATUDOU_SKEI_KOUFU = 政治活動費のKOUFU列の合計
```

---

## 4. データフロー

### 4.1 現状

```
取引データ
├── 光熱水費 ──────────────────→ シート14
├── 事務所費 ──────────────────→ シート14
├── 組織活動費 ────────────────→ シート15
├── ...
└── 本部又は支部に対する交付金 → シート16（独立カテゴリ）
```

### 4.2 変更後

```
取引データ（各明細に isGrantExpense フラグ）
├── 光熱水費: 電気代 [isGrantExpense=false] ────→ シート14
├── 事務所費: 家賃 [isGrantExpense=false] ──────→ シート14
├── 事務所費: 支部家賃補助 [isGrantExpense=true] → シート14 + シート16
├── 組織活動費: 会議費 [isGrantExpense=false] ──→ シート15
└── 組織活動費: 支部活動支援 [isGrantExpense=true] → シート15 + シート16
```

---

## 5. 変更対象ファイル

### 5.1 スキーマ・DB

| ファイル | 変更内容 |
|----------|----------|
| `prisma/schema.prisma` | Transaction に `isGrantExpense` フラグ追加 |
| `prisma/seed.ts` | シードデータの更新（`branch-grants-expenses` の移行） |

### 5.2 共通定義

| ファイル | 変更内容 |
|----------|----------|
| `shared/utils/category-mapping.ts` | `branch-grants-expenses` カテゴリの削除 |

### 5.3 ドメインモデル

| ファイル | 変更内容 |
|----------|----------|
| `admin/src/server/contexts/report/domain/models/expense-transaction.ts` | `isGrantExpense` フィールド追加、`BranchGrantExpenseSection` 削除 |
| `admin/src/server/contexts/report/domain/models/expense-summary.ts` | 各費目のKOUFU列を集計するロジック追加 |
| `admin/src/server/contexts/report/domain/models/report-data.ts` | `branchGrantExpenses` 削除、シート16出力ロジック変更 |

### 5.4 シリアライザ

| ファイル | 変更内容 |
|----------|----------|
| `admin/src/server/contexts/report/domain/services/expense-serializer.ts` | `KOUFUKIN` タグ出力追加 |
| `admin/src/server/contexts/report/domain/services/branch-grant-serializer.ts` | シート16の出力ロジックを抽出ベースに変更 |
| `admin/src/server/contexts/report/domain/services/expense-summary-serializer.ts` | 各費目の `*_KOUFU` 列出力追加 |
| `admin/src/server/contexts/report/domain/services/report-serializer.ts` | シート16の出力ロジック変更 |

### 5.5 リポジトリ・ユースケース

| ファイル | 変更内容 |
|----------|----------|
| 該当ファイル | `isGrantExpense` の取得・保存対応 |

### 5.6 UI

| ファイル | 変更内容 |
|----------|----------|
| 支出入力フォーム | 「交付金に係る支出」チェックボックス追加 |

---

## 6. マイグレーション

### 6.1 既存データの移行

`branch-grants-expenses` カテゴリの既存トランザクションは、以下のいずれかの方針で移行する：

**方針A: 寄附・交付金カテゴリに移行**
- カテゴリを `donations-grants-expenses`（寄附・交付金）に変更
- `isGrantExpense=true` を設定

**方針B: 組織活動費カテゴリに移行**
- カテゴリを `organizational-activities`（組織活動費）に変更
- `isGrantExpense=true` を設定

→ **方針Aを採用**: 「寄附・交付金」は本来そのような支出を含む費目であるため

### 6.2 マイグレーション手順

1. Prismaスキーマに `isGrantExpense` フィールドを追加
2. `npx prisma migrate dev` でマイグレーション実行
3. 既存の `branch-grants-expenses` トランザクションを `donations-grants-expenses` に更新し、`isGrantExpense=true` を設定
4. `category-mapping.ts` から `branch-grants-expenses` を削除

---

## 7. 整合性の検証

### 7.1 E184バリデーションの満足

変更後:
```
シート13.KEIHI_SKEI_KOUFU = 経常経費の isGrantExpense=true 合計
シート13.KATUDOU_SKEI_KOUFU = 政治活動費の isGrantExpense=true 合計
シート16.KINGAKU_GK = 全費目の isGrantExpense=true 合計

→ KEIHI_SKEI_KOUFU + KATUDOU_SKEI_KOUFU = KINGAKU_GK ✓
```

### 7.2 テストケース

- 交付金フラグがない場合: シート16は出力されない、KOUFU列はすべて0
- 経常経費に交付金フラグがある場合: `KEIHI_SKEI_KOUFU` に反映
- 政治活動費に交付金フラグがある場合: `KATUDOU_SKEI_KOUFU` に反映
- 複数費目に交付金フラグがある場合: 各費目のKOUFU列と小計が正しく計算される
