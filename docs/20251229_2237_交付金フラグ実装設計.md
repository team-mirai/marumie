# 交付金フラグ実装についての調査結果と方向性

## 1. 現状の問題

### 1.1 背景

現在の実装では「本部又は支部に対する交付金」（`branch-grants-expenses`）を独立したカテゴリとして扱っているが、これはXML仕様と異なる。

### 1.2 問題点

1. **カテゴリの誤り**: `branch-grants-expenses` という独立カテゴリは本来存在しない
2. **シート16の内容**: 現状は専用カテゴリの明細だが、本来はシート14/15からの抽出ビュー
3. **シート13のKOUFU列**: 各費目ごとに `KOUFUKIN=1` の合計を集計する必要がある
4. **E184バリデーションエラー**: シート13とシート16の整合性が取れない

---

## 2. XML仕様の確認

### 2.1 シート14/15の明細構造

VBAコード（`docs/reference_syushi-soft-vba-code.txt`）より、シート14/15の各明細行には以下のカラムがある：

| タグ名 | 説明 |
|--------|------|
| MOKUTEKI | 目的 |
| KINGAKU | 金額 |
| DT | 年月日 |
| NM | 氏名（支払先） |
| ADR | 住所 |
| BIKOU | 備考 |
| RYOUSYU | 領収書区分（0: あり, 1: 徴し難かったもの） |
| **KOUFUKIN** | **交付金フラグ（0: 通常, 1: 交付金に係る支出）** |

### 2.2 シート13のKOUFU列

シート13（支出項目別金額の内訳）には、各費目ごとに2つの列がある：
- `*_GK`: 金額合計
- `*_KOUFU`: 交付金に係る支出の合計

例：
- `JIMUSYO_GK`: 事務所費の合計
- `JIMUSYO_KOUFU`: 事務所費のうち交付金に係る支出の合計

### 2.3 シート16の構造

シート16（本部又は支部に対する交付金の支出）は、**シート14/15で `KOUFUKIN=1` の明細を抽出したビュー**。

| タグ名 | 説明 |
|--------|------|
| SHISYUTU_KMK | 支出項目（元の費目名：「事務所費」「組織活動費」など） |
| KINGAKU | 金額 |
| DT | 年月日 |
| HONSIBU_NM | 本支部名称 |
| JIMU_ADR | 主たる事務所の所在地 |
| BIKOU | 備考 |

シート14/15とシート16は**同じ明細の重複出力**であり、シート16は「交付金フラグがついた支出だけを抽出したビュー」という位置づけ。

### 2.4 バリデーションルール（E183/E184）

```
シート13.KEIHI_SKEI_KOUFU + シート13.KATUDOU_SKEI_KOUFU = シート16.KINGAKU_GK
```

---

## 3. 変更の方向性

### 3.1 カテゴリの廃止

`branch-grants-expenses`（本部又は支部に対する交付金）カテゴリを廃止する。

### 3.2 交付金フラグの導入

各支出トランザクションに「交付金に係る支出」フラグを追加する。どの費目の支出でも、このフラグをつけることで「本部/支部への交付金として支出した」とマークできるようにする。

### 3.3 データフロー

**現状:**
```
取引データ
├── 光熱水費 ──────────────────→ シート14
├── 事務所費 ──────────────────→ シート14
├── 組織活動費 ────────────────→ シート15
└── 本部又は支部に対する交付金 → シート16（独立カテゴリ）
```

**変更後:**
```
取引データ（各明細に交付金フラグ）
├── 光熱水費: 電気代 [交付金=false] ────→ シート14
├── 事務所費: 家賃 [交付金=false] ──────→ シート14
├── 事務所費: 支部家賃補助 [交付金=true] → シート14 + シート16
├── 組織活動費: 会議費 [交付金=false] ──→ シート15
└── 組織活動費: 支部活動支援 [交付金=true] → シート15 + シート16
```

### 3.4 既存データの移行方針

`branch-grants-expenses` カテゴリの既存トランザクションは「寄附・交付金」カテゴリに移行し、交付金フラグを設定する。
