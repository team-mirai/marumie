# 寄付者マスタページ設計

## 概要

`/donors` ページを新規実装する。取引先マスタページ（`/counterparts`）のデザインと既存モジュールを踏襲し、寄付者（Donor）の一覧表示・検索・CRUD操作を提供する。

## 既存リソースの確認

### 既に存在するもの

以下のモジュールは既に実装済みであり、本設計ではこれらを活用する。

| レイヤー | モジュール | 状況 |
|---------|-----------|------|
| Domain Model | `donor.ts` | 実装済み（DonorType, 検証ロジック含む） |
| Domain Repository Interface | `donor-repository.interface.ts` | 実装済み |
| Infrastructure Repository | `prisma-donor.repository.ts` | 実装済み |
| Application Usecase | `manage-donor-usecase.ts` | 実装済み（Get/Create/Update/Delete） |
| Presentation Action | `create-donor.ts` | 実装済み |
| Presentation Loader | `donors-loader.ts` | 部分実装（`loadAllDonorsData`のみ） |
| Page | `/donors/page.tsx` | プレースホルダーのみ |

### 新規実装が必要なもの

| レイヤー | モジュール | 説明 |
|---------|-----------|------|
| Presentation Loader | `donors-loader.ts` 拡張 | `loadDonorsData`（ページネーション付き一覧取得）を追加 |
| Presentation Action | `update-donor.ts` | 寄付者更新アクション |
| Presentation Action | `delete-donor.ts` | 寄付者削除アクション |
| Page | `/donors/page.tsx` | サーバーコンポーネント（一覧ページ） |
| Client Component | `DonorMasterClient.tsx` | 一覧・検索UI（クライアントコンポーネント） |
| Client Component | `DonorTable.tsx` | テーブル表示コンポーネント |
| Client Component | `DonorFormDialog.tsx` | 作成・編集ダイアログ |
| Client Component | `DonorFormContent.tsx` | フォーム内容 |
| Client Component | `DeleteDonorButton.tsx` | 削除ボタン |

## データモデル

### Donor（既存）

```
Donor {
  id: string
  donorType: "individual" | "corporation" | "political_organization"
  name: string (必須, max 120文字)
  address: string | null (max 120文字)
  occupation: string | null (個人の場合のみ必須, max 50文字)
  createdAt: Date
  updatedAt: Date
}
```

**検証ルール（既存）：**
- `name`: 必須、120文字以内
- `address`: 任意、120文字以内
- `occupation`: 個人（individual）の場合のみ必須、50文字以内。法人・政治団体の場合は入力不可
- 一意制約: `name` + `address` + `donorType` の組み合わせ

## 画面仕様

### ページレイアウト

取引先マスタページと同様のレイアウトを採用。

```
+------------------------------------------+
| 寄付者マスタ管理               [新規作成] |
+------------------------------------------+
| [検索フォーム] [検索] [クリア]            |
| [種別フィルタ: すべて/個人/法人/政治団体] |
+------------------------------------------+
| XXX件の寄付者 (検索: "xxx")               |
+------------------------------------------+
| 種別 | 名前      | 住所 | 職業 | 使用数 | 操作      |
|------|-----------|------|------|--------|-----------|
| 個人 | 山田太郎  | 東京 | 会社員 | 5件  | [編集][削除] |
| 法人 | 株式会社A | 大阪 | -    | 3件    | [編集][削除] |
+------------------------------------------+
| [前へ] 1 / 10 [次へ]                      |
+------------------------------------------+
```

### 機能一覧

1. **一覧表示**: ページネーション付きで寄付者一覧を表示（50件/ページ）
2. **検索**: 名前・住所・職業でのテキスト検索
3. **種別フィルタ**: 寄付者種別（個人/法人/政治団体）での絞り込み
4. **新規作成**: ダイアログで寄付者を作成
5. **編集**: ダイアログで寄付者情報を更新
6. **削除**: 確認ダイアログ付きで寄付者を削除

### 新規作成・編集ダイアログ

```
+----------------------------------+
| 新規寄付者作成 / 寄付者編集      |
+----------------------------------+
| 種別 *                           |
| [個人 ▼]                         |
|                                  |
| 名前 *                           |
| [________________]               |
|                                  |
| 住所                             |
| [________________]               |
|                                  |
| 職業 * (個人の場合のみ表示)      |
| [________________]               |
|                                  |
| ※同じ名前・住所・種別は登録不可  |
|                         [作成]  |
+----------------------------------+
```

**ポイント：**
- 種別が「個人」の場合のみ職業フィールドを表示
- 種別変更時に職業フィールドの表示/非表示を切り替え

## アーキテクチャ

### ディレクトリ構成

```
admin/src/
├── app/(auth)/donors/
│   └── page.tsx                    # サーバーコンポーネント
├── client/components/donors/
│   ├── DonorMasterClient.tsx       # クライアントコンポーネント（一覧UI）
│   ├── DonorTable.tsx              # テーブルコンポーネント
│   ├── DonorFormDialog.tsx         # 作成・編集ダイアログ
│   ├── DonorFormContent.tsx        # フォームコンテンツ
│   └── DeleteDonorButton.tsx       # 削除ボタン
└── server/contexts/report/
    └── presentation/
        ├── loaders/
        │   └── donors-loader.ts    # 既存ファイルを拡張
        └── actions/
            ├── create-donor.ts     # 既存（revalidatePath修正）
            ├── update-donor.ts     # 新規
            └── delete-donor.ts     # 新規
```

### 処理フロー

#### 一覧表示

```
page.tsx (Server Component)
  ↓ loadDonorsData()
donors-loader.ts
  ↓ GetDonorsUsecase
manage-donor-usecase.ts
  ↓ repository.findAllWithUsage() / count()
prisma-donor.repository.ts
```

#### 作成・更新・削除

```
DonorFormDialog.tsx / DeleteDonorButton.tsx (Client Component)
  ↓ createDonorAction() / updateDonorAction() / deleteDonorAction()
actions/*.ts (Server Action)
  ↓ Usecase.execute()
manage-donor-usecase.ts
  ↓ repository.*()
prisma-donor.repository.ts
```

## 実装詳細

### 1. Loader拡張 (`donors-loader.ts`)

既存の `loadAllDonorsData` に加えて、ページネーション対応の `loadDonorsData` を追加。

**入力：**
- `searchQuery`: 検索クエリ（任意）
- `donorType`: 種別フィルタ（任意）
- `page`: ページ番号（デフォルト: 1）
- `perPage`: 1ページあたりの件数（デフォルト: 50）

**出力：**
- `donors`: DonorWithUsage[]
- `total`: 総件数
- `page`: 現在のページ
- `perPage`: 1ページあたりの件数

### 2. Action新規作成

#### `update-donor.ts`

`update-counterpart.ts` と同様のパターンで実装。
- 入力: `id: string`, `input: UpdateDonorInput`
- 成功時: `revalidatePath("/donors")` を実行
- 出力: `{ success: boolean; errors?: string[] }`

#### `delete-donor.ts`

`delete-counterpart.ts` と同様のパターンで実装。
- 入力: `id: string`
- 成功時: `revalidatePath("/donors")` を実行
- 出力: `{ success: boolean; errors?: string[] }`

### 3. 既存Action修正

#### `create-donor.ts`

現在 `revalidatePath("/assign/donors")` となっているが、`revalidatePath("/donors")` を追加。

### 4. ページコンポーネント (`/donors/page.tsx`)

`/counterparts/page.tsx` と同様の構造で実装。

**searchParams：**
- `q`: 検索クエリ
- `type`: 種別フィルタ（individual/corporation/political_organization）
- `page`: ページ番号

### 5. クライアントコンポーネント

#### `DonorMasterClient.tsx`

`CounterpartMasterClient.tsx` を参考に実装。

**追加機能：**
- 種別フィルタ用のセレクトボックス
- フィルタ変更時の URL 更新

#### `DonorTable.tsx`

`CounterpartTable.tsx` を参考に実装。

**カラム：**
- 種別（個人/法人/政治団体）
- 名前
- 住所
- 職業（個人の場合のみ表示、それ以外は「-」）
- 使用数
- 操作（編集・削除ボタン）

#### `DonorFormDialog.tsx` / `DonorFormContent.tsx`

`CounterpartFormDialog.tsx` / `CounterpartFormContent.tsx` を参考に実装。

**相違点：**
- 郵便番号フィールドなし
- 種別セレクトボックスあり
- 職業フィールドあり（条件付き表示）
- AI検索機能なし（取引先のような住所検索は不要）

#### `DeleteDonorButton.tsx`

`DeleteCounterpartButton.tsx` と同様のパターンで実装。

## キャッシュ戦略

- Loader: `unstable_cache` を使用、60秒間キャッシュ
- Action: 処理成功後に `revalidatePath("/donors")` を実行

## 取引先マスタとの差異

| 項目 | 取引先（Counterpart） | 寄付者（Donor） |
|------|----------------------|----------------|
| 種別 | なし | 個人/法人/政治団体 |
| 郵便番号 | あり | なし |
| 職業 | なし | あり（個人のみ） |
| AI検索 | あり | なし |
| 詳細ページ | あり（`/counterparts/[id]`） | なし（必要に応じて後から追加） |

## スコープ外

- 詳細ページ（`/donors/[id]`）: 取引先のような関連トランザクション一覧表示は本設計のスコープ外
