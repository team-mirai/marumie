# 寄附の名寄せ・小計行機能 要件定義

## 概要

政治資金収支報告書XMLにおける寄附データ（その7・その8・その11・その12）について、同一寄附者からの複数回寄附を名寄せし、小計行を設けてXML出力する機能の要件を定義する。

---

## 背景

### 法令・手引上の記載ルール

政治資金報告書の手引き（docs/reference/tebiki/each-transactions.md）より：

> - （注1）同一者からの年間5万円超（5万1円以上）の寄附は個別に記載する
> - （注2）同一者から複数回寄附を受けた場合は、寄附をした者（団体等）ごとに「名寄せ」して年月日順に記載し、その者の最後に「計」を入れる

### 対象様式

| 様式 | 内容 | 小計行が必要なケース |
|------|------|----------------------|
| その7 | 寄附の内訳（個人・法人・政治団体） | 同一寄附者から複数回の寄附がある場合 |
| その8 | 寄附のあっせんによるものの内訳 | 同一あっせん者から複数回の提供がある場合 |
| その11 | 政治資金パーティー対価の支払者 | 同一支払者から複数回の支払がある場合 |
| その12 | 政治資金パーティー対価のあっせん者 | 同一あっせん者から複数回の提供がある場合 |

---

## 要件

### R1: 名寄せ（グルーピング）

同一の寄附者（取引先）からの寄附は、年間合計が5万円超（5万1円以上）の場合、以下のルールでグルーピングする：

1. **同一者の判定基準**: 寄附者ID（donorId / counterpartId）が同一であること
2. **並び順**: 同一者内の明細は年月日順（昇順）で並べる
3. **グループ間の並び順**: 通し番号順 → 日付順

### R2: 小計行の生成条件

以下の条件を**すべて**満たす場合に小計行を生成する：

1. 同一寄附者からの寄附が**2件以上**存在する
2. 当該寄附者の年間合計金額が**5万円超**（5万1円以上）である

### R3: 小計行のXML出力形式

サンプルXML（data/reports/donation-aggregation-sample.xml）に基づき、小計行は以下の形式で出力する：

```xml
<ROW>
  <ICHIREN_NO>3</ICHIREN_NO>           <!-- 一連番号（明細と通しで連番） -->
  <KIFUSYA_NM>（小計）</KIFUSYA_NM>     <!-- 寄附者氏名欄に「（小計）」と表示 -->
  <KINGAKU>60000</KINGAKU>              <!-- 同一者の合計金額 -->
  <DT></DT>                             <!-- 空 -->
  <ADR></ADR>                           <!-- 空 -->
  <SYOKUGYO></SYOKUGYO>                 <!-- 空 -->
  <BIKOU></BIKOU>                       <!-- 空 -->
  <SEQ_NO>1</SEQ_NO>                    <!-- 通し番号（同一者で同じ値） -->
  <ZEIGAKUKOUJYO>0</ZEIGAKUKOUJYO>      <!-- 0（小計行では不要） -->
  <ROWKBN>1</ROWKBN>                    <!-- 行区分: 1=小計 -->
</ROW>
```

### R4: 行区分（ROWKBN）

| 値 | 意味 | 用途 |
|----|------|------|
| 0 | 明細行 | 個別の寄附トランザクション |
| 1 | 小計行 | 同一寄附者の合計を示す行 |

### R5: 通し番号（SEQ_NO）

1. 同一寄附者に属する明細行および小計行は、すべて同じ通し番号を持つ
2. 通し番号は1から始まる連番とする
3. 通し番号は寄附者グループごとに一意である

### R6: 一連番号（ICHIREN_NO）

1. 明細行・小計行を問わず、出力順に1から始まる連番を振る
2. 小計行も一連番号のカウント対象に含める

### R7: 合計金額（KINGAKU_GK）の算出

シート全体の合計金額は、**小計行を除いた明細行のみ**を合計する。

VBAコード（reference_syushi-soft-vba-code.txt）より：
```
=SUMIF(ROWKBN列,"<>TRUE",KINGAKU列)
```

これは、ROWKBN=1（小計行）を除外して合計することを意味する。

---

## XML出力例

### 入力データ

| 寄附者 | 金額 | 日付 |
|--------|------|------|
| サンプル太郎 | 20,000円 | R7/1/1 |
| サンプル太郎 | 40,000円 | R7/1/2 |
| テスト花子 | 70,000円 | R7/1/1 |

### 期待するXML出力

```xml
<SYUUSHI07_07>
  <KUBUN1>
    <SHEET>
      <KINGAKU_GK>130000</KINGAKU_GK>  <!-- 20000+40000+70000 = 130000 -->
      <SONOTA_GK></SONOTA_GK>

      <!-- サンプル太郎: 1回目 -->
      <ROW>
        <ICHIREN_NO>1</ICHIREN_NO>
        <KIFUSYA_NM>サンプル太郎</KIFUSYA_NM>
        <KINGAKU>20000</KINGAKU>
        <DT>R7/1/1</DT>
        <ADR>東京都渋谷区サンプル町1-1-1</ADR>
        <SYOKUGYO>会社員</SYOKUGYO>
        <BIKOU></BIKOU>
        <SEQ_NO>1</SEQ_NO>
        <ZEIGAKUKOUJYO>0</ZEIGAKUKOUJYO>
        <ROWKBN>0</ROWKBN>
      </ROW>

      <!-- サンプル太郎: 2回目 -->
      <ROW>
        <ICHIREN_NO>2</ICHIREN_NO>
        <KIFUSYA_NM>サンプル太郎</KIFUSYA_NM>
        <KINGAKU>40000</KINGAKU>
        <DT>R7/1/2</DT>
        <ADR>東京都渋谷区サンプル町1-1-1</ADR>
        <SYOKUGYO>会社員</SYOKUGYO>
        <BIKOU></BIKOU>
        <SEQ_NO>1</SEQ_NO>
        <ZEIGAKUKOUJYO>0</ZEIGAKUKOUJYO>
        <ROWKBN>0</ROWKBN>
      </ROW>

      <!-- サンプル太郎: 小計行 -->
      <ROW>
        <ICHIREN_NO>3</ICHIREN_NO>
        <KIFUSYA_NM>（小計）</KIFUSYA_NM>
        <KINGAKU>60000</KINGAKU>
        <DT></DT>
        <ADR></ADR>
        <SYOKUGYO></SYOKUGYO>
        <BIKOU></BIKOU>
        <SEQ_NO>1</SEQ_NO>
        <ZEIGAKUKOUJYO>0</ZEIGAKUKOUJYO>
        <ROWKBN>1</ROWKBN>
      </ROW>

      <!-- テスト花子: 1件のみなので小計行なし -->
      <ROW>
        <ICHIREN_NO>4</ICHIREN_NO>
        <KIFUSYA_NM>テスト花子</KIFUSYA_NM>
        <KINGAKU>70000</KINGAKU>
        <DT>R7/1/1</DT>
        <ADR>東京都渋谷区サンプル町2-2-2</ADR>
        <SYOKUGYO>会社員</SYOKUGYO>
        <BIKOU></BIKOU>
        <SEQ_NO>2</SEQ_NO>
        <ZEIGAKUKOUJYO>0</ZEIGAKUKOUJYO>
        <ROWKBN>0</ROWKBN>
      </ROW>

    </SHEET>
  </KUBUN1>
  <!-- KUBUN2, KUBUN3 省略 -->
</SYUUSHI07_07>
```

---

## 様式ごとの差異

### その7（寄附の内訳）

| 項目 | タグ名 | 小計行での値 |
|------|--------|--------------|
| 寄附者氏名 | KIFUSYA_NM | 「（小計）」 |

### その8（寄附のあっせん）

| 項目 | タグ名 | 小計行での値 |
|------|--------|--------------|
| あっせん者氏名 | NM | 「（小計）」 |
| 期間 | KIKAN | 空 |

### その11（パーティー対価支払者）

| 項目 | タグ名 | 小計行での値 |
|------|--------|--------------|
| 支払者氏名 | NM | 「（小計）」 |

### その12（パーティー対価あっせん者）

| 項目 | タグ名 | 小計行での値 |
|------|--------|--------------|
| あっせん者氏名 | NM | 「（小計）」 |
| 期間 | KIKAN | 空 |

---

## エラーチェック要件（参考）

収支報告書作成ソフト（VBA）では以下のチェックが行われる：

1. **小計行重複チェック**: 小計行が連続していないか
2. **小計行存在チェック**: 同じ通し番号が複数存在するのに小計行がない場合エラー
3. **通し番号整合性チェック**: 小計対象の明細が点在していないか

これらのエラーチェックは、XML出力時に自動的に正しい形式で出力することで回避する。

---

## 参考資料

- [docs/reference/report-format.md](../reference/report-format.md) - XMLフォーマット仕様
- [docs/reference/tebiki/each-transactions.md](../reference/tebiki/each-transactions.md) - 手引書の記載ルール
- [data/reports/donation-aggregation-sample.xml](../../data/reports/donation-aggregation-sample.xml) - サンプルXML
- docs/reference/reference_syushi-soft-vba-code.txt - VBAコード参照（名寄せ・小計処理）
