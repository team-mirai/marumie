# auth コンテキスト外部インターフェース設計

## 概要

auth コンテキストの外部モジュールからの参照方法を整理し、適切なインターフェースを設計する。
内部実装の DDD 化は行わず、外部公開 API のみを整理する。

## 現状の問題点

### 1. ページやルートハンドラから直接 repository を参照している

```typescript
// admin/src/app/(auth)/users/page.tsx
import { PrismaUserRepository } from "@/server/contexts/shared/infrastructure/repositories/prisma-user.repository";
const userRepository = new PrismaUserRepository(prisma);
const users = await userRepository.findAll();
```

**問題**:
- プレゼンテーション層からインフラ層を直接参照
- repository のインスタンス生成を各所で行っている
- auth コンテキストが提供すべき機能が shared に配置されている

### 2. Supabase クライアントを外部に公開している

```typescript
// 外部から直接使用されている
import { createClient } from "@/server/contexts/auth/application/client";
const supabase = await createClient();
const { data: { user } } = await supabase.auth.getUser();
```

**問題**:
- 認証の実装詳細（Supabase）が外部に漏れている
- 認証処理が各所に分散

### 3. 機能の重複

- `getCurrentUser()` と `getCurrentUserRole()` が roles.ts にあるが、他の箇所でも直接 supabase クライアントを使って同様の処理をしている

## 現状の外部参照一覧

### auth コンテキストからの import

| ファイル | import 元 | 使用内容 |
|---------|----------|---------|
| `app/(auth)/users/page.tsx` | `auth/application/roles` | `requireRole` |
| `app/(auth)/layout.tsx` | `auth/application/login` | `logout` |
| `app/(auth)/layout.tsx` | `auth/application/roles` | `getCurrentUserRole` |
| `app/(auth)/user-info/page.tsx` | `auth/application/client` | `createClient` |
| `app/api/users/route.ts` | `auth/application/roles` | `requireRole` |
| `app/api/users/invite/route.ts` | `auth/application/roles` | `requireRole` |
| `app/api/users/invite/route.ts` | `auth/application/admin` | `createAdminClient` |
| `app/api/users/role/route.ts` | `auth/application/roles` | `requireRole` |
| `app/api/auth/setup-password/route.ts` | `auth/application/client` | `createClient` |
| `app/(public)/auth/callback/route.ts` | `auth/application/client` | `createClient` |
| `app/(public)/login/page.tsx` | `auth/application/login` | `loginWithPassword` |
| `app/(public)/login/processor.tsx` | `auth/application/login` | `completeInviteSession` |
| `app/(public)/auth/setup/page.tsx` | `auth/application/client` | `createClient` |
| `app/api/logout/route.ts` | `auth/application/client` | `createClient` |

### shared から直接 UserRepository を使用している箇所

| ファイル | 使用内容 |
|---------|---------|
| `app/(auth)/users/page.tsx` | `findAll()` |
| `app/api/users/route.ts` | `findAll()` |
| `app/api/users/role/route.ts` | `updateRole()` |
| `app/api/users/create-from-invite/route.ts` | `findByAuthId()`, `create()` |
| `app/(public)/auth/callback/route.ts` | `findByAuthId()`, `create()` |

## 設計方針

### 原則

1. **auth コンテキストは単一の公開 API（index.ts）のみを外部公開する**
2. **Supabase などの実装詳細は外部に漏らさない**
3. **ユーザー管理機能は auth コンテキストの責務とする**

### ディレクトリ構造（変更後）

```
admin/src/server/contexts/auth/
├── index.ts                           # 外部公開 API（re-export + 型定義）
└── application/
    ├── client.ts                      # Supabase クライアント生成（内部用）
    ├── admin.ts                       # Supabase Admin クライアント生成（内部用）
    ├── roles.ts                       # getCurrentUser, getCurrentUserRole, requireRole
    ├── login.ts                       # loginWithPassword, logout, completeInviteSession
    └── users.ts                       # 新規：ユーザー管理関数
```

**ポイント**:
- `index.ts` で既存関数を re-export + 不足分を追加
- 無駄なラッパー層は作らない
- `client.ts`, `admin.ts` は外部公開しない（実装詳細）

## 公開インターフェース設計

### `admin/src/server/contexts/auth/index.ts`

```typescript
import "server-only";

// ============================================================
// 型定義
// ============================================================
export type { UserRole } from "@prisma/client";

export interface AuthUser {
  id: string;
  authId: string;
  email: string;
  role: UserRole;
  createdAt: Date;
  updatedAt: Date;
}

// ============================================================
// 認証・認可（既存を re-export）
// ============================================================
export {
  getCurrentUser,
  getCurrentUserRole,
  requireRole,
} from "@/server/contexts/auth/application/roles";

export {
  loginWithPassword,
  logout,
  completeInviteSession,
} from "@/server/contexts/auth/application/login";

// ============================================================
// ユーザー管理（新規追加）
// ============================================================
export {
  getAllUsers,
  getUserByAuthId,
  createUser,
  updateUserRole,
  inviteUser,
  setupPassword,
} from "@/server/contexts/auth/application/users";
```

### 新規ファイル: `application/users.ts`

ユーザー管理機能を集約。現在は外部から直接 repository を触っている処理をここに移動。

```typescript
"use server";

import { revalidatePath } from "next/cache";
import type { UserRole } from "@prisma/client";
import { prisma } from "@/server/contexts/shared/infrastructure/prisma";
import { PrismaUserRepository } from "@/server/contexts/shared/infrastructure/repositories/prisma-user.repository";
import { createClient } from "@/server/contexts/auth/application/client";
import { createAdminClient } from "@/server/contexts/auth/application/admin";

const userRepository = new PrismaUserRepository(prisma);

/**
 * 全ユーザー一覧を取得
 */
export async function getAllUsers() {
  return userRepository.findAll();
}

/**
 * authId でユーザーを取得
 */
export async function getUserByAuthId(authId: string) {
  return userRepository.findByAuthId(authId);
}

/**
 * ユーザーを作成
 */
export async function createUser(data: {
  authId: string;
  email: string;
  role?: UserRole;
}) {
  return userRepository.create(data);
}

/**
 * ユーザーのロールを更新
 */
export async function updateUserRole(userId: string, role: UserRole) {
  const user = await prisma.user.findUnique({ where: { id: userId } });
  if (!user) {
    return { ok: false, error: "User not found" };
  }

  await userRepository.updateRole(user.authId, role);
  revalidatePath("/users");
  return { ok: true };
}

/**
 * ユーザーを招待
 */
export async function inviteUser(email: string) {
  if (!email || typeof email !== "string") {
    return { ok: false, error: "Email is required" };
  }

  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    return { ok: false, error: "Invalid email format" };
  }

  const supabase = createAdminClient();
  const { error } = await supabase.auth.admin.inviteUserByEmail(email, {
    redirectTo: `${process.env.SITE_URL || "http://localhost:3001"}/auth/callback`,
  });

  if (error) {
    return { ok: false, error: error.message };
  }

  revalidatePath("/users");
  return { ok: true };
}

/**
 * パスワードを設定
 */
export async function setupPassword(password: string) {
  if (!password || password.length < 6) {
    return { ok: false, error: "Password must be at least 6 characters" };
  }

  const supabase = await createClient();
  const { error } = await supabase.auth.updateUser({
    password,
    data: { password_set: true },
  });

  if (error) {
    return { ok: false, error: error.message };
  }

  return { ok: true };
}
```

## リファクタリング計画

### Phase 1: 新規ファイルの作成

1. `admin/src/server/contexts/auth/application/users.ts` を作成
2. `admin/src/server/contexts/auth/index.ts` を作成

### Phase 2: 外部参照の修正

以下のファイルを修正し、`@/server/contexts/auth` 経由に変更:

| ファイル | Before | After |
|---------|--------|-------|
| `app/(auth)/users/page.tsx` | `requireRole` + `PrismaUserRepository` | `requireRole` + `getAllUsers` |
| `app/(auth)/layout.tsx` | `logout` + `getCurrentUserRole` | 変更なし（import 元のみ変更） |
| `app/(auth)/user-info/page.tsx` | `createClient` | `getCurrentUser` |
| `app/api/users/route.ts` | `requireRole` + `PrismaUserRepository` | `requireRole` + `getAllUsers` |
| `app/api/users/invite/route.ts` | `requireRole` + `createAdminClient` | `requireRole` + `inviteUser` |
| `app/api/users/role/route.ts` | `requireRole` + `PrismaUserRepository` | `requireRole` + `updateUserRole` |
| `app/api/auth/setup-password/route.ts` | `createClient` | `setupPassword` |
| `app/(public)/auth/callback/route.ts` | `createClient` + `PrismaUserRepository` | `getUserByAuthId` + `createUser` |
| `app/(public)/login/page.tsx` | `loginWithPassword` | 変更なし（import 元のみ変更） |
| `app/(public)/login/processor.tsx` | `completeInviteSession` | 変更なし（import 元のみ変更） |
| `app/(public)/auth/setup/page.tsx` | `createClient` | `getCurrentUser` |
| `app/api/logout/route.ts` | `createClient` | `logout` |
| `app/api/users/create-from-invite/route.ts` | `PrismaUserRepository` | `getUserByAuthId` + `createUser` |

### Phase 3（任意）: shared からの User 関連コードの整理

- auth コンテキストが User を管理するようになったため、`shared` の `PrismaUserRepository` は auth 内部のみで使用
- 将来的に auth コンテキスト内に移動することも検討

## 変更後の import 例

### ユーザー一覧の取得

```typescript
// Before
import { requireRole } from "@/server/contexts/auth/application/roles";
import { prisma } from "@/server/contexts/shared/infrastructure/prisma";
import { PrismaUserRepository } from "@/server/contexts/shared/infrastructure/repositories/prisma-user.repository";
const userRepository = new PrismaUserRepository(prisma);
const users = await userRepository.findAll();

// After
import { requireRole, getAllUsers } from "@/server/contexts/auth";
const users = await getAllUsers();
```

### Server Action での利用

```typescript
// Before
import { logout } from "@/server/contexts/auth/application/login";

// After
import { logout } from "@/server/contexts/auth";
```

### 認証チェック

```typescript
// Before
import { createClient } from "@/server/contexts/auth/application/client";
const supabase = await createClient();
const { data: { user } } = await supabase.auth.getUser();

// After
import { getCurrentUser } from "@/server/contexts/auth";
const user = await getCurrentUser();
if (!user) redirect("/login");
```

### ユーザー招待（API ルート）

```typescript
// Before
import { requireRole } from "@/server/contexts/auth/application/roles";
import { createAdminClient } from "@/server/contexts/auth/application/admin";
const supabase = createAdminClient();
await supabase.auth.admin.inviteUserByEmail(email, { ... });

// After
import { requireRole, inviteUser } from "@/server/contexts/auth";
const result = await inviteUser(email);
```

## 期待される効果

1. **カプセル化**: auth の実装詳細（Supabase, Prisma）が外部から隠蔽される
2. **単一エントリーポイント**: `@/server/contexts/auth` からのみ import すれば良い
3. **テスト容易性**: 公開 API をモックしやすくなる
4. **保守性向上**: 内部実装の変更が外部に影響しない

## 注意事項

- Server Action として公開する関数（`loginWithPassword`, `logout`）は引き続き "use server" ディレクティブが必要
- `layout.tsx` での認証チェック部分（直接 Supabase を使っている箇所）も `getCurrentUser` に置き換え可能
