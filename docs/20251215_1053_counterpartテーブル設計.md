# Counterpart テーブル設計

## 概要

政治資金報告書の収支取引において、取引相手（支払先・受取先）の情報を管理するためのテーブル設計。

## 背景

政治資金収支報告書では、経常経費(SYUUSHI07_14)や政治活動費(SYUUSHI07_15)などの支出明細において、支払先の氏名(NM)と住所(ADR)の記載が必要となる。これらの情報は複数の取引で再利用される可能性があるため、マスタテーブルとして管理し、正規化する。

なお、寄附については別途 `donor` という専用の形式で管理するため、本設計のスコープ外とする。

## 要件

1. 取引相手の名称と住所を保持
2. 同一の取引相手情報を複数の取引で参照可能
3. 名称と住所の組み合わせで一意性を保証（重複登録防止）
4. 既存データの軽量な存在チェックが可能
5. 特定の取引タイプ・カテゴリでのみ利用可能（PostgreSQL triggerで制御）
6. 寄附関連の取引では使用不可

## テーブル構造

### counterparts (マスタテーブル)

取引相手の基本情報を保持するマスタテーブル。

| カラム名 | 型 | 制約 | 説明 |
|---------|---|------|------|
| id | BigInt | PRIMARY KEY, AUTO INCREMENT | 一意識別子 |
| name | VARCHAR(120) | NOT NULL | 取引相手の氏名・名称 (XMLのNMに対応) |
| address | VARCHAR(120) | NOT NULL | 取引相手の住所 (XMLのADRに対応) |
| created_at | TIMESTAMP | NOT NULL, DEFAULT now() | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT now() | 更新日時 |

**制約:**
- UNIQUE (name, address): 同一の名称・住所の組み合わせは1件のみ登録可能

### transaction_counterparts (中間テーブル)

取引とcounterpartの関連を保持する中間テーブル。

| カラム名 | 型 | 制約 | 説明 |
|---------|---|------|------|
| id | BigInt | PRIMARY KEY, AUTO INCREMENT | 一意識別子 |
| transaction_id | BigInt | NOT NULL, FOREIGN KEY -> transactions(id) ON DELETE CASCADE | 取引ID |
| counterpart_id | BigInt | NOT NULL, FOREIGN KEY -> counterparts(id) ON DELETE CASCADE | 取引相手ID |
| created_at | TIMESTAMP | NOT NULL, DEFAULT now() | 作成日時 |

**制約:**
- UNIQUE (transaction_id, counterpart_id): 同一取引に同じcounterpartを重複登録不可
- UNIQUE (transaction_id): 1取引に1つのcounterpartのみ紐付け可能

**インデックス:**
- `idx_transaction_counterparts_transaction` on (transaction_id): 取引からcounterpart検索
- `idx_transaction_counterparts_counterpart` on (counterpart_id): counterpartから取引検索

## 利用可能な取引タイプとカテゴリ

counterpartが設定可能な取引は以下に限定する（PostgreSQL triggerで制御）:

### 支出取引 (expense)

以下の `category_key` を持つ支出取引でのみ利用可能:

#### 経常経費 (SYUUSHI07_14に対応)
- `expense_utility_costs` (光熱水費)
- `expense_office_supplies` (備品・消耗品費)
- `expense_office_expenses` (事務所費)

#### 政治活動費 (SYUUSHI07_15に対応)
- `expense_organizational_activity` (組織活動費)
- `expense_election_related` (選挙関係費)
- `expense_publication` (機関紙誌の発行事業費)
- `expense_publicity` (宣伝事業費)
- `expense_party_event` (政治資金パーティー開催事業費)
- `expense_other_projects` (その他の事業費)
- `expense_research` (調査研究費)
- `expense_donation_grant` (寄附・交付金)
- `expense_other` (その他の経費)

### 収入取引 (income)

以下の `category_key` を持つ収入取引でのみ利用可能:

- `income_business` (事業による収入 - SYUUSHI07_03)
- `income_loan` (借入金 - SYUUSHI07_04)
- `income_grant_from_hq` (本部または支部から供与された交付金 - SYUUSHI07_05)
- `income_other` (その他の収入 - SYUUSHI07_06)

### 除外する取引

以下の取引には counterpart を設定**できない**:

1. 寄附関連 (donorで管理)
   - `income_donation_*`
   - `income_party_*`
2. 報告書に取引相手情報が不要なもの
   - 前年繰越、翌年繰越など

## 重複チェック

name と address の組み合わせに複合UNIQUE制約を設定することで、重複登録を防止し、高速な検索を実現する。

## データ整合性制御 (PostgreSQL Trigger)

### trigger: validate_transaction_counterpart_insert

`transaction_counterparts` テーブルへのINSERT/UPDATE時に発火し、以下をチェック:

1. 対象取引の `transaction_type` が `income` または `expense` であること
2. 対象取引の `category_key` が上記の許可リストに含まれること
3. 条件を満たさない場合は RAISE EXCEPTION でエラーを返す

```sql
CREATE OR REPLACE FUNCTION validate_transaction_counterpart()
RETURNS TRIGGER AS $$
DECLARE
  v_transaction_type VARCHAR(255);
  v_category_key VARCHAR(255);
  v_allowed_income_categories TEXT[] := ARRAY[
    'income_business',
    'income_loan',
    'income_grant_from_hq',
    'income_other'
  ];
  v_allowed_expense_categories TEXT[] := ARRAY[
    'expense_utility_costs',
    'expense_office_supplies',
    'expense_office_expenses',
    'expense_organizational_activity',
    'expense_election_related',
    'expense_publication',
    'expense_publicity',
    'expense_party_event',
    'expense_other_projects',
    'expense_research',
    'expense_donation_grant',
    'expense_other'
  ];
BEGIN
  -- 取引情報を取得
  SELECT transaction_type, category_key
  INTO v_transaction_type, v_category_key
  FROM transactions
  WHERE id = NEW.transaction_id;

  -- 収入取引のチェック
  IF v_transaction_type = 'income' THEN
    IF NOT (v_category_key = ANY(v_allowed_income_categories)) THEN
      RAISE EXCEPTION 'Counterpart cannot be assigned to this income transaction category: %', v_category_key;
    END IF;
  -- 支出取引のチェック
  ELSIF v_transaction_type = 'expense' THEN
    IF NOT (v_category_key = ANY(v_allowed_expense_categories)) THEN
      RAISE EXCEPTION 'Counterpart cannot be assigned to this expense transaction category: %', v_category_key;
    END IF;
  ELSE
    RAISE EXCEPTION 'Counterpart can only be assigned to income or expense transactions, not: %', v_transaction_type;
  END IF;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER validate_transaction_counterpart_insert
  BEFORE INSERT OR UPDATE ON transaction_counterparts
  FOR EACH ROW
  EXECUTE FUNCTION validate_transaction_counterpart();
```

## Prisma Schema定義

```prisma
model Counterpart {
  id        BigInt   @id @default(autoincrement())
  name      String   @db.VarChar(120)
  address   String   @db.VarChar(120)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  transactionCounterparts TransactionCounterpart[]

  @@unique([name, address])
  @@map("counterparts")
}

model TransactionCounterpart {
  id            BigInt      @id @default(autoincrement())
  transactionId BigInt      @map("transaction_id")
  counterpartId BigInt      @map("counterpart_id")
  createdAt     DateTime    @default(now()) @map("created_at")

  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  counterpart Counterpart @relation(fields: [counterpartId], references: [id], onDelete: Cascade)

  @@unique([transactionId, counterpartId])
  @@unique([transactionId])
  @@index([transactionId], name: "idx_transaction_counterparts_transaction")
  @@index([counterpartId], name: "idx_transaction_counterparts_counterpart")
  @@map("transaction_counterparts")
}
```

**Transaction モデルへの追加:**

```prisma
model Transaction {
  // ... 既存のフィールド

  transactionCounterparts TransactionCounterpart[]

  // ... 既存のリレーション
}
```

## マイグレーション戦略

1. **マイグレーションファイルの作成**
   - `counterparts` テーブルの作成
   - `transaction_counterparts` テーブルの作成
   - PostgreSQL trigger関数の作成
   - トリガーの設定

2. **既存データへの影響**
   - 既存の `transactions` テーブルには影響なし
   - counterpart情報は新規取引から段階的に追加

3. **ロールバック対応**
   - trigger削除 → `transaction_counterparts` テーブル削除 → `counterparts` テーブル削除の順


## スコープ外

以下は本設計のスコープ外とし、別途設計する:

1. counterpart編集・削除UI
2. counterpart登録・選択UI
3. 取引とcounterpartを紐付けるユースケース実装
4. donorテーブルとの関係
5. XML出力時のcounterpart情報のマッピング

## 参考

- 政治資金収支報告書 XMLデータフォーマット仕様書: [docs/report_format.md](report_format.md)
  - SYUUSHI07_14 (その14): 経常経費の支出明細
  - SYUUSHI07_15 (その15): 政治活動費の支出明細
  - SYUUSHI07_03〜07_06: 収入明細
