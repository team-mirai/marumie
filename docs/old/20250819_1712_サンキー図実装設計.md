# サンキー図実装設計

## 概要

政治団体の収支データをサンキー図で可視化する機能の設計書。
左側の収入項目から中央の合計金額を経由して右側の支出項目へとお金の流れを表示する。

## 現状分析

### 既存実装

- `webapp/src/app/components/SankeyChart.tsx`: サンキー図のReactコンポーネント（仮実装）
- `/api/p/[slug]/sankey`エンドポイントが未実装（現在は404エラー）
- `webapp/src/app/api/p/[slug]/transactions/route.ts`: 取引データ取得API（実装済み）

### データ構造

**DisplayTransaction型**:
```typescript
export interface DisplayTransaction {
  id: string;
  date: Date;
  yearmonth: string; // "2025.08"
  transactionType: TransactionType; // 'income' | 'expense' | 'other'
  category: string; // 表示用カテゴリ名
  subcategory?: string; // サブカテゴリ（任意）
  tags?: string; // タグ情報
  absAmount: number; // 金額（絶対値）
  amount: number; // 金額（支出時はマイナス値）
}
```

## 目標構造

サンキー図は以下の5層構造で表示：

1. **Income Subcategory** （左端）
   - 寄附の細分類（個人寄附、法人等寄附など）
   
2. **Income Category** （左から2番目）
   - 寄附、機関紙誌収入、その他収入など
   
3. **Total Amount** （中央）
   - 収入支出の合計金額
   
4. **Expense Category** （右から2番目）
   - 政治活動費、経常経費、本部支部交付金など
   
5. **Expense Subcategory** （右端）
   - 人件費、光熱水費、備品類、事務所費など

## 実装アーキテクチャ

### 1. APIエンドポイント実装

**新規ファイル**: `webapp/src/app/api/p/[slug]/sankey/route.ts`

```typescript
// データ取得とサンキー図用データ変換を行うエンドポイント
GET /api/p/{slug}/sankey
```

**主な処理**:
1. 既存のtransactions APIからDisplayTransaction[]を取得
2. サンキー図用のnode/linkデータに変換
3. 5層構造のデータを生成

### 2. データ変換ロジック

**新規ファイル**: `webapp/src/server/utils/sankey-converter.ts`

**変換手順**:
1. `transactionType`でincome/expenseを分類
2. `category`と`subcategory`でグループ化
3. 各グループの`absAmount`を合計
4. 5層のノードとリンクを生成

**ノード命名規則**:
- Income subcategory: `income-sub-{subcategory}`
- Income category: `income-cat-{category}`
- Total: `total`
- Expense category: `expense-cat-{category}`
- Expense subcategory: `expense-sub-{subcategory}`

### 3. ユースケース実装

**新規ファイル**: `webapp/src/server/usecases/get-sankey-data-usecase.ts`

- 既存のGetTransactionsBySlugUsecaseを活用
- フィルター機能を継承（期間、年度等）
- サンキー図専用の集計処理

### 4. 型定義

```typescript
// webapp/src/types/sankey.ts
export interface SankeyNode {
  id: string;
  label?: string;
}

export interface SankeyLink {
  source: string;
  target: string;
  value: number;
}

export interface SankeyData {
  nodes: SankeyNode[];
  links: SankeyLink[];
}
```

## データフロー

1. **ユーザーアクション**: ページアクセス
2. **フロントエンド**: `/api/p/{slug}/sankey`にリクエスト
3. **サンキーAPI**: 既存のtransactions repositoryからデータ取得
4. **データ変換**: DisplayTransaction[] → SankeyData
5. **レスポンス**: サンキー図用JSON
6. **描画**: @nivo/sankeyでサンキー図表示

## エラーハンドリング

- 政治団体が存在しない場合: 404エラー
- データが存在しない場合: 空のサンキー図表示
- API呼び出し失敗: エラーメッセージ表示

## 実装順序

1. サンキー図用型定義作成
2. データ変換ユーティリティ実装
3. サンキーデータ取得ユースケース実装
4. `/api/p/[slug]/sankey`エンドポイント実装
5. 既存SankeyChartコンポーネントの調整
6. テスト実装

## 考慮事項

- **パフォーマンス**: 大量データの集計処理最適化
- **UI/UX**: カテゴリ名の表示調整（長い名前の省略等）
- **国際化**: 将来的な多言語対応を考慮した設計
- **フィルター連携**: 既存の期間フィルターとの統合