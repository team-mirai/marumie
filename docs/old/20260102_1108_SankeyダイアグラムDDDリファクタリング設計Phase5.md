# SankeyダイアグラムDDDリファクタリング設計（Phase 5）

## 目的

**開発者が**、Sankeyダイアグラム関連のコードを理解・変更しやすくするため。

現状の課題:
- `utils/sankey-category-converter.ts` に複雑な変換ロジックが集中している
- 複数の関数が連鎖的に呼び出され、データの流れが追いにくい
- ドメイン知識（小規模項目統合、残高調整など）がユーティリティに埋もれている

---

## 既存実装の振る舞い分析

### 全体フロー

Sankeyダイアグラムは以下の流れでデータを生成する:

1. **Usecase（オーケストレーション）**: 政治団体の取得、集計データの取得、残高データの取得を行い、変換処理に渡す
2. **リポジトリ（データ取得）**: カテゴリ別の収入・支出集計、負債残高を取得
3. **変換処理（ドメインロジック）**: 取得したデータをSankeyノード・リンク形式に変換

---

### 1. GetSankeyAggregationUsecase の振る舞い

**役割**: 複数のリポジトリからデータを取得し、変換処理に渡すオーケストレーター

**アルゴリズム**:
1. 入力として `slugs`（政治団体識別子）、`financialYear`（財政年度）、`categoryType`（カテゴリ種別）を受け取る
2. `politicalOrganizationRepository.findBySlugs()` で政治団体を取得する
   - 見つからない場合はエラーをスローする
3. 政治団体IDの配列を作成する
4. 以下を並列で取得する:
   - `transactionRepository.getCategoryAggregationForSankey()`: カテゴリ別の収入・支出集計
   - `balanceSnapshotRepository.getTotalLatestBalancesByYear()`: 今年と昨年の残高
   - `transactionRepository.getLiabilityBalance()`: 負債残高
5. `convertCategoryAggregationToSankeyData()` を呼び出してSankeyデータに変換する

---

### 2. リポジトリのデータ取得の振る舞い

#### getCategoryAggregationForSankey

**役割**: 指定された財政年度の収入・支出をカテゴリ別に集計する

**アルゴリズム（political-categoryの場合）**:
1. 収入トランザクション（transactionType = "income"）を `creditAccount` でグループ化し、金額を合計する
2. 支出トランザクション（transactionType = "expense"）を `debitAccount` でグループ化し、金額を合計する
3. `PL_CATEGORIES` マッピングを使って、勘定科目名をカテゴリ/サブカテゴリに変換する
   - 例: 「個人からの寄附」→ カテゴリ「寄附」、サブカテゴリ「個人からの寄附」
4. 同じカテゴリ+サブカテゴリの組み合わせは金額を合算する

**アルゴリズム（friendly-categoryの場合）**:
1. 収入トランザクションを `creditAccount` と `friendlyCategory` でグループ化し、金額を合計する
2. 支出トランザクションを `debitAccount` と `friendlyCategory` でグループ化し、金額を合計する
3. `PL_CATEGORIES` マッピングでカテゴリを取得し、サブカテゴリには `friendlyCategory`（タグ）を使用する

#### getLiabilityBalance

**役割**: 指定された財政年度の負債残高を計算する

**アルゴリズム**:
1. `BS_CATEGORIES` から type = "liability" の勘定科目を抽出する（例: 「未払金/未払費用」）
2. その勘定科目の借方合計（減少）と貸方合計（増加）を取得する
3. 負債残高 = 貸方合計 - 借方合計 として計算する

---

### 3. convertCategoryAggregationToSankeyData の振る舞い

**役割**: カテゴリ別集計データをSankeyダイアグラムのノードとリンクに変換する

**メイン関数のアルゴリズム**:
1. 「その他」カテゴリを「その他の収入」「その他の支出」にリネームする（収入・支出を区別するため）
2. friendly-categoryモードの場合、小規模項目を統合する
3. 残高調整を行う（昨年からの現金残高、今年の現金残高を追加）
4. ノードとリンクを生成する

---

### 4. renameOtherCategories の振る舞い

**役割**: 収入と支出で「その他」が同じラベルだと区別できないため、リネームする

**アルゴリズム**:
1. 収入データの中で `category = "その他"` のものを `"その他の収入"` に変更する
2. 支出データの中で `category = "その他"` のものを `"その他の支出"` に変更する

---

### 5. consolidateSmallItems の振る舞い

**役割**: 小規模な項目を「その他（カテゴリ名）」にまとめて、グラフの見やすさを向上させる

**適用条件**: `isFriendlyCategory = true` の場合のみ実行する

**アルゴリズム**:
1. 収入と支出それぞれに対して動的閾値を計算する
2. 閾値未満のサブカテゴリ項目を「その他（カテゴリ名）」に統合する

#### calculateDynamicThreshold（動的閾値計算）

**役割**: サブカテゴリ数を上限（収入8個、支出8個）に抑えるための閾値を計算する

**アルゴリズム**:
1. サブカテゴリを持つ項目のみを抽出する
2. サブカテゴリ数が上限以下なら閾値0（統合不要）を返す
3. 金額降順でソートする
4. 上限番目の項目の金額を動的閾値として取得する
5. 全体の1%を最低閾値として計算する
6. 動的閾値と1%閾値の大きい方を返す

#### consolidateSmallItemsByType（小規模項目統合）

**役割**: 閾値未満の項目をカテゴリごとにまとめる

**アルゴリズム**:
1. 項目を「閾値未満のサブカテゴリ項目」と「それ以外」に分離する
2. 閾値未満の項目をカテゴリごとにグループ化する
3. 各カテゴリグループを統合処理する:
   - 1種類しかなければそのまま残す
   - 複数あれば金額を合算し、サブカテゴリ名を「その他（カテゴリ名）」にする
4. 大きい項目と統合済み項目をマージして返す

---

### 6. adjustBalanceAndCategories の振る舞い

**役割**: 現金残高と負債情報を収入・支出データに追加する

**アルゴリズム**:
1. **昨年からの現金残高の追加**（収入側）:
   - `previousYearBalance > 0` なら「昨年からの現金残高」を収入に追加する

2. **今年の現金残高の追加**（支出側、non-friendlyモード）:
   - `currentYearBalance > 0` かつ `isFriendlyCategory = false` なら「現金残高」を支出に追加する

3. **今年の現金残高の追加**（支出側、friendlyモード）:
   - `currentYearBalance > 0` かつ `isFriendlyCategory = true` の場合:
     - 未払費用 = max(liabilityBalance, 0)
     - 実際の現金残高 = max(currentYearBalance, 0)
     - 収支 = max(0, 実際の現金残高 - 未払費用)
     - 未払費用 > 0 なら「現金残高」カテゴリの「未払費用」サブカテゴリを追加する
     - 収支 > 0 なら「現金残高」カテゴリの「収支」サブカテゴリを追加する

---

### 7. ノード・リンク生成の振る舞い

**役割**: 処理済みの収入・支出データからSankeyダイアグラム用のノードとリンクを生成する

**ノード構造**:
- `income-sub`: 収入のサブカテゴリノード（例: 「個人からの寄附」）
- `income`: 収入のカテゴリノード（例: 「寄附」）
- `total`: 中央の「合計」ノード（常に1つ）
- `expense`: 支出のカテゴリノード（例: 「政治活動費」）
- `expense-sub`: 支出のサブカテゴリノード（例: 「宣伝費」）

**リンク構造**:
- `income-sub` → `income`: サブカテゴリからカテゴリへ
- `income` → `total`: カテゴリから合計へ
- `total` → `expense`: 合計からカテゴリへ
- `expense` → `expense-sub`: カテゴリからサブカテゴリへ

**アルゴリズム**:
1. **収入サブカテゴリノードの生成**:
   - 収入データのうちサブカテゴリを持つものについてノードを作成する
   - 同時にカテゴリごとの合計金額を計算する

2. **収入カテゴリノードの生成**:
   - カテゴリ合計から重複なくノードを作成する

3. **中央の「合計」ノードの生成**:
   - 固定で1つ作成する

4. **収支バランス調整**:
   - 収入合計と支出合計を計算する
   - 収入 > 支出 の場合、差額を「(仕訳中)」として支出に追加する
   - これによりSankeyダイアグラムの左右バランスが取れる

5. **支出カテゴリノードの生成**:
   - カテゴリ合計から重複なくノードを作成する

6. **支出サブカテゴリノードの生成**:
   - 支出データのうちサブカテゴリを持つものについてノードを作成する

7. **リンクの生成**:
   - 収入: サブカテゴリ → カテゴリ
   - 収入: カテゴリ → 合計
   - 支出: 合計 → カテゴリ
   - 支出: カテゴリ → サブカテゴリ

---

### 8. createSafariCompatibleId の振る舞い

**役割**: 日本語を含むノードIDをSafariで正しく表示できる形式に変換する

**背景**: SafariはD3.js/SVGで日本語IDを正しく処理できないことがある

**アルゴリズム**:
1. 入力文字列の各文字を検査する
2. 英数字・ハイフン・アンダースコア以外の文字（主に日本語）をハッシュ値に置換する
3. ハッシュは32bit整数として計算し、36進数文字列に変換する
4. 置換後の文字列を返す

---

## 補足: データの流れの全体像

```
[DB]
  ↓ リポジトリ層
  ↓ - getCategoryAggregationForSankey: 勘定科目 → カテゴリ/サブカテゴリ集計
  ↓ - getLiabilityBalance: 負債残高計算
  ↓ - getTotalLatestBalancesByYear: 今年/昨年の現金残高
  ↓
[Usecase層]
  ↓ データ取得のオーケストレーション
  ↓
[変換処理（現在はutils）]
  ↓ 1. renameOtherCategories: 「その他」のリネーム
  ↓ 2. consolidateSmallItems: 小規模項目の統合（friendlyモードのみ）
  ↓ 3. adjustBalanceAndCategories: 残高データの追加
  ↓ 4. ノード・リンク生成: グラフ構造への変換
  ↓
[SankeyData]
  - nodes: グラフのノード配列
  - links: ノード間の接続と金額
```

---

## 次のステップ

この振る舞い分析を基に、以下の設計を行う:

1. ドメインモデルの設計（SankeyAggregation、SankeyNode、SankeyLink等）
2. ドメインサービスの設計（複数エンティティをまたぐ変換ロジック）
3. リポジトリインターフェースの分離（Interface Segregation）
4. ディレクトリ構造とファイル配置の決定
