# 交付金フラグ更新処理設計

## 概要

`/assign/counterparts` ページのトランザクション行に表示されている交付金フラグ（`isGrantExpenditure`）のトグル操作で、実際にデータベースを更新する処理を実装する。

## 背景

[docs/20251230_0106_交付金フラグUI表示設計.md](20251230_0106_交付金フラグUI表示設計.md) で Phase 1 として UI 表示とトグル操作の仮実装（`alert("not implemented")`）を完了した。本設計は Phase 2 として、トグル操作時の実際の更新処理を実装する。

## 機能要件

1. トグル操作で `isGrantExpenditure` フラグを更新できる
2. 更新成功時は UI に反映される（楽観的更新）
3. 更新失敗時はエラートーストを表示し、UI を元の状態に戻す
4. 支出取引（`transactionType === "expense"`）のみ更新可能

## アーキテクチャ

admin アーキテクチャガイドに従い、以下のレイヤー構造で実装する。

```
domain/models/         → grant-expenditure-rules.ts（新規：ドメインルール）
presentation/actions/  → update-grant-expenditure-flag.ts
application/usecases/  → update-grant-expenditure-flag-usecase.ts
infrastructure/repositories/  → prisma-report-transaction.repository.ts に追加
```

## 実装詳細

### 1. ドメインモデル（交付金フラグルール）

**ファイル**: `admin/src/server/contexts/report/domain/models/grant-expenditure-rules.ts`（新規作成）

交付金フラグに関するビジネスルールをドメインモデルとして定義する。`counterpart-assignment-rules.ts` と同様のパターンを採用。

```typescript
/**
 * 交付金フラグの更新可否を判定
 *
 * @param transactionType - 'income' | 'expense'
 * @returns 交付金フラグを設定可能な場合true
 */
export function canSetGrantExpenditureFlag(
  transactionType: "income" | "expense",
): boolean;

/**
 * 交付金フラグ更新のバリデーション結果
 */
export interface GrantExpenditureFlagValidationResult {
  isValid: boolean;
  errorMessage?: string;
}

/**
 * 交付金フラグ更新のバリデーションを実行
 *
 * @param transactionType - 'income' | 'expense'
 * @returns バリデーション結果
 */
export function validateGrantExpenditureFlagUpdate(
  transactionType: "income" | "expense",
): GrantExpenditureFlagValidationResult;
```

このドメインモデルにより:
- ビジネスルール（「支出取引のみ交付金フラグを設定可能」）がドメイン層に集約される
- 将来のルール追加（例：会計期間との関連チェック、特定カテゴリの制約）に対応しやすい
- ユースケースはドメインルールを呼び出すだけでよく、ロジックが分離される

### 2. リポジトリインターフェース拡張

**ファイル**: [admin/src/server/contexts/report/domain/repositories/report-transaction-repository.interface.ts](../admin/src/server/contexts/report/domain/repositories/report-transaction-repository.interface.ts)

`ITransactionWithCounterpartRepository` に以下のメソッドを追加:

```typescript
/**
 * 交付金フラグを更新する
 * @param id トランザクションID
 * @param isGrantExpenditure 交付金に係る支出かどうか
 */
updateGrantExpenditureFlag(id: bigint, isGrantExpenditure: boolean): Promise<void>;
```

### 3. リポジトリ実装

**ファイル**: [admin/src/server/contexts/report/infrastructure/repositories/prisma-report-transaction.repository.ts](../admin/src/server/contexts/report/infrastructure/repositories/prisma-report-transaction.repository.ts)

`PrismaReportTransactionRepository` に `updateGrantExpenditureFlag` メソッドを追加:

- Prisma の `update` を使用して `isGrantExpenditure` フィールドを更新
- 対象トランザクションが存在しない場合はエラーをスロー

### 4. ユースケース

**ファイル**: `admin/src/server/contexts/report/application/usecases/update-grant-expenditure-flag-usecase.ts`（新規作成）

#### 入力

```typescript
interface UpdateGrantExpenditureFlagInput {
  transactionId: string;
  isGrantExpenditure: boolean;
}
```

#### 出力

```typescript
interface UpdateGrantExpenditureFlagResult {
  success: boolean;
  errors?: string[];
}
```

#### 処理フロー

1. `transactionId` を BigInt に変換、失敗時はエラー
2. トランザクションの存在確認（リポジトリ経由）
3. ドメインルール `validateGrantExpenditureFlagUpdate` でバリデーション
4. リポジトリで `isGrantExpenditure` を更新
5. 成功を返却

#### バリデーション

ドメインモデル `grant-expenditure-rules.ts` の関数を使用:

- 無効なトランザクションID → エラー（ユースケース内でチェック）
- 存在しないトランザクション → エラー（ユースケース内でチェック）
- 収入取引への更新試行 → エラー（ドメインルール `validateGrantExpenditureFlagUpdate` が返却）

### 5. サーバーアクション

**ファイル**: `admin/src/server/contexts/report/presentation/actions/update-grant-expenditure-flag.ts`（新規作成）

```typescript
export async function updateGrantExpenditureFlagAction(
  transactionId: string,
  isGrantExpenditure: boolean,
): Promise<UpdateGrantExpenditureFlagActionResult>;
```

#### 処理

1. リポジトリとユースケースをインスタンス化
2. ユースケースを実行
3. 成功時: `revalidatePath("/assign/counterparts")` でキャッシュ無効化
4. 結果を返却

### 6. UIコンポーネント更新

**ファイル**: [admin/src/client/components/counterpart-assignment/TransactionWithCounterpartTable.tsx](../admin/src/client/components/counterpart-assignment/TransactionWithCounterpartTable.tsx)

#### 変更内容

1. `updateGrantExpenditureFlagAction` をインポート
2. `onCheckedChange` のコールバックを実装:
   - 楽観的更新: 即座に UI を更新
   - アクション呼び出し
   - 失敗時: UI を元に戻し、エラートーストを表示

#### 楽観的更新の実装方針

テーブルコンポーネントは `transactions` を props で受け取るため、楽観的更新には親コンポーネントとの連携が必要。以下の2つのアプローチを検討:

**案A: ローカル状態での楽観的更新（採用）**
- テーブルコンポーネント内で `useState` を使用してローカル状態を管理
- 更新成功時に revalidatePath でサーバー側キャッシュを無効化し、ページ全体がリフレッシュ

**案B: 親コンポーネントへのコールバック**
- `onGrantExpenditureFlagChange` props を追加
- 親コンポーネントで状態管理

案Aを採用する理由:
- 既存のコンポーネント構造への影響が最小限
- 交付金フラグの更新は独立した操作であり、他の状態と連携する必要がない
- revalidatePathによるサーバー側キャッシュ無効化で整合性を担保

### 7. トースト通知

エラー発生時にトースト通知を表示する。admin では既に toast 機能が利用可能。

- 成功時: トーストは表示しない（UI の変化で十分）
- 失敗時: エラーメッセージをトーストで表示

## 影響範囲

| ファイル | 変更内容 |
|---------|---------|
| `grant-expenditure-rules.ts` (domain/models) | 新規作成：交付金フラグのドメインルール |
| `report-transaction-repository.interface.ts` | `updateGrantExpenditureFlag` メソッド追加 |
| `prisma-report-transaction.repository.ts` | `updateGrantExpenditureFlag` 実装追加 |
| `update-grant-expenditure-flag-usecase.ts` | 新規作成 |
| `update-grant-expenditure-flag.ts` (action) | 新規作成 |
| `TransactionWithCounterpartTable.tsx` | トグル操作時のアクション呼び出し実装 |

## 制約事項

- 支出取引のみが更新対象（収入取引は対象外）
- 1件ずつの更新（一括更新は後続タスクで検討）
