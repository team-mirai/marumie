# authコンテキスト エントリーポイント整理設計

## 1. 背景と目的

authコンテキストは4レイヤー構造へのリファクタリングが完了しているが、以下の問題がある：

1. **APIルートの冗長性**: Server Actionで実現可能な処理がAPIルートとして提供されている
2. **権限チェックの分散**: `requireRole`がフロントエンド（APIルート層）で呼び出されており、Usecase層での一元管理ができていない
3. **エントリーポイントの重複**: 同一機能に対して複数のエントリーポイントが存在（例: logout/signOut）
4. **不要なUsecase**: 単にリポジトリを呼び出すだけのUsecaseが存在
5. **未使用のAPIルート**: 実際には呼び出されていないAPIルートが存在

## 2. 現状分析

### 2.1 現在のAPIルート一覧

| APIルート | メソッド | 呼び出し元 | 処理内容 |
|-----------|----------|------------|----------|
| `/api/logout` | POST | 未使用 | signOut()を呼び出しJSON返却 |
| `/api/auth/setup-password` | POST | SetupForm（ApiClient経由） | getCurrentUser + setupPassword |
| `/api/users` | GET | 未使用 | loadAllUsers() |
| `/api/users/role` | PATCH | UserManagement（ApiClient経由） | requireRole + updateUserRole |
| `/api/users/invite` | POST | UserManagement（ApiClient経由） | requireRole + inviteUser |
| `/api/users/create-from-invite` | POST | 未使用 | getUserByAuthId + createUser |

### 2.2 現在のPresentation層

**Actions（"use server"）**:
- `loginWithPassword` - ログイン処理（redirect付き）
- `logout` - ログアウト処理（redirect付き）
- `signOut` - ログアウト処理（JSON応答、API用）
- `setupPassword` - パスワード設定
- `inviteUser` - ユーザー招待
- `updateUserRole` - ロール更新
- `exchangeCodeForSession` - OAuthコールバック
- `completeInviteSession` - 招待セッション完了
- `createUser` - ユーザー作成（"server-only"、actionではない）

**Loaders（"server-only"）**:
- `getCurrentUser` - 現在ユーザー取得
- `getCurrentUserRole` - 現在ユーザーロール取得
- `loadAllUsers` - 全ユーザー取得
- `getUserByAuthId` - authIdでユーザー取得
- `requireRole` - ロール検証

### 2.3 現在のUsecase一覧

| Usecase | 責務 | 権限チェック |
|---------|------|--------------|
| LoginUsecase | ログイン | なし |
| LogoutUsecase | ログアウト | なし |
| SetupPasswordUsecase | パスワード設定 | なし |
| GetCurrentUserUsecase | 現在ユーザー取得 | なし |
| GetCurrentUserRoleUsecase | ロール取得 | なし |
| GetAllUsersUsecase | 全ユーザー取得 | **内蔵（admin）** |
| GetUserByAuthIdUsecase | authIdでユーザー取得 | なし |
| CreateUserUsecase | ユーザー作成 | なし |
| UpdateUserRoleUsecase | ロール更新 | なし |
| InviteUserUsecase | ユーザー招待 | なし |
| RequireRoleUsecase | ロール検証 | - |
| ExchangeCodeForSessionUsecase | OAuthコールバック | なし |
| CompleteInviteSessionUsecase | 招待セッション完了 | なし |

### 2.4 問題点の詳細

#### 問題1: 権限チェックの分散
```
現状:
  APIルート(/api/users/role) → requireRole("admin") → updateUserRole()
  APIルート(/api/users/invite) → requireRole("admin") → inviteUser()
  GetAllUsersUsecase → 内部でrequireRole相当の処理

問題: 権限チェックがAPIルートとUsecaseに分散しており一貫性がない
```

#### 問題2: Server Action化可能なAPIルート
```
/api/auth/setup-password:
  - 認証チェック + setupPassword() を呼ぶだけ
  - Server Actionで直接呼び出し可能

/api/users/role, /api/users/invite:
  - 権限チェック + action呼び出し
  - 権限チェックをUsecase内に移動すればServer Action化可能

/api/logout:
  - 現在未使用
  - 削除可能
```

#### 問題3: 薄すぎるUsecase
```
CreateUserUsecase: userRepository.create() を呼ぶだけ
GetUserByAuthIdUsecase: userRepository.findByAuthId() を呼ぶだけ

→ Usecaseとして独立させる必要がない
→ 他のUsecaseの内部処理として吸収可能
```

#### 問題4: エントリーポイントの重複
```
ログアウト:
  - logout() action - redirect付き、Sidebarから呼び出し
  - signOut() action - JSON応答、API用（未使用）
  - /api/logout - signOutを呼び出し（未使用）

→ 実際に使われているのはlogout()のみ
```

## 3. 設計方針

### 3.1 原則

1. **Server Action優先**: クライアントからの呼び出しは原則Server Actionを使用
2. **Usecase内権限チェック**: admin権限が必要な操作はUsecase内で権限チェックを行う
3. **最小限のUsecase**: リポジトリ呼び出しだけのUsecaseは不要、他に吸収
4. **エントリーポイント統一**: 同一機能に対するエントリーポイントは1つ

### 3.2 APIルートを残すケース

以下の場合のみAPIルートを使用：
- Blobダウンロード（export-report等）
- 外部サービスからのWebhook受信
- OAuthコールバック（route.ts）

認証済みユーザーからのJSON API呼び出しはServer Actionに統一する。

## 4. 変更計画

### 4.1 削除するAPIルート

| APIルート | 理由 |
|-----------|------|
| `/api/logout` | 未使用、logout() actionで代替 |
| `/api/auth/setup-password` | Server Action化 |
| `/api/users` | 未使用、loadAllUsers loaderで代替 |
| `/api/users/role` | Server Action化 |
| `/api/users/invite` | Server Action化 |
| `/api/users/create-from-invite` | 未使用、内部処理で完結 |

### 4.2 削除するUsecase

| Usecase | 理由 |
|---------|------|
| CreateUserUsecase | リポジトリ呼び出しのみ。CompleteInviteSession/ExchangeCodeForSessionに吸収 |
| GetUserByAuthIdUsecase | リポジトリ呼び出しのみ。未使用 |
| RequireRoleUsecase | 他Usecaseに権限チェックを内蔵させるため不要 |
| GetCurrentUserRoleUsecase | AuthUserにroleが含まれるため、GetCurrentUserUsecaseで代替可能 |

### 4.3 変更するUsecase

| Usecase | 変更内容 |
|---------|----------|
| UpdateUserRoleUsecase | admin権限チェックを内蔵 |
| InviteUserUsecase | admin権限チェックを内蔵 |

### 4.4 削除するPresentation層

| ファイル | 理由 |
|----------|------|
| `actions/create-user.ts` | 未使用 |
| `actions/logout.ts` の `signOut()` | 未使用 |
| `loaders/load-user-by-auth-id.ts` | 未使用 |
| `loaders/require-role.ts` | Usecase内権限チェックに移行 |
| `loaders/load-current-user-role.ts` | getCurrentUserの返り値からroleを取得可能 |

### 4.5 変更するクライアント/サーバーコード

| ファイル | 変更内容 |
|----------|----------|
| `SetupForm.tsx` | apiClient.setupPassword → setupPassword action直接呼び出し |
| `UserManagement.tsx` | apiClient.updateUserRole/inviteUser → Server Action直接呼び出し |
| `api-client.ts` | auth関連メソッド（setupPassword, updateUserRole, inviteUser）を削除 |
| `(auth)/layout.tsx` | getCurrentUserRole()呼び出しを削除し、user.roleを使用 |

## 5. 変更後の構造

### 5.1 Presentation層（変更後）

**Actions**:
- `loginWithPassword` - ログイン（redirect付き）
- `logout` - ログアウト（redirect付き）
- `setupPassword` - パスワード設定（クライアントから直接呼び出し）
- `inviteUser` - ユーザー招待（権限チェックはUsecase内）
- `updateUserRole` - ロール更新（権限チェックはUsecase内）
- `exchangeCodeForSession` - OAuthコールバック
- `completeInviteSession` - 招待セッション完了

**Loaders**:
- `getCurrentUser` - 現在ユーザー取得（roleを含むAuthUserを返す）
- `loadAllUsers` - 全ユーザー取得

### 5.2 Usecase層（変更後）

| Usecase | 責務 | 権限チェック |
|---------|------|--------------|
| LoginUsecase | ログイン | なし |
| LogoutUsecase | ログアウト | なし |
| SetupPasswordUsecase | パスワード設定 | なし（認証済み前提） |
| GetCurrentUserUsecase | 現在ユーザー取得（roleを含む） | なし |
| GetAllUsersUsecase | 全ユーザー取得 | 内蔵（admin） |
| UpdateUserRoleUsecase | ロール更新 | **内蔵（admin）** |
| InviteUserUsecase | ユーザー招待 | **内蔵（admin）** |
| ExchangeCodeForSessionUsecase | OAuthコールバック + ユーザー作成 | なし |
| CompleteInviteSessionUsecase | 招待セッション完了 + ユーザー作成 | なし |

### 5.3 呼び出しフロー（変更後）

```
ログイン:
  LoginForm → loginWithPassword action → LoginUsecase

ログアウト:
  Sidebar → logout action → LogoutUsecase → redirect

パスワード設定:
  SetupForm → setupPassword action → SetupPasswordUsecase

ユーザー招待:
  UserManagement → inviteUser action → InviteUserUsecase（権限チェック内蔵）

ロール更新:
  UserManagement → updateUserRole action → UpdateUserRoleUsecase（権限チェック内蔵）

ユーザー一覧:
  users/page.tsx → loadAllUsers loader → GetAllUsersUsecase（権限チェック内蔵）
```

## 6. 実装順序

1. **Usecase層の修正**
   - UpdateUserRoleUsecaseに権限チェックを追加
   - InviteUserUsecaseに権限チェックを追加

2. **クライアントコードの修正**
   - SetupForm.tsxをServer Action直接呼び出しに変更
   - UserManagement.tsxをServer Action直接呼び出しに変更

3. **不要なコードの削除**
   - 未使用APIルートの削除
   - 未使用Usecaseの削除
   - 未使用Presentation層の削除
   - api-client.tsから不要メソッドの削除

4. **動作確認**
   - ログイン/ログアウト
   - パスワード設定（招待フロー）
   - ユーザー招待
   - ロール変更
   - ユーザー一覧表示

## 7. 削除対象ファイル一覧

### APIルート
- `admin/src/app/api/logout/route.ts`
- `admin/src/app/api/auth/setup-password/route.ts`
- `admin/src/app/api/users/route.ts`
- `admin/src/app/api/users/role/route.ts`
- `admin/src/app/api/users/invite/route.ts`
- `admin/src/app/api/users/create-from-invite/route.ts`

### Usecase
- `admin/src/server/contexts/auth/application/usecases/create-user-usecase.ts`
- `admin/src/server/contexts/auth/application/usecases/get-user-by-auth-id-usecase.ts`
- `admin/src/server/contexts/auth/application/usecases/require-role-usecase.ts`
- `admin/src/server/contexts/auth/application/usecases/get-current-user-role-usecase.ts`

### Presentation層
- `admin/src/server/contexts/auth/presentation/actions/create-user.ts`
- `admin/src/server/contexts/auth/presentation/loaders/load-user-by-auth-id.ts`
- `admin/src/server/contexts/auth/presentation/loaders/require-role.ts`
- `admin/src/server/contexts/auth/presentation/loaders/load-current-user-role.ts`

### 関数削除
- `admin/src/server/contexts/auth/presentation/actions/logout.ts` から `signOut()` 関数を削除
- `admin/src/client/lib/api-client.ts` から `setupPassword()`, `updateUserRole()`, `inviteUser()` メソッドを削除
