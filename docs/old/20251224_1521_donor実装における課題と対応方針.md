# Donor実装における課題と対応方針

## 概要

donorテーブル実装時に発覚した`category_key`とcategory-mapping.tsの整合性の問題と、その対応方針をまとめる。

## 発覚した問題

### 問題1: category_keyの命名規則の不整合

**現状:**
- counterpartのマイグレーションでは`category-mapping.ts`の`key`フィールドを使用
  - 例: `'publication-income'`, `'utilities'`, `'individual-donations'`
  - 命名規則: ケバブケース（ハイフン区切り）

**設計時の想定:**
- donorのマイグレーションで異なる命名規則を使用していた
  - 例: `'income_donation_individual'`, `'income_party_individual'`
  - 命名規則: スネークケース（アンダースコア区切り）

**原因:**
既存の`category-mapping.ts`を確認せずに、独自の命名規則でマイグレーションファイルを作成してしまった。

### 問題2: category-mapping.tsに不足しているカテゴリ

**現状のcategory-mapping.ts:**
寄附関連は以下のみ存在:
- `individual-donations` (個人からの寄附)
- `specific-individual-donations` (個人からの寄附・特定寄附)
- `corporate-donations` (法人その他の団体からの寄附)
- `political-donations` (政治団体からの寄附)
- `anonymous-donations` (政党匿名寄附)

**不足しているカテゴリ:**
以下が存在しない:
1. あっせんによる寄附（個人/法人/政治団体）
2. 政治資金パーティー対価（個人/法人/政治団体）
3. あっせんによるパーティー対価（個人/法人/政治団体）

## 対応方針

### 1. category-mapping.tsへのカテゴリ追加

以下のカテゴリをcategory-mapping.tsに追加する必要がある:

```typescript
// 政治資金パーティー対価
"政治資金パーティー対価（個人）": {
  key: "party-individual",
  category: "寄附",
  subcategory: "政治資金パーティー対価",
  color: "#BBF7D0",
  shortLabel: "パーティ（個人）",
  type: "income"
},
"政治資金パーティー対価（法人）": {
  key: "party-corporate",
  category: "寄附",
  subcategory: "政治資金パーティー対価",
  color: "#FECACA",
  shortLabel: "パーティ（法人）",
  type: "income"
},
"政治資金パーティー対価（政治団体）": {
  key: "party-political",
  category: "寄附",
  subcategory: "政治資金パーティー対価",
  color: "#A5F3FC",
  shortLabel: "パーティ（政治団体）",
  type: "income"
},

// あっせん寄附は必要に応じて追加
// ※現時点では通常の寄附と区別する必要性が不明
```

### 2. マイグレーションファイルの修正

donorマイグレーションのTrigger関数内で使用するcategory_keyを、category-mapping.tsの`key`に合わせる:

**修正前:**
```sql
v_allowed_donation_categories TEXT[] := ARRAY[
  'income_donation_individual',
  'income_donation_corporation',
  'income_donation_political_org',
  ...
];
v_allowed_party_categories TEXT[] := ARRAY[
  'income_party_individual',
  'income_party_corporation',
  'income_party_political_org',
  ...
];
```

**修正後:**
```sql
v_allowed_donation_categories TEXT[] := ARRAY[
  'individual-donations',
  'specific-individual-donations',
  'corporate-donations',
  'political-donations'
];
v_allowed_party_categories TEXT[] := ARRAY[
  'party-individual',
  'party-corporate',
  'party-political'
];
```

### 3. donor_typeとcategory_keyの整合性チェックロジックの修正

現在のLIKE句によるパターンマッチング:
```sql
IF v_donor_type = 'individual' THEN
  IF NOT (v_category_key LIKE '%_individual') THEN
    RAISE EXCEPTION ...
```

これを明示的なマッピングに変更:
```sql
IF v_donor_type = 'individual' THEN
  IF NOT (v_category_key IN ('individual-donations', 'specific-individual-donations', 'party-individual')) THEN
    RAISE EXCEPTION 'Donor type "individual" cannot be assigned to category: %', v_category_key;
  END IF;
ELSIF v_donor_type = 'corporation' THEN
  IF NOT (v_category_key IN ('corporate-donations', 'party-corporate')) THEN
    RAISE EXCEPTION 'Donor type "corporation" cannot be assigned to category: %', v_category_key;
  END IF;
ELSIF v_donor_type = 'political_organization' THEN
  IF NOT (v_category_key IN ('political-donations', 'party-political')) THEN
    RAISE EXCEPTION 'Donor type "political_organization" cannot be assigned to category: %', v_category_key;
  END IF;
```

### 4. 設計ドキュメントの更新

[docs/20251224_1500_donorテーブル設計.md](20251224_1500_donorテーブル設計.md) を更新し、実際のcategory_key値を反映する。

## 実装手順

1. **category-mapping.tsの更新**
   - 不足しているカテゴリを追加
   - 既存のフロントエンド/バックエンドコードへの影響を確認

2. **マイグレーションファイルの作成**
   - 正しいcategory_key値を使用
   - Trigger関数を修正

3. **設計ドキュメントの更新**
   - 実際の値に合わせて修正

4. **テストの追加**
   - Trigger関数の動作確認
   - 各donor_typeとcategory_keyの組み合わせテスト

## 未解決の課題

### 1. あっせん寄附の扱い

政治資金規正法では「あっせんによる寄附」は通常の寄附と区別して報告する必要がある（SYUUSHI07_08）。

**選択肢:**
- A. category-mapping.tsに別カテゴリとして追加（例: `intermediary-individual-donations`）
- B. 同じカテゴリだが、Transaction側で追加情報（is_intermediary的なフラグ）を保持
- C. donorテーブルにis_intermediaryフラグを追加

**推奨:** 選択肢Aまたは選択肢B
- 報告書出力時に明確に区別できる
- category_keyで完結するのが最もシンプル（選択肢A）

### 2. 特定寄附の扱い

現在`specific-individual-donations`が存在するが、これとdonor_typeの関係が不明確。

**確認事項:**
- 特定寄附は個人のみか、法人も存在するか？
- donorとの紐付けは通常の寄附と同じで良いか？

## 参考

- Counterpartマイグレーション: [prisma/migrations/20251215021743_add_counterpart_tables/migration.sql](../prisma/migrations/20251215021743_add_counterpart_tables/migration.sql)
- Category mapping: [shared/accounting/account-category.ts](../shared/accounting/account-category.ts)
- 報告書フォーマット: [docs/reference/report-format.md](docs/reference/report-format.md)
