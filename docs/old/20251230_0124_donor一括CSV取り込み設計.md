# Donor一括CSV取り込み機能 設計ドキュメント

## 注意事項

**このドキュメントは設計概要であり、実装の詳細なコードを含まない。**

レビューワー向けに大まかな処理フローと責務分担を記述している。実装時には各レイヤーの詳細設計を行うこと。

---

## 1. 概要

### 1.1 目的

Donor（寄付者）情報をCSVで一括取り込みし、既存のTransactionと紐付ける機能を提供する。

### 1.2 CSVフォーマット

| カラム名 | 必須 | 説明 |
|---------|------|------|
| transaction_no | ○ | 紐付け対象のTransaction.transaction_no |
| name | ○ | 寄付者名（最大120文字） |
| donorType | ○ | individual / corporation / political_organization |
| address | - | 住所（最大120文字） |
| occupation | - | 職業（最大50文字） |

**補足**: address, occupation は取り込み時点で不明な場合があるため、後から編集可能とする。

---

## 2. 処理フロー概要

MFクラウドCSV取り込み機能（`preview-mf-csv-usecase.ts`）を参考に、**プレビュー → 確定** の2段階フローを採用する。

```
┌──────────────────────────────────────────────────────────────────┐
│                      プレビューフェーズ                            │
├──────────────────────────────────────────────────────────────────┤
│  1. CSVアップロード                                               │
│  2. CSVパース（DonorCsvLoader）                                   │
│  3. 各行をプレビュー用モデルに変換（DonorCsvRecordConverter）       │
│  4. バリデーション（DonorCsvValidator）                            │
│     - Donor入力値のバリデーション                                  │
│     - transaction_noの存在チェック                                │
│     - カテゴリとdonorTypeの整合性チェック                          │
│  5. プレビュー結果を画面に表示                                     │
└──────────────────────────────────────────────────────────────────┘
                              ↓ ユーザー確認後
┌──────────────────────────────────────────────────────────────────┐
│                      インポート確定フェーズ                        │
├──────────────────────────────────────────────────────────────────┤
│  1. 再度CSV内容をパース＆バリデーション                            │
│  2. Donorのupsert（name + address + donorType でユニーク）        │
│  3. TransactionDonorの紐付け作成                                  │
│  4. キャッシュ無効化                                               │
└──────────────────────────────────────────────────────────────────┘
```

---

## 3. アーキテクチャ（レイヤー構成）

### 3.1 コンテキスト選択

この機能は「Donor一括取り込み」であり、Donorは**reportコンテキスト**のドメインモデルである。アーキテクチャガイドの「コンテキスト間で直接依存していない（shared経由のみ）」ルールに従い、**reportコンテキスト**に配置する。

data-importコンテキストは「MFクラウドCSVからのTransaction取り込み」を責務とし、Donor関連の処理はreportコンテキストの責務とする。

### 3.2 ディレクトリ構成

```
report/
├── presentation/
│   ├── loaders/
│   │   ├── (既存)
│   │   └── preview-donor-csv-loader.ts       # プレビュー取得用loader
│   └── actions/
│       ├── (既存)
│       └── import-donor-csv-action.ts        # 確定時のサーバーアクション
├── application/
│   └── usecases/
│       ├── (既存)
│       ├── preview-donor-csv-usecase.ts      # プレビュー処理
│       └── import-donor-csv-usecase.ts       # インポート確定処理
├── domain/
│   ├── models/
│   │   ├── (既存)
│   │   └── preview-donor-csv-row.ts          # プレビュー行モデル
│   └── services/
│       ├── (既存)
│       └── donor-csv-validator.ts            # CSVバリデーションサービス
└── infrastructure/
    ├── repositories/
    │   └── (既存)
    └── donor-csv/
        ├── donor-csv-loader.ts               # CSVパーサー
        └── donor-csv-record-converter.ts     # CSV行→ドメインモデル変換
```

---

## 4. 各レイヤーの責務

### 4.1 Infrastructure層

#### DonorCsvLoader
- CSVテキストをパースし、`DonorCsvRecord` の配列を返す
- MfCsvLoaderと同様のCSVパース処理
- 日本語ヘッダーと英語カラム名のマッピング

```
入力: CSVテキスト
出力: DonorCsvRecord[]

interface DonorCsvRecord {
  transaction_no: string;
  donorType: string;
  name: string;
  address: string;
  occupation: string;
}
```

#### DonorCsvRecordConverter
- `DonorCsvRecord` を `PreviewDonorCsvRow` に変換
- 文字列のトリム処理

### 4.2 Domain層

#### PreviewDonorCsvRow（ドメインモデル）
```
interface PreviewDonorCsvRow {
  rowNumber: number;
  transaction_no: string;
  name: string;
  donorType: DonorType | null;  // 無効な値の場合はnull
  address: string | null;
  occupation: string | null;

  // バリデーション結果
  status: "valid" | "invalid" | "transaction_not_found" | "type_mismatch";
  errors: string[];

  // 紐付け先Transaction情報（存在する場合）
  transactionId?: string;
  transactionCategoryKey?: string;
}
```

#### DonorCsvValidator（ドメインサービス）
- 複数行のバリデーションを一括実行
- 既存の `validateDonorInput` を再利用
- Transaction存在チェック
- カテゴリとdonorTypeの整合性チェック（`isDonorTypeAllowedForCategory` を使用）

バリデーション項目:
1. **必須チェック**: transaction_no, name, donorType が存在するか
2. **文字数制限**: name（120文字）、address（120文字）、occupation（50文字）
3. **donorType有効性**: individual / corporation / political_organization のいずれか
4. **transaction_no存在チェック**: DBに該当Transactionが存在するか
5. **カテゴリ整合性**: TransactionのcategoryKeyに対してdonorTypeが許可されているか

### 4.3 Application層

#### PreviewDonorCsvUsecase
```
入力: { csvContent: string, politicalOrganizationId: string }
出力: {
  rows: PreviewDonorCsvRow[];
  summary: {
    total: number;
    valid: number;
    invalid: number;
  };
}
```

処理フロー:
1. DonorCsvLoader でCSVパース
2. DonorCsvRecordConverter で変換
3. Transaction一括取得（transaction_no配列で検索）
4. DonorCsvValidator でバリデーション
5. サマリー計算

#### ImportDonorCsvUsecase
```
入力: { csvContent: string, politicalOrganizationId: string }
出力: {
  success: boolean;
  importedCount?: number;
  errors?: string[];
}
```

処理フロー:
1. PreviewDonorCsvUsecaseと同様のパース＆バリデーション
2. 無効な行がある場合はエラーで終了
3. 各行についてDonorの検索または作成（`manage-donor-usecase`と同様のパターン）
   - `findByNameAddressAndType(name, address, donorType)` で既存Donorを検索
   - 存在する場合はそのDonorを使用
   - 存在しない場合は `create(data)` で新規作成
4. TransactionDonorの紐付け作成（`TransactionDonorRepository.replaceMany()` 使用）

### 4.4 Presentation層

#### import-donor-csv-action.ts
- サーバーアクションとして `ImportDonorCsvUsecase` を呼び出し
- 成功時に `revalidatePath("/assign/donors")` でキャッシュ無効化

---

## 5. 既存コンポーネントの再利用

| 既存コンポーネント | 用途 |
|------------------|------|
| `validateDonorInput` | Donor入力値のバリデーション |
| `isDonorTypeAllowedForCategory` | カテゴリとdonorType整合性チェック |
| `IDonorRepository.findByNameAddressAndType()` | 既存Donorの検索 |
| `IDonorRepository.create()` | 新規Donor作成 |
| `ITransactionDonorRepository.replaceMany()` | 紐付けの一括作成（トランザクション対応） |
| `ITransactionRepository` | transaction_noでのTransaction検索 |

**注意**: `IDonorRepository` には `upsert()` メソッドが存在しない。`manage-donor-usecase` と同様に `findByNameAddressAndType()` → `create()` の二段階パターンを使用する。

---

## 6. UIフロー（参考）

1. CSVファイルアップロード
2. プレビュー表示（テーブル形式）
   - 各行のステータス（valid/invalid/transaction_not_found/type_mismatch）
   - エラー内容の表示
   - サマリー（全件数、成功件数、エラー件数）
3. 「インポート実行」ボタン（全件validの場合のみ有効化）
4. 完了通知

---

## 7. エラーハンドリング

| エラー種別 | 対応 |
|-----------|------|
| CSVパースエラー | プレビュー時にエラーメッセージ表示 |
| 入力値バリデーションエラー | 該当行をinvalidとしてエラー理由表示 |
| transaction_no未存在 | 該当行をtransaction_not_foundとして表示 |
| donorType不整合 | 該当行をtype_mismatchとして表示 |
| DB保存エラー | インポート処理全体をロールバック、エラーメッセージ返却 |

---

## 8. 考慮事項

### 8.1 重複処理
- CSVファイル内に同一transaction_noが複数存在する場合の対応を決める必要がある
  - 案1: 先勝ち（最初の行のみ処理）
  - 案2: 後勝ち（最後の行で上書き）
  - 案3: エラーとする

### 8.2 既存紐付けの扱い
- 既にDonorが紐付いているTransactionに対して新たなDonorをインポートする場合の挙動
  - 現状の `TransactionDonorRepository.replaceMany` は既存を置換する設計

### 8.3 大量データ対応
- CSVの行数制限を設けるか検討（例: 1000行まで）
- バッチ処理が必要になる場合は別途設計

---

## 9. チェックリスト（実装時に確認）

- [ ] Presentation層はUsecaseのみを呼び出し、ビジネスロジックを含んでいない
- [ ] Application層（Usecase）はリポジトリインターフェースに依存し、実装クラスに依存していない
- [ ] Domain層は他のレイヤーに依存していない
- [ ] Infrastructure層はドメインインターフェースを実装している
- [ ] コンテキスト間で直接依存していない（shared経由のみ）
- [ ] actionsで適切に`revalidatePath`を呼び出している
