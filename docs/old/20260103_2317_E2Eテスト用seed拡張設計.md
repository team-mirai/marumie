# E2Eテスト用seed拡張設計

## 目的

**E2Eテストを実装するチームが、寄付者(Donor)やカウンターパート(Counterpart)をトランザクションに紐付けるテストケースを作成できるようにするため。**

現在のseedデータは「サンプル党」1件のみで、56件のトランザクションと多数のCounterpart・Donorが存在する。これは政治資金報告書XMLエクスポート機能のテストデータとして設計されており、E2Eテスト用途とは目的が異なる。

E2Eテスト用に、最小限の構成で以下を確認できるPoliticalOrganizationを新規追加する：
- 寄付者(Donor)を1つトランザクションに紐付けられること
- カウンターパート(Counterpart)を1つトランザクションに紐付けられること

## 現状のseedファイル構成

```
prisma/
├── seed.ts                      # メインエントリーポイント
└── seeds/
    ├── lib/
    │   └── types.ts             # Seederインターフェース定義
    ├── politicalOrganizations.ts  # 政治団体（1件）
    ├── reportProfiles.ts          # 報告書プロファイル（1件）
    ├── users.ts                   # ユーザー（2件）
    ├── counterparts.ts            # 取引先（45件）
    ├── donors.ts                  # 寄附者（13件）
    ├── transactions.ts            # 取引（56件）
    └── balanceSnapshots.ts        # 残高スナップショット（2件）
```

### 現在のデータ量

| エンティティ | 件数 | 備考 |
|-----------|------|------|
| Political Organizations | 1 | sample-party |
| Users | 2 | admin + user |
| Counterparts | 45 | 多様なカテゴリ |
| Donors | 13 | 個人7、法人4、政治団体2 |
| Transactions | 56 | 収入25件、支出31件 |
| Balance Snapshots | 2 | 2024年末、2025年末 |
| Organization Report Profiles | 1 | 2025年度分 |

## 追加するデータ設計

### E2Eテスト用Political Organization

| フィールド | 値 |
|-----------|-----|
| displayName | E2Eテスト団体 |
| slug | e2e-test-org |
| orgName | null |
| description | E2Eテスト用の最小構成政治団体 |

### E2Eテスト用Counterpart（1件）

| フィールド | 値 |
|-----------|-----|
| name | E2Eテスト取引先株式会社 |
| address | 東京都渋谷区テスト一丁目1番1号 |

### E2Eテスト用Donor（1件）

| フィールド | 値 |
|-----------|-----|
| name | E2Eテスト寄附太郎 |
| address | 東京都渋谷区テスト二丁目2番2号 |
| donorType | individual |
| occupation | テスト職業 |

### E2Eテスト用Transaction（2件）

**寄附トランザクション（Donor紐付け確認用）**

| フィールド | 値 |
|-----------|-----|
| transactionNo | E2E-0001 |
| transactionDate | 2025-06-01 |
| transactionType | income |
| debitAccount | 普通預金 |
| debitAmount | 50000 |
| creditAccount | 個人からの寄附 |
| creditAmount | 50000 |
| description | E2Eテスト個人寄附 |
| categoryKey | individual-donations |
| donorName | E2Eテスト寄附太郎 |
| donorAddress | 東京都渋谷区テスト二丁目2番2号 |
| donorType | individual |

**支出トランザクション（Counterpart紐付け確認用）**

| フィールド | 値 |
|-----------|-----|
| transactionNo | E2E-0002 |
| transactionDate | 2025-06-15 |
| transactionType | expense |
| debitAccount | 備品・消耗品費 |
| debitAmount | 30000 |
| creditAccount | 普通預金 |
| creditAmount | 30000 |
| description | E2Eテスト備品購入 |
| categoryKey | equipment-supplies |
| counterpartName | E2Eテスト取引先株式会社 |

## 実装方針

### transactions.ts の修正

現在、`transactionsSeeder` は `sample-party` をハードコードで参照している。これを複数orgに対応させるため、データに `orgSlug` フィールドを追加する。

```typescript
interface TransactionSeedData {
  orgSlug: string;  // 追加
  transactionNo: string;
  // ...
}

const data: TransactionSeedData[] = [
  // 既存のsample-party用データ
  {
    orgSlug: 'sample-party',
    transactionNo: 'T2025-0001',
    // ...
  },
  // E2Eテスト用データ
  {
    orgSlug: 'e2e-test-org',
    transactionNo: 'E2E-0001',
    // ...
  },
];
```

seeder実行時は `orgSlug` でorganizationを都度取得する形に変更する。

### 他のseedファイルの修正

- `politicalOrganizations.ts`: E2Eテスト団体を追加
- `counterparts.ts`: E2Eテスト取引先を追加
- `donors.ts`: E2Eテスト寄附者を追加
- `balanceSnapshots.ts`: 既に `organizationSlug` フィールドを持っているため、データ追加のみ（オプション）
- `reportProfiles.ts`: E2EテストではreportProfileは不要なため追加しない

## テストケースで確認できること

今回の設計で、以下のE2Eテストが作成可能になる：

1. **Donor紐付けテスト**
   - `e2e-test-org` の transaction `E2E-0001` を取得
   - `transactionDonors` リレーションを確認
   - 紐付いた Donor が `E2Eテスト寄附太郎` であることを検証

2. **Counterpart紐付けテスト**
   - `e2e-test-org` の transaction `E2E-0002` を取得
   - `transactionCounterparts` リレーションを確認
   - 紐付いた Counterpart が `E2Eテスト取引先株式会社` であることを検証

## ファイル変更一覧

| ファイル | 変更内容 |
|---------|---------|
| `prisma/seeds/politicalOrganizations.ts` | E2Eテスト団体を追加 |
| `prisma/seeds/counterparts.ts` | E2Eテスト取引先を追加（共有エンティティのため構造変更なし） |
| `prisma/seeds/donors.ts` | E2Eテスト寄附者を追加（共有エンティティのため構造変更なし） |
| `prisma/seeds/transactions.ts` | 下記参照 |
| `prisma/seeds/balanceSnapshots.ts` | （オプション）E2Eテスト団体の残高スナップショット追加 |

### transactions.ts の変更詳細

**既存データへの影響:**
- 既存の sample-party 用トランザクションデータ **56件全て** に `orgSlug: 'sample-party'` を追加する必要がある

**実装順序:**

1. **Step 1: インターフェース変更 + 既存データ修正**
   - `TransactionSeedData` インターフェースに `orgSlug: string` フィールドを追加
   - 既存56件のトランザクションデータ全てに `orgSlug: 'sample-party'` を付与
   - seeder の org 取得ロジックを `orgSlug` ベースに変更

2. **Step 2: E2Eテスト用データ追加**
   - E2Eテスト用トランザクション2件を追加（`orgSlug: 'e2e-test-org'`）
