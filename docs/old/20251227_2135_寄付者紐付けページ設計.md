# 寄付者（Donor）紐付けページ設計

## 概要

政治資金報告書の寄附・パーティー収入取引において、寄付者（Donor）情報を紐付けるためのUIを提供するページの設計。

## 背景

[docs/20251224_1500_donorテーブル設計.md](20251224_1500_donorテーブル設計.md) でDonorテーブルの設計・実装が完了している。本設計では、既存の取引先（Counterpart）紐付けページ `/assign/counterparts` のUI構成に準拠しつつ、Donor特有の要件（donor_type、職業情報）を反映した `/assign/donor` ページを設計する。

## 要件

1. `/assign/donor` でDonor紐付け対象の取引一覧を表示
2. 既存Donorを選択して取引に紐付け可能
3. 新規Donorを作成して取引に紐付け可能
4. donor_type（individual/corporation/political_organization）に応じた入力フォーム
5. UIは `/assign/counterparts` と統一感を持たせる
6. 複数取引への一括紐付けをサポート

## Donor紐付け対象のカテゴリ

Donorが紐付け可能な取引カテゴリ（[donorテーブル設計](20251224_1500_donorテーブル設計.md) より）:

| category_key | 日本語名 | 許可されるdonor_type |
|--------------|----------|---------------------|
| `individual-donations` | 個人からの寄附 | individual のみ |
| `specific-individual-donations` | 個人からの寄附（特定寄附） | individual のみ |
| `corporate-donations` | 法人その他の団体からの寄附 | corporation のみ |
| `political-donations` | 政治団体からの寄附 | political_organization のみ |
| `mediated-donations` | 寄附のあっせんによるもの | すべて |
| `party-income` | 政治資金パーティーの対価に係る収入 | すべて |
| `mediated-party-income` | 政治資金パーティー対価のあっせんによるもの | すべて |

## ドメインモデル

### Donor紐付けルール（新規追加）

[counterpart-assignment-rules.ts](../admin/src/server/contexts/report/domain/models/counterpart-assignment-rules.ts) と同様のアプローチで、Donor紐付けルールを定義する。

```
admin/src/server/contexts/report/domain/models/donor-assignment-rules.ts
```

**責務:**
- Donor紐付け対象カテゴリの定義
- カテゴリごとに許可されるdonor_typeの判定
- トランザクションがDonor紐付け対象かどうかの判定

### TransactionWithDonor（新規追加）

[transaction-with-counterpart.ts](../admin/src/server/contexts/report/domain/models/transaction-with-counterpart.ts) と同様のドメインモデル。

```
admin/src/server/contexts/report/domain/models/transaction-with-donor.ts
```

**属性:**
- トランザクション基本情報（id, transactionDate, debitAmount, description, categoryKey）
- 紐付いたDonor情報（nullable）

### Donor（新規追加）

Donorエンティティの型定義。

```
admin/src/server/contexts/report/domain/models/donor.ts
```

**属性:**
- id: string
- donorType: 'individual' | 'corporation' | 'political_organization'
- name: string
- address: string | null
- occupation: string | null（individualの場合のみ）
- createdAt: Date
- updatedAt: Date

## ドメインサービス

### DonorBulkAssignmentValidator（新規追加）

複数取引への一括Donor紐付け時の整合性チェックを担当するドメインサービス。

```
admin/src/server/contexts/report/domain/services/donor-bulk-assignment-validator.ts
```

**責務:**
- 複数取引のcategory_keyから許可されるdonor_typeの集合を算出
- 選択されたDonorのdonor_typeが全取引で許可されているかを検証
- ビジネスルールをドメイン層に集約し、再利用可能にする

**インターフェース:**
```typescript
interface BulkAssignmentValidationResult {
  isValid: boolean;
  allowedDonorTypes: DonorType[];  // 全取引で共通して許可されるdonor_type
  errors: BulkAssignmentValidationError[];
}

interface BulkAssignmentValidationError {
  type: 'incompatible_categories' | 'donor_type_mismatch';
  message: string;
  details: {
    transactionIds?: string[];
    categoryKeys?: string[];
    donorType?: DonorType;
  };
}

class DonorBulkAssignmentValidator {
  /**
   * 複数取引のカテゴリ整合性をチェックし、許可されるdonor_typeを算出
   */
  validateCategoryCompatibility(
    transactions: TransactionWithDonor[]
  ): BulkAssignmentValidationResult;

  /**
   * 指定されたDonorが全取引に紐付け可能かをチェック
   */
  validateDonorAssignment(
    transactions: TransactionWithDonor[],
    donor: Donor
  ): BulkAssignmentValidationResult;
}
```

**ロジック詳細:**

1. **カテゴリ整合性チェック** (`validateCategoryCompatibility`)
   - 各取引のcategory_keyから許可されるdonor_typeの集合を取得（donor-assignment-rulesを利用）
   - 全取引の許可donor_typeの積集合を算出
   - 積集合が空の場合、`incompatible_categories`エラーを返す

2. **Donor紐付け可能性チェック** (`validateDonorAssignment`)
   - まずカテゴリ整合性をチェック
   - Donorのdonor_typeが許可donor_typeに含まれるかをチェック
   - 含まれない場合、`donor_type_mismatch`エラーを返す

**使用例:**
```typescript
// BulkAssignDonorUsecase内での使用
const validator = new DonorBulkAssignmentValidator();
const result = validator.validateDonorAssignment(transactions, donor);

if (!result.isValid) {
  return { success: false, errors: result.errors };
}

// 紐付け実行
await transactionDonorRepository.bulkAssign(transactionIds, donorId);
```

## アーキテクチャ構成

admin のBounded Context/レイヤードアーキテクチャに従い、以下の構成とする。

### レイヤー構成

```
admin/src/server/contexts/report/
├── presentation/
│   ├── loaders/
│   │   ├── donors-loader.ts                      # 全Donor一覧取得
│   │   └── transactions-with-donors-loader.ts    # Donor紐付け対象取引一覧
│   └── actions/
│       ├── create-donor.ts                       # Donor新規作成
│       ├── assign-donor.ts                       # 単一取引へのDonor紐付け
│       └── bulk-assign-donor.ts                  # 複数取引への一括Donor紐付け
├── application/
│   └── usecases/
│       ├── get-transactions-with-donors-usecase.ts
│       ├── manage-donor-usecase.ts               # create/update/delete
│       ├── assign-donor-usecase.ts
│       └── bulk-assign-donor-usecase.ts
├── domain/
│   ├── models/
│   │   ├── donor.ts
│   │   ├── donor-assignment-rules.ts
│   │   └── transaction-with-donor.ts
│   ├── services/
│   │   └── donor-bulk-assignment-validator.ts  # 一括紐付け整合性チェック
│   └── repositories/
│       ├── donor-repository.interface.ts
│       └── transaction-donor-repository.interface.ts
└── infrastructure/
    └── repositories/
        ├── prisma-donor.repository.ts
        └── prisma-transaction-donor.repository.ts
```

### クライアントコンポーネント構成

```
admin/src/client/components/
├── donor-assignment/
│   ├── DonorAssignmentClient.tsx                 # メインクライアントコンポーネント
│   ├── DonorAssignmentFilters.tsx                # フィルタUI
│   ├── TransactionWithDonorTable.tsx             # 取引一覧テーブル
│   └── AssignDonorDialog.tsx                     # 紐付けダイアログ
└── donors/
    ├── DonorFormContent.tsx                      # Donor作成・編集フォーム
    └── DonorSelectorContent.tsx                  # 既存Donor選択UI
```

## ページ構成

### URL: `/assign/donor`

**ファイル:** `admin/src/app/(auth)/assign/donor/page.tsx`

### 検索パラメータ

Counterpart紐付けページと同様のパラメータ構成:

| パラメータ | 型 | 説明 |
|-----------|---|------|
| `orgId` | string | 政治団体ID |
| `year` | number | 報告年（西暦） |
| `unassigned` | boolean | 未紐付けのみ表示（デフォルト: true） |
| `category` | string | カテゴリフィルタ |
| `search` | string | 検索クエリ |
| `sort` | string | ソート対象フィールド |
| `order` | 'asc' \| 'desc' | ソート順 |
| `page` | number | ページ番号 |

### UI構成

```
┌─────────────────────────────────────────────────────────────┐
│ 寄付者紐付け管理                          [マスタ管理へ →] │
│ Transactionに対してDonor（寄付者）を紐付けます             │
├─────────────────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ [政治団体選択]          [報告年: 2024]                  │ │
│ └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│ [カテゴリ: すべて ▼] [検索: ________]                       │
│ [✓] 未紐付けのみ                                            │
├─────────────────────────────────────────────────────────────┤
│ XX件のTransaction                                           │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ [選択中: N件]  [一括紐付け] [選択解除]                   │ │
│ └─────────────────────────────────────────────────────────┘ │
│ ┌───┬────────┬─────────┬─────────┬──────────┬────────────┐ │
│ │[ ]│ 日付   │ 金額    │カテゴリ │ 摘要     │ 寄付者     │ │
│ ├───┼────────┼─────────┼─────────┼──────────┼────────────┤ │
│ │[✓]│2024/01 │ ¥10,000 │個人寄附 │ 田中太郎 │ [紐付け]   │ │
│ │[ ]│2024/02 │¥100,000 │法人寄附 │ 株式会社A│ 株式会社A  │ │
│ │...│        │         │         │          │            │ │
│ └───┴────────┴─────────┴─────────┴──────────┴────────────┘ │
│ [< 前] [1] [2] [3] ... [次 >]                               │
└─────────────────────────────────────────────────────────────┘
```

## 紐付けダイアログ

### 構成

```
┌─────────────────────────────────────────────────────────────┐
│ 寄付者を紐付け                                        [×]  │
├─────────────────────────────────────────────────────────────┤
│ ┌─────────────────┐ ┌─────────────────────────────────────┐ │
│ │ 取引情報        │ │ [既存から選択] [新規作成]           │ │
│ │ ─────────────── │ │                                     │ │
│ │ 2024/01/15      │ │ ┌─────────────────────────────────┐ │ │
│ │ ¥10,000         │ │ │ 寄付者種別を選択:               │ │ │
│ │ 個人からの寄附  │ │ │ [●個人] [○法人] [○政治団体]   │ │ │
│ │ 田中太郎        │ │ │                                 │ │ │
│ │                 │ │ │ 氏名/名称: ________________     │ │ │
│ │                 │ │ │ 住所:      ________________     │ │ │
│ │                 │ │ │ 職業:      ________________     │ │ │
│ │                 │ │ │ (individualの場合のみ表示)       │ │ │
│ │                 │ │ └─────────────────────────────────┘ │ │
│ │                 │ │                                     │ │
│ │                 │ │ [キャンセル]  [作成して紐づける]    │ │
│ └─────────────────┘ └─────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### donor_type制約の反映

取引のcategory_keyに応じて、選択可能なdonor_typeを制限する:

| category_key | UIでの挙動 |
|--------------|-----------|
| `individual-donations`, `specific-individual-donations` | donor_type選択を非表示、個人（individual）固定 |
| `corporate-donations` | donor_type選択を非表示、法人（corporation）固定 |
| `political-donations` | donor_type選択を非表示、政治団体（political_organization）固定 |
| `mediated-donations`, `party-income`, `mediated-party-income` | donor_type選択を表示、すべて選択可能 |

### 既存Donor選択時のフィルタリング

- カテゴリに応じたdonor_type制限がある場合、該当するdonor_typeのDonorのみを候補として表示
- 例: `individual-donations` の取引では、donor_type='individual'のDonorのみ表示

## リポジトリインターフェース

### DonorRepository

```
admin/src/server/contexts/report/domain/repositories/donor-repository.interface.ts
```

**メソッド:**
- `findAll(): Promise<Donor[]>` - 全Donor取得
- `findById(id: string): Promise<Donor | null>` - ID指定取得
- `findByType(donorType: DonorType): Promise<Donor[]>` - donor_type指定取得
- `create(input: CreateDonorInput): Promise<Donor>` - 新規作成
- `exists(name: string, address: string | null, donorType: DonorType): Promise<boolean>` - 重複チェック

### TransactionDonorRepository

```
admin/src/server/contexts/report/domain/repositories/transaction-donor-repository.interface.ts
```

**メソッド:**
- `findByTransactionId(transactionId: string): Promise<TransactionDonor | null>`
- `assign(transactionId: string, donorId: string): Promise<void>`
- `unassign(transactionId: string): Promise<void>`
- `bulkAssign(transactionIds: string[], donorId: string): Promise<void>`

### ReportTransactionRepository（既存拡張）

Donor紐付け対象取引の取得メソッドを追加:

**追加メソッド:**
- `findTransactionsWithDonors(filter: TransactionWithDonorFilter): Promise<{ transactions: TransactionWithDonor[]; total: number }>`

**TransactionWithDonorFilter:**
```typescript
interface TransactionWithDonorFilter {
  politicalOrganizationId: string;
  financialYear: number;
  unassignedOnly?: boolean;
  categoryKey?: string;
  searchQuery?: string;
  page?: number;
  perPage?: number;
  sortField?: 'transactionDate' | 'debitAmount' | 'categoryKey';
  sortOrder?: 'asc' | 'desc';
}
```

## Usecase

### GetTransactionsWithDonorsUsecase

**責務:** Donor紐付け対象取引一覧の取得

**入力:** TransactionWithDonorFilter
**出力:** { transactions: TransactionWithDonor[]; total: number; page: number; perPage: number }

### ManageDonorUsecase

**責務:** Donor CRUD操作

**操作:**
- create: 新規Donor作成（重複チェック含む）
- update: Donor更新
- delete: Donor削除

### AssignDonorUsecase

**責務:** 単一取引へのDonor紐付け

**入力:** { transactionId: string; donorId: string }
**処理:**
1. 取引の存在確認
2. Donorの存在確認
3. 取引のcategory_keyとDonorのdonor_typeの整合性チェック（ドメインルールに委譲）
4. 紐付け実行

### BulkAssignDonorUsecase

**責務:** 複数取引への一括Donor紐付け

**入力:** { transactionIds: string[]; donorId: string }
**処理:**
1. 全取引の存在確認
2. Donorの存在確認
3. **DonorBulkAssignmentValidator（Domain Service）を呼び出して整合性チェック**
   - カテゴリ整合性チェック
   - donor_type整合性チェック
4. バリデーションエラーがあればResult型でエラーを返す
5. 一括紐付け実行（トランザクション内で処理）

**依存:** DonorBulkAssignmentValidator, TransactionDonorRepository, DonorRepository

## Server Action

### createDonorAction

**ファイル:** `admin/src/server/contexts/report/presentation/actions/create-donor.ts`

**入力:**
```typescript
interface CreateDonorInput {
  donorType: 'individual' | 'corporation' | 'political_organization';
  name: string;
  address: string | null;
  occupation: string | null;  // individualの場合のみ必須
}
```

**バリデーション:**
- name: 必須、120文字以内
- address: 120文字以内（optional）
- occupation: individualの場合のみ必須、50文字以内
- donorType: 3種類のいずれか

### assignDonorAction

**ファイル:** `admin/src/server/contexts/report/presentation/actions/assign-donor.ts`

**入力:** transactionId: string, donorId: string

### bulkAssignDonorAction

**ファイル:** `admin/src/server/contexts/report/presentation/actions/bulk-assign-donor.ts`

**入力:** transactionIds: string[], donorId: string

## Loader

### loadAllDonorsData

**ファイル:** `admin/src/server/contexts/report/presentation/loaders/donors-loader.ts`

**出力:** Donor[]

### loadTransactionsWithDonorsData

**ファイル:** `admin/src/server/contexts/report/presentation/loaders/transactions-with-donors-loader.ts`

**入力:** TransactionWithDonorFilter
**出力:** { transactions: TransactionWithDonor[]; total: number; page: number; perPage: number }

## 一括紐付け時の整合性チェック

複数取引を選択して一括紐付けする場合、以下をチェック:

1. **カテゴリ整合性**: 選択された取引のcategory_keyがすべて同じdonor_type制約を持つこと
   - 例: `individual-donations` と `corporate-donations` を同時選択した場合はエラー
   - 例: `individual-donations` と `mediated-donations` の組み合わせは可能（mediated-donationsは制約なし）

2. **donor_type整合性**: 選択したDonorのdonor_typeが、選択された全取引のカテゴリで許可されていること

### レイヤー別の責務

整合性チェックは**UI層**と**Domain Service層**の両方で実装する:

```
┌─────────────────────────────────────────────────────────────┐
│ UI層 (DonorAssignmentClient.tsx)                            │
│ - 選択された取引のcategory_keyを見て一括紐付けボタン制御     │
│ - UX向上のための早期フィードバック（親切機能）              │
│ - donor-assignment-rulesを参照してクライアント側で判定      │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│ Presentation層 (bulk-assign-donor.ts)                       │
│ - Server Action、usecaseを呼び出すだけ                      │
│ - バリデーションロジックは持たない                          │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│ Application層 (bulk-assign-donor-usecase.ts)                │
│ - Domain Serviceを呼び出して整合性チェック                   │
│ - 整合性エラーがあればResult型で返す                        │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│ Domain層 (donor-bulk-assignment-validator.ts)               │
│ - 複数取引のカテゴリ整合性チェック                          │
│ - donor_typeと各取引カテゴリの整合性チェック                │
│ - ビジネスルールの単一責任・再利用可能                      │
└─────────────────────────────────────────────────────────────┘
```

**設計の意図:**
- **UI層**: ユーザー体験向上のため、不正な組み合わせを選択した時点で即座にフィードバック
- **Domain Service層**: ビジネスルールの正式な実装場所。UIをバイパスされても（API直接呼び出し等）ルールが守られる
- 両層で同じルール（donor-assignment-rules）を参照することで、判定ロジックの一貫性を保証

## Counterpartページとの差分

| 観点 | Counterpart紐付け | Donor紐付け |
|------|------------------|-------------|
| 対象取引 | expense系 + 一部income（loans, grants） | 寄附・パーティー収入系 |
| 種別管理 | なし | donor_type（3種類） |
| 追加属性 | なし | occupation（individualのみ） |
| カテゴリ制約 | なし | カテゴリごとにdonor_type制限あり |
| 閾値 | 経常経費10万円、政治活動費5万円 | なし（すべて記載対象） |

## 参考

- [donorテーブル設計](20251224_1500_donorテーブル設計.md)
- [counterpartテーブル設計](20251215_1053_counterpartテーブル設計.md)
- [admin アーキテクチャガイド](admin-architecture-guide.md)
- [政治資金収支報告書XMLフォーマット](docs/reference/report-format.md)
