# シート13交付金列とシート16整合性修正設計

## 1. 概要

### 1.1 問題の背景

ExcelテンプレートでXMLをインポートした際、シート16（その16: 本部又は支部に対する交付金の支出）でE184バリデーションエラーが発生する。

エラーメッセージ:
> 合計金額が「その13」シート（支出項目別金額の内訳）の「経常経費小計（本部又は支部に対して供与した交付金に係る支出）」と「政治活動費小計（本部又は支部に対して供与した交付金に係る支出）」の合計金額と一致しません（E184）

### 1.2 現状の問題

現在の実装では:
- シート16の合計金額（KINGAKU_GK）: 本支部交付金の合計（例: 1,500,000円）
- シート13のKOUFU列（KEIHI_SKEI_KOUFU, KATUDOU_SKEI_KOUFU）: 常にnull（空タグ）

E184バリデーションは以下の整合性を検証している:
```
シート16.KINGAKU_GK = シート13.KEIHI_SKEI_KOUFU + シート13.KATUDOU_SKEI_KOUFU
```

現状はKOUFU列が常にnullのため、シート16にデータがあると必ずエラーになる。

---

## 2. KOUFU列の意味の再解釈

### 2.1 既存設計での理解（誤り）

既存の設計ドキュメントでは、KOUFU列を「各支出項目のうち交付金（本部からもらったお金）を財源として支出した額」と解釈していた。

この解釈に基づき、財源トラッキング機能が未実装のため常にnullとしていた。

### 2.2 正しい解釈

Excelテンプレートの注釈およびバリデーション（E184）から判明した正しい意味:

> （注2）支出項目ごとの金額のうち、当該政治団体の本部または支部に対して供与した交付金に係る支出があった場合には、その額を「本部又は支部に対して供与した交付金に係る支出」欄に入力します。この金額の明細は、「第14号様式（その16）」の「本部又は支部に対して供与した交付金に係る支出の内訳」で入力してください。

**KOUFU列 = 「本部又は支部に対して供与した交付金に係る支出」の金額**

つまり、シート16で明細として記載される「本支部交付金」の合計額を、シート13のKOUFU列に計上する必要がある。

### 2.3 KOUFU列の入力粒度

Excelテンプレートの注釈では「支出項目ごとの金額のうち」とあり、支出項目ごとにKOUFU列を設定できる。しかし、E184バリデーションがチェックしているのは**小計レベルの整合性のみ**である。

ExcelテンプレートのVBAコード（`data/reports/syushi_soft_vba.txt` 1645-1660行目）で確認した検証ロジック:

```vba
'その13!KEIHI_SKEI_KOUFU + その13!KATUDOU_SKEI_KOUFU = その16!KINGAKU_GK でなければエラー
If rngCheck1.value + rngCheck2.value <> rngCheck3.value Then
    '対象シートのエラーフラグ設定
    Call setComment(wsSheet1, rngCheck1, MESSAGE_E183)
    Call setComment(wsSheet1, rngCheck2, MESSAGE_E183)
    Call setComment(wsSheet2, rngCheck3, MESSAGE_E184)
```

この検証により:
- **E183**: シート13側に表示されるエラー（KEIHI_SKEI_KOUFU, KATUDOU_SKEI_KOUFUの両方にコメント）
- **E184**: シート16側に表示されるエラー（KINGAKU_GKにコメント）

支出項目ごとの個別KOUFU列（`SOSIKI_KOUFU`など）は、入力があれば小計に合算されるが、シート16の明細との個別対応はチェックされない。

**採用する方針**: 支出項目ごとのKOUFU列は空タグとし、小計のKOUFU列（`KATUDOU_SKEI_KOUFU`）にシート16の合計額を計上する。

### 2.4 シート13とシート16の関係

| シート | 役割 |
|--------|------|
| シート13 | 支出項目別金額の内訳（総括表）。各支出項目の金額（GK列）と本支部交付金額（KOUFU列）を記載 |
| シート16 | 本部又は支部に対する交付金の支出の明細。支出先ごとの詳細を記載 |

**整合性ルール**:
- シート13の `KEIHI_SKEI_KOUFU + KATUDOU_SKEI_KOUFU` = シート16の `KINGAKU_GK`

---

## 3. 修正方針

### 3.1 本支部交付金の分類

本支部交付金（`branch-grants-expenses`カテゴリ）は、政治活動費の一部として分類される。

- 経常経費には本支部交付金に該当する項目がない
- 本支部交付金は政治活動費の「寄附・交付金」（KUBUN8）と性質が近いが、別カテゴリとして独立

### 3.2 KOUFU列への計上ルール

シート16の本支部交付金合計額を、シート13の `KATUDOU_SKEI_KOUFU`（政治活動費小計の交付金列）に計上する。

| 項目 | 計上先 |
|------|--------|
| KEIHI_SKEI_KOUFU（経常経費小計の交付金） | 0（本支部交付金は経常経費に該当しない） |
| KATUDOU_SKEI_KOUFU（政治活動費小計の交付金） | シート16の合計金額 |

### 3.3 各支出項目のKOUFU列

各支出項目の個別KOUFU列（例: `KIFU_KOUFU`）については、現状のデータ構造では本支部交付金がどの支出項目から支出されたかを特定できないため、以下の方針とする:

- 個別項目のKOUFU列: 引き続きnull（空タグ）
- 小計のKOUFU列: 合計値を計上

この方針は、小計の整合性さえ取れていればE184エラーは発生しないことを前提とする。

---

## 4. データフロー

### 4.1 現状のデータフロー

```
ExpenseData
├── branchGrantExpenses: BranchGrantExpenseSection
│   └── totalAmount: number  ─────────────────────────► シート16.KINGAKU_GK
└── (その他の支出セクション)

ExpenseSummaryData.fromExpenseData(expenseData)
├── regularExpenses.subtotal.grantAmount: null  ─────► シート13.KEIHI_SKEI_KOUFU (空タグ)
└── politicalActivityExpenses.subtotal.grantAmount: null ─► シート13.KATUDOU_SKEI_KOUFU (空タグ)
```

### 4.2 修正後のデータフロー

```
ExpenseData
├── branchGrantExpenses: BranchGrantExpenseSection
│   └── totalAmount: number  ─────────────────────────► シート16.KINGAKU_GK
└── (その他の支出セクション)

ExpenseSummaryData.fromExpenseData(expenseData)
├── regularExpenses.subtotal.grantAmount: 0  ─────────► シート13.KEIHI_SKEI_KOUFU
└── politicalActivityExpenses.subtotal.grantAmount: branchGrantExpenses.totalAmount
                                                      ► シート13.KATUDOU_SKEI_KOUFU
```

---

## 5. 変更対象

### 5.1 ドメインモデル

**ファイル**: `admin/src/server/contexts/report/domain/models/expense-summary.ts`

`ExpenseSummaryData.fromExpenseData` メソッドを修正:
- `regularExpenses.subtotal.grantAmount`: 0を設定（nullではなく）
- `politicalActivityExpenses.subtotal.grantAmount`: `expenseData.branchGrantExpenses.totalAmount`を設定

### 5.2 シリアライザ

**ファイル**: `admin/src/server/contexts/report/domain/services/expense-summary-serializer.ts`

現状の `serializeGrantTag` は `grantAmount` がnullの場合に空タグを出力する。修正後は0以上の値が渡されるため、変更不要。

### 5.3 テスト

**ファイル**: `admin/tests/server/contexts/report/domain/models/expense-summary.test.ts`

テストケースを追加・修正:
- `branchGrantExpenses`がある場合、`KATUDOU_SKEI_KOUFU`に合計額が設定されることを確認
- `branchGrantExpenses`がない（totalAmount=0）場合、`KATUDOU_SKEI_KOUFU`が0になることを確認

---

## 6. 整合性検証

### 6.1 E184バリデーションの満足

修正後:
```
シート13.KEIHI_SKEI_KOUFU = 0
シート13.KATUDOU_SKEI_KOUFU = branchGrantExpenses.totalAmount
シート16.KINGAKU_GK = branchGrantExpenses.totalAmount

→ KEIHI_SKEI_KOUFU + KATUDOU_SKEI_KOUFU = KINGAKU_GK ✓
```

### 6.2 シードデータでの検証

現在のシードデータ:
- T2025-0048: 1,000,000円（活動費交付金）
- T2025-0049: 500,000円（選挙応援交付金）
- 合計: 1,500,000円

修正後の出力:
- シート13.KATUDOU_SKEI_KOUFU: 1,500,000
- シート16.KINGAKU_GK: 1,500,000
- 整合性: OK

---

## 7. 参考資料

- [docs/20251227_1722_SYUUSHI07_13_支出項目別金額内訳実装設計.md](20251227_1722_SYUUSHI07_13_支出項目別金額内訳実装設計.md) - 既存の設計ドキュメント
- [docs/reference/report-format.md](docs/reference/report-format.md) - XML仕様
