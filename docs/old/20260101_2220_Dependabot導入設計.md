# Dependabot導入設計

## 目的

開発者が依存パッケージの更新を手動で追跡・適用する負担を軽減し、セキュリティパッチや機能改善を継続的に取り込める状態にするため。

## 背景

- 現在、依存パッケージの更新は手動で行う必要がある
- セキュリティ脆弱性の発見時に対応が遅れるリスクがある
- 一方で、無秩序な自動更新は表示崩れなどの問題を引き起こす可能性がある

## 設計方針

### 自動マージポリシー

| ディレクトリ | パッケージ | patch | minor | major |
|-------------|-----------|-------|-------|-------|
| root | 全般 | 自動 | 自動 | 手動 |
| admin | 全般 | 自動 | 自動 | 手動 |
| webapp | 通常 | 自動 | 自動 | 手動 |
| webapp | charts（apexcharts, react-apexcharts, @nivo/*） | 自動 | **手動** | 手動 |

- webapp は公開中のため、チャートライブラリ（apexcharts, react-apexcharts, @nivo/*）の minor 以上は手動レビューとする
- admin は内部向けのため、minor まで自動マージを許容する

### PR作成頻度

- 週1回（毎週土曜日 9:00 JST）
- 各ディレクトリで最大5件のPRまで

### グループ化

関連パッケージを1つのPRにまとめることで、PR数を削減しレビュー負荷を下げる。

| ディレクトリ | グループ名 | 対象パッケージ |
|-------------|-----------|---------------|
| root | prisma | prisma, @prisma/client |
| root | supabase | @supabase/supabase-js |
| root | dev-dependencies | devDependencies 全般（biome, concurrently, knip, lint-staged, tsx など） |
| admin | radix-ui | @radix-ui/* |
| admin | tanstack | @tanstack/react-table |
| admin | ai-sdk | ai, @ai-sdk/anthropic |
| admin | supabase | @supabase/ssr, @supabase/supabase-js |
| admin | dev-dependencies | devDependencies 全般（jest, tailwindcss, postcss, ts-jest など） |
| webapp | nivo | @nivo/sankey |
| webapp | dev-dependencies | devDependencies 全般（jest, tailwindcss, postcss, ts-jest など） |

## ファイル構成

```
.github/
├── dependabot.yml              # Dependabot設定
└── workflows/
    ├── ci.yml                  # 既存（変更なし）
    └── dependabot-auto-merge.yml  # 新規：自動マージ用
```

## 設定ファイル

### .github/dependabot.yml

```yaml
version: 2
updates:
  # ルートのpackage.json
  # dependencies: @prisma/client, @supabase/supabase-js, dotenv
  # devDependencies: @biomejs/biome, concurrently, dependency-cruiser, dotenv-cli,
  #                  knip, lint-staged, prisma, simple-git-hooks, supabase, tsx, typescript
  - package-ecosystem: "npm"
    directory: "/"
    schedule:
      interval: "weekly"
      day: "saturday"
      time: "09:00"
      timezone: "Asia/Tokyo"
    open-pull-requests-limit: 5
    groups:
      prisma:
        patterns:
          - "prisma"
          - "@prisma/client"
      supabase:
        patterns:
          - "@supabase/supabase-js"
          - "supabase"
      dev-dependencies:
        dependency-type: "development"

  # admin
  # dependencies: @ai-sdk/anthropic, @prisma/client, @radix-ui/*, @supabase/ssr,
  #               @supabase/supabase-js, @tanstack/react-table, @vercel/speed-insights,
  #               ai, class-variance-authority, clsx, iconv-lite, lucide-react, next,
  #               react, react-dom, sonner, tailwind-merge, xmlbuilder2, zod
  # devDependencies: @tailwindcss/postcss, @types/*, jest, postcss, tailwindcss, ts-jest, typescript
  - package-ecosystem: "npm"
    directory: "/admin"
    schedule:
      interval: "weekly"
      day: "saturday"
      time: "09:00"
      timezone: "Asia/Tokyo"
    open-pull-requests-limit: 5
    groups:
      radix-ui:
        patterns:
          - "@radix-ui/*"
      tanstack:
        patterns:
          - "@tanstack/react-table"
      ai-sdk:
        patterns:
          - "@ai-sdk/*"
          - "ai"
      supabase:
        patterns:
          - "@supabase/*"
      next-react:
        patterns:
          - "next"
          - "react"
          - "react-dom"
      dev-dependencies:
        dependency-type: "development"

  # webapp
  # dependencies: @next/third-parties, @nivo/sankey, @prisma/client, @vercel/speed-insights,
  #               apexcharts, critters, next, react, react-apexcharts, react-dom
  # devDependencies: @tailwindcss/postcss, @types/*, jest, postcss, tailwindcss, ts-jest, typescript
  - package-ecosystem: "npm"
    directory: "/webapp"
    schedule:
      interval: "weekly"
      day: "saturday"
      time: "09:00"
      timezone: "Asia/Tokyo"
    open-pull-requests-limit: 5
    groups:
      charts:
        patterns:
          - "apexcharts"
          - "react-apexcharts"
          - "@nivo/*"
      next-react:
        patterns:
          - "next"
          - "react"
          - "react-dom"
      dev-dependencies:
        dependency-type: "development"

  # GitHub Actions
  - package-ecosystem: "github-actions"
    directory: "/"
    schedule:
      interval: "weekly"
      day: "saturday"
      time: "09:00"
      timezone: "Asia/Tokyo"
```

### .github/workflows/dependabot-auto-merge.yml

```yaml
name: Dependabot Auto-merge

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'

    steps:
      - name: Fetch Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: Enable auto-merge for patch and minor updates
        if: |
          steps.metadata.outputs.update-type != 'version-update:semver-major' &&
          !(
            steps.metadata.outputs.directory == '/webapp' &&
            steps.metadata.outputs.update-type == 'version-update:semver-minor' &&
            (
              contains(steps.metadata.outputs.dependency-names, 'apexcharts') ||
              contains(steps.metadata.outputs.dependency-names, 'react-apexcharts') ||
              contains(steps.metadata.outputs.dependency-names, '@nivo/')
            )
          )
        run: gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

## 運用フロー

### 通常フロー（大半のケース）

```
月曜日
  ↓
Dependabot がグループ化されたPRを作成
  ↓
CI実行（lint, test, type-check）
  ↓
CI成功 かつ major以外 かつ 除外対象でない
  ↓
自動squash merge
  ↓
完了（対応不要）
```

### 手動対応が必要なケース

| ケース | 対応方法 |
|--------|---------|
| CI失敗 | エラー内容を確認し修正コミットを追加、または Close して次回に持ち越し |
| major更新 | CHANGELOGを確認し、breaking change に対応してから手動マージ |
| webapp の charts グループ（apexcharts, @nivo/*）の minor | 表示確認を行ってから手動マージ |
| セキュリティアラート | Dependabot が即座にPRを作成するので優先対応 |

## 導入時の設定

以下のリポジトリ設定が必要：

1. **Allow auto-merge を有効化**
   - Settings → General → Pull Requests → 「Allow auto-merge」にチェック

2. **Branch protection の確認**（任意だが推奨）
   - develop ブランチに対して「Require status checks to pass before merging」が設定されていれば、CIが通らない限り自動マージされない

## 補足

### なぜ週1回・土曜朝か

- daily: PRが多くなりすぎる
- monthly: 更新が溜まると一度の対応が大変になる
- weekly: バランスが良い
- 土曜朝: 土日に作業することが多いため、週末の作業開始時にPRを確認できる

### なぜ charts グループを除外するか

- チャートライブラリ（apexcharts, @nivo/sankey）はUIへの影響が大きい
- webappは公開中のサービスであり、表示崩れは避けたい
- minor でも描画ロジックの変更が入ることがある
