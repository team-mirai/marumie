# E2Eテスト拡充計画

## 目的

**開発者が**、admin管理画面の主要機能に対するE2Eテストを効率的に追加し、リグレッションを防止できるようにするため。

## 現状

### 既存のE2Eテスト

- `admin/e2e/tests/login.spec.ts` - ログイン機能
- `admin/e2e/tests/political-organizations.spec.ts` - 政治団体管理（一覧・作成・編集）

### adminアプリのページ一覧

| ページ | パス | 機能概要 | テスト有無 |
|--------|------|----------|-----------|
| ダッシュボード | `/` | Welcome画面 | - |
| ログイン | `/login` | 認証 | ✅ |
| 政治団体一覧 | `/political-organizations` | 一覧・新規作成・編集 | ✅ |
| 政治団体編集 | `/political-organizations/[orgId]` | 個別編集 | ✅ |
| 政治団体新規 | `/political-organizations/new` | 新規作成 | ✅ |
| 報告書プロフィール | `/political-organizations/[orgId]/report-profile` | 年度別プロフィール設定 | - |
| 取引一覧 | `/transactions` | 取引データ表示 | - |
| CSVアップロード | `/upload-csv` | CSV取り込み | - |
| 残高登録 | `/balance-snapshots` | 残高スナップショット管理 | - |
| 取引先マスタ | `/counterparts` | 取引先一覧・検索 | - |
| 取引先詳細 | `/counterparts/[id]` | 取引先の詳細・紐づき取引 | - |
| 寄付者マスタ | `/donors` | 寄付者一覧・検索 | - |
| 取引先紐付け | `/assign/counterparts` | 取引に取引先を紐付け | - |
| 寄付者紐付け | `/assign/donors` | 取引に寄付者を紐付け | - |
| 寄付者インポート | `/import-donors` | 寄付者CSV一括インポート | - |
| 報告書エクスポート | `/export-report/[orgId]/[year]` | XML生成・プレビュー | - |
| ユーザー管理 | `/users` | ユーザー一覧・ロール変更・招待 | - |
| ユーザー情報 | `/user-info` | ログインユーザー情報表示 | - |
| パスワードリセット | `/forgot-password` | パスワードリセット依頼 | - |
| パスワード再設定 | `/auth/reset-password` | 新パスワード設定 | - |
| 初期設定 | `/auth/setup` | 初回ログイン後の設定 | - |

## E2Eテストの分類

E2Eテストを以下の2種類に分類する（`/e2e`コマンドの設計に準拠）：

- **読み込みテスト**: ページ表示、既存データ読み込みの確認
- **書き込みテスト**: データ作成・更新フローの確認

## DBの並列実行に関する考慮事項

### 問題点

1. **書き込みテストの競合**: 同じテーブルに書き込むテストを並列実行すると、データ競合が発生する可能性がある
2. **シードデータの前提**: テストはシードデータ（`pnpm db:seed`）を前提としており、テスト実行中にデータが変更されると他のテストに影響する
3. **一意性制約**: slug等のユニーク制約があるフィールドで、並列実行時に衝突する可能性

### 解決策

以下の方針で並列実行の問題を回避する：

1. **読み込み専用テストは並列実行可能**: 既存データを読むだけなので競合しない
2. **書き込みテストは一意なデータを使用**: `Date.now()`でユニークなslug/名前を生成（既存テストと同様）
3. **異なるテーブルへの書き込みは並列可能**: 取引先と寄付者など、独立したテーブルへの書き込みは競合しない
4. **同一テーブルへの書き込みも基本的に並列可能**: 一意なデータを使えば問題ない

### Devinへの作業分担で考慮すべきこと

- **各issueは独立**: 各テストファイルは他のテストに依存しないため、並列で開発可能
- **マージ時の競合はない**: テストファイルは機能ごとに分離されているため、Git競合は発生しにくい
- **DB競合はCI時に注意**: CIでは `workers: 1` に設定済みなのでテスト自体の並列実行は問題ない

## 作業分担案

以下の順序でissueを作成し、Devinに並列で作業させることを推奨する。

### Phase 1: 読み込み専用テスト（並列実行可能）

これらは既存のシードデータを読むだけなので、完全に並列で開発・実行可能。

| # | テスト対象 | ファイル名 | 優先度 |
|---|-----------|-----------|--------|
| 1 | ダッシュボード | `dashboard.spec.ts` | 低 |
| 2 | 取引一覧 | `transactions.spec.ts` | 高 |
| 3 | 取引先マスタ | `counterparts.spec.ts` | 高 |
| 4 | 寄付者マスタ | `donors.spec.ts` | 高 |
| 5 | ユーザー情報 | `user-info.spec.ts` | 低 |

### Phase 2: 書き込みテスト（独立したテーブル）

異なるテーブルを操作するため、並列で開発・実行可能。

| # | テスト対象 | ファイル名 | 操作対象テーブル |
|---|-----------|-----------|-----------------|
| 6 | 報告書プロフィール | `report-profile.spec.ts` | ReportProfile |
| 7 | 残高登録 | `balance-snapshots.spec.ts` | BalanceSnapshot |
| 8 | ユーザー管理 | `users.spec.ts` | User |

### Phase 3: 紐付け・インポート機能（既存データに依存）

既存の取引・マスタデータへの紐付けを行うため、シードデータに依存する。ただし一意なテストデータを作成すれば並列可能。

| # | テスト対象 | ファイル名 | 備考 |
|---|-----------|-----------|------|
| 9 | 取引先紐付け | `counterpart-assignment.spec.ts` | 取引への取引先紐付け |
| 10 | 寄付者紐付け | `donor-assignment.spec.ts` | 取引への寄付者紐付け |
| 11 | 寄付者インポート | `import-donors.spec.ts` | CSVインポート |
| 12 | 取引先詳細 | `counterpart-detail.spec.ts` | 詳細画面・紐付け確認 |

### Phase 4: ファイル操作・エクスポート

外部ファイル操作を含むため、テスト環境の準備が必要。

| # | テスト対象 | ファイル名 | 備考 |
|---|-----------|-----------|------|
| 13 | CSVアップロード | `upload-csv.spec.ts` | テスト用CSVファイル必要 |
| 14 | 報告書エクスポート | `export-report.spec.ts` | XML生成確認 |

### Phase 5: 認証関連（慎重に）

認証フローはセッション管理に影響するため、最後に実施。

| # | テスト対象 | ファイル名 | 備考 |
|---|-----------|-----------|------|
| 15 | パスワードリセット | `password-reset.spec.ts` | メール送信はモック必要 |

## issue作成の推奨形式

各issueは以下の形式で作成する：

```markdown
## タスク
`/e2e {機能名}` コマンドでE2Eテストを作成する

## 対象ページ
- パス: `/xxx`
- 機能: 〇〇の一覧表示・検索

## テスト内容
### 読み込みテスト
- ページが正常に表示されるか
- 既存データが表示されるか

### 書き込みテスト（該当する場合）
- 新規作成フローが完了するか
- 更新フローが完了するか

## 参考
- 既存テスト: `admin/e2e/tests/political-organizations.spec.ts`
- コマンド: `.claude/commands/e2e.md`
```

## 推奨する並列度

- **同時実行可能なissue数**: 5〜6件
- **理由**: 各テストファイルは独立しており、Git競合も発生しにくい。DBへの書き込みは一意なデータを使うため競合しない。

## 実行順序の注意点

1. **Phase 1の読み込みテストを最初に着手**: これらは最も簡単で、並列実行しても問題ない
2. **Phase 2〜3は並列で進行可能**: 異なるテーブルを操作するため
3. **Phase 4のファイル操作は準備が必要**: テスト用のCSVファイルを用意する必要がある
4. **Phase 5の認証関連は最後に**: セッションへの影響を考慮

## まとめ

- 全14件のE2Eテストを追加対象として特定
- DBの並列実行問題は、一意なテストデータの使用で解決可能
- Devinへは5〜6件を同時にissueとして割り当て可能
- Phase 1（読み込みテスト5件）から着手するのが最もリスクが低い
