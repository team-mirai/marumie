# 取引先住所検索機能 設計ドキュメント

## 概要

政治資金報告書作成のため、取引先（Counterpart）の住所をLLMを活用して効率的に検索・入力する機能。

## ユースケース

### UC-1: 取引先の住所を検索する

**アクター**: 管理者（政治団体の会計担当者）

**事前条件**: 取引先（Counterpart）が登録済みで、住所が未入力

**基本フロー**:

1. ユーザーが取引先一覧から住所未入力の取引先を選択
2. 「住所を検索」ボタンをクリック
3. システムがLLM（+ Web検索）を使って住所候補を取得
4. システムが自信度順に上位5件の候補を表示（根拠情報付き）
5. ユーザーが候補を確認し、正しいものを選択
6. 選択した住所がCounterpartに保存される（既存の `updateCounterpartAction` を使用）

**代替フロー**:

- 3a. 候補が見つからない場合 → 手動入力を促す
- 5a. 正しい候補がない場合 → 手動で修正して保存

**事後条件**: Counterpartに住所が保存される

---

### UC-2: 業態ヒントを追加して再検索する

**事前条件**: UC-1で適切な候補が見つからなかった

**基本フロー**:

1. ユーザーが業態ヒントを入力（例: 「印刷」「IT」「広告」）
2. システムがヒントを含めて再検索
3. 絞り込まれた候補を表示
4. ユーザーが選択して保存

---

## UI設計

### 住所検索ダイアログ

```
┌─────────────────────────────────────────────────────────┐
│  住所検索: 株式会社アクセア                        [×]   │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  業態ヒント（任意）: [印刷業              ] [再検索]     │
│                                                         │
│  ─────────────────────────────────────────────────────  │
│                                                         │
│  検索結果（自信度順）                                    │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │ ◉ 候補1（自信度: 高）                            │   │
│  │   株式会社アクセア                               │   │
│  │   〒160-0023                                     │   │
│  │   東京都新宿区西新宿7-5-25 西新宿プライムスクエア  │   │
│  │                                                  │   │
│  │   根拠: 公式サイト https://accea.co.jp/company/  │   │
│  │                                    [Googleで確認]│   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │ ○ 候補2（自信度: 中）                            │   │
│  │   アクセア株式会社                               │   │
│  │   〒530-0001                                     │   │
│  │   大阪府大阪市北区梅田1-2-3                       │   │
│  │                                                  │   │
│  │   根拠: 法人番号データベース                      │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │ ○ 候補3（自信度: 低）                            │   │
│  │   ...                                            │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  [ ] 該当なし - 手動で入力する                          │
│                                                         │
│  ─────────────────────────────────────────────────────  │
│                                                         │
│  手動修正（選択した候補を編集可能）:                     │
│  会社名:   [株式会社アクセア                    ]        │
│  郵便番号: [160-0023   ]                                │
│  住所:     [東京都新宿区西新宿7-5-25 西新宿プライムスクエア] │
│                                                         │
├─────────────────────────────────────────────────────────┤
│                          [キャンセル]  [この住所を保存]  │
└─────────────────────────────────────────────────────────┘
```

### UI要素の説明

| 要素 | 説明 |
|------|------|
| 業態ヒント | 同名企業がある場合に絞り込むための補助情報 |
| 自信度 | LLMが判断した確度（高/中/低） |
| 根拠 | 情報源URL、または「法人番号DB」「LLM知識」等 |
| Googleで確認 | 会社名+住所でGoogle検索を新規タブで開く（人間による検証用） |
| 手動修正欄 | 候補を選択後、微修正して保存できる |

---

## 技術構成

### アーキテクチャ

```
UI (React)
  AddressSearchDialog
        ↓ Server Action
Presentation Layer
  searchCounterpartAddressAction(name, hint?)
        ↓
Application Layer
  SearchCounterpartAddressUseCase
        ↓
Infrastructure Layer
  LLMGateway (interface)
    └─ VercelAIGateway (実装)
        ↓
External
  Vercel AI SDK → Claude API (+ WebSearch Tool)
```

### ディレクトリ構成

```
admin/src/
├── client/components/counterparts/
│   └── AddressSearchDialog.tsx          # 検索ダイアログUI
│
└── server/contexts/report/
    ├── presentation/actions/
    │   └── search-counterpart-address-action.ts
    │
    ├── application/
    │   ├── usecases/
    │   │   └── search-counterpart-address-usecase.ts
    │   └── prompts/
    │       └── counterpart-address-search.ts   # プロンプト定義（ドメイン知識）
    │
    └── infrastructure/llm/
        ├── llm-gateway.interface.ts     # インターフェース
        └── vercel-ai-gateway.ts         # Vercel AI SDK実装
```

### 型定義

**AddressCandidate（検索結果の候補）**

| フィールド | 型 | 説明 |
|-----------|-----|------|
| companyName | string | 正式名称 |
| postalCode | string \| null | 郵便番号（表示用、保存しない） |
| address | string | 住所 |
| confidence | 'high' \| 'medium' \| 'low' | 自信度 |
| source | string | 根拠（URL or 説明） |

**CounterpartAddressSearchResult（LLMGatewayの戻り値）**

| フィールド | 型 | 説明 |
|-----------|-----|------|
| candidates | AddressCandidate[] | 自信度順、最大5件 |
| searchQuery | string | 検索に使用したクエリ |

### エラーハンドリング

**SearchResult（Action の戻り値）**

| 型 | 説明 |
|-----|------|
| { success: true; data: CounterpartAddressSearchResult } | 成功時 |
| { success: false; error: SearchError } | 失敗時 |

**SearchError（エラー種別）**

| type | フィールド | 説明 |
|------|-----------|------|
| API_ERROR | message, retryable | API呼び出し失敗（retryable=trueならリトライ可） |
| TIMEOUT | message | タイムアウト |
| RATE_LIMIT | retryAfter | レート制限（retryAfter秒後にリトライ可） |
| NO_RESULTS | message | 候補が見つからなかった |

### 技術選定

| コンポーネント | 技術 | 理由 |
|--------------|------|------|
| LLM呼び出し | Vercel AI SDK | 組織方針（AI Gateway統一） |
| LLMモデル | Claude Sonnet | 精度とコストのバランス |
| Web検索 | Claude WebSearch Tool | LLM統合で実装シンプル |
| プロンプト管理 | ローカルファイル → 将来Langfuse | リモートプロンプト取得への移行を考慮 |

### Langfuse移行への備え

- プロンプトIDを定数化
- プロンプトと変数を分離した構造
- LLMGatewayインターフェースを通じた抽象化
