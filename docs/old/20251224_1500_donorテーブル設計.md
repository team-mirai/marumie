# Donor テーブル設計

## 概要

政治資金報告書の寄附取引において、寄附者情報を管理するためのテーブル設計。

## 背景

政治資金収支報告書では、寄附明細(SYUUSHI07_07)や政治資金パーティー対価支払者明細(SYUUSHI07_11)において、寄附者・支払者の情報（氏名、住所、職業など）の記載が必要となる。これらの情報は複数の取引で再利用される可能性があるため、マスタテーブルとして管理し、正規化する。

寄附者には**個人**、**法人その他の団体**、**政治団体**の3種類が存在し、それぞれ異なる属性を持つが、現時点では属性の差異は限定的（職業の有無程度）であるため、単一テーブルで`donor_type`により区別する設計とする。

## 要件

1. 寄附者の氏名・名称、住所、種別（個人/法人/政治団体）を保持
2. 個人の場合は職業情報も保持
3. 同一の寄附者情報を複数の取引で参照可能
4. 氏名・住所・種別の組み合わせで一意性を保証（重複登録防止）
5. 既存データの軽量な存在チェックが可能
6. 寄附関連の取引でのみ利用可能（PostgreSQL triggerで制御）
7. counterpart（支払先）とは明確に分離

## テーブル構造

### donors (マスタテーブル)

寄附者の基本情報を保持するマスタテーブル。

| カラム名 | 型 | 制約 | 説明 |
|---------|---|------|------|
| id | BigInt | PRIMARY KEY, AUTO INCREMENT | 一意識別子 |
| donor_type | VARCHAR(50) | NOT NULL | 寄附者種別 (individual/corporation/political_organization) |
| name | VARCHAR(120) | NOT NULL | 寄附者の氏名・名称 (XMLのKIFUSYA_NM/NMに対応) |
| address | VARCHAR(120) | NULL許容 | 寄附者の住所 (XMLのADRに対応) |
| occupation | VARCHAR(50) | NULL許容 | 職業 (個人のみ、XMLのSYOKUGYOに対応) |
| created_at | TIMESTAMP | NOT NULL, DEFAULT now() | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT now() | 更新日時 |

**制約:**
- UNIQUE (name, address, donor_type): 同一の氏名・住所・種別の組み合わせは1件のみ登録可能
- CHECK (donor_type IN ('individual', 'corporation', 'political_organization')): 種別は3種類のみ許可

**NULL許容の判断:**
- `address`: 報告書では必須項目だが、データ入力時点で未確定の場合を考慮してNULL許容とする
- `occupation`: 個人の場合のみ使用するためNULL許容とする（法人・政治団体ではNULL）

### transaction_donors (中間テーブル)

取引とdonorの関連を保持する中間テーブル。

| カラム名 | 型 | 制約 | 説明 |
|---------|---|------|------|
| id | BigInt | PRIMARY KEY, AUTO INCREMENT | 一意識別子 |
| transaction_id | BigInt | NOT NULL, FOREIGN KEY -> transactions(id) ON DELETE CASCADE | 取引ID |
| donor_id | BigInt | NOT NULL, FOREIGN KEY -> donors(id) ON DELETE CASCADE | 寄附者ID |
| created_at | TIMESTAMP | NOT NULL, DEFAULT now() | 作成日時 |

**制約:**
- UNIQUE (transaction_id, donor_id): 同一取引に同じdonorを重複登録不可
- UNIQUE (transaction_id): 1取引に1つのdonorのみ紐付け可能

**インデックス:**
- `idx_transaction_donors_transaction` on (transaction_id): 取引からdonor検索
- `idx_transaction_donors_donor` on (donor_id): donorから取引検索

## 利用可能な取引タイプとカテゴリ

donorが設定可能な取引は以下に限定する（PostgreSQL triggerで制御）:

### 収入取引 (income)

以下の `category_key` を持つ収入取引でのみ利用可能:

| category_key | 説明 |
|--------------|------|
| `individual-donations` | 個人からの寄附 |
| `specific-individual-donations` | 個人からの寄附（特定寄附） |
| `corporate-donations` | 法人その他の団体からの寄附 |
| `political-donations` | 政治団体からの寄附 |
| `mediated-donations` | 寄附のあっせんによるもの |
| `party-income` | 政治資金パーティーの対価に係る収入 |
| `mediated-party-income` | 政治資金パーティー対価のあっせんによるもの |

**donor_typeとの整合性:**
- 寄附者種別が明確なカテゴリ（`individual-donations`, `corporate-donations`, `political-donations`）は、対応するdonor_typeのdonorのみ紐付け可能
- 寄附者種別が不明なカテゴリ（`mediated-donations`, `party-income`, `mediated-party-income`）は、任意のdonor_typeのdonorを紐付け可能
- XML出力時にdonor_typeでグループ化して適切な様式・区分に振り分ける

| category_key | 許可されるdonor_type |
|--------------|---------------------|
| `individual-donations` | individual のみ |
| `specific-individual-donations` | individual のみ |
| `corporate-donations` | corporation のみ |
| `political-donations` | political_organization のみ |
| `mediated-donations` | すべて |
| `party-income` | すべて |
| `mediated-party-income` | すべて |

### 除外する取引

以下の取引には donor を設定**できない**:

1. 匿名寄附
   - `anonymous-donations` (政党匿名寄附 - SYUUSHI07_09) ※寄附者が特定できないためdonorを紐付けられない
2. 非寄附関連の収入
   - `publication-income`
   - `loans`
   - `grants`
   - `other-income`
   - `membership-fees`
3. 支出取引全般 (expense)
4. 非現金仕訳 (non_cash_journal)
5. 相殺取引 (offset_income, offset_expense)

## XML出力時のdonor_typeによる振り分け

XML出力時に、取引のcategory_keyと紐付いたdonorのdonor_typeを組み合わせて、適切な報告書様式・区分に振り分ける:

### 寄附関連

| category_key | donor_type | 報告書様式 |
|--------------|------------|-----------|
| `individual-donations`, `specific-individual-donations` | individual | SYUUSHI07_07 KUBUN1 |
| `corporate-donations` | corporation | SYUUSHI07_07 KUBUN2 |
| `political-donations` | political_organization | SYUUSHI07_07 KUBUN3 |
| `mediated-donations` | individual | SYUUSHI07_08 KUBUN1 |
| `mediated-donations` | corporation | SYUUSHI07_08 KUBUN2 |
| `mediated-donations` | political_organization | SYUUSHI07_08 KUBUN3 |

### 政治資金パーティー関連

| category_key | donor_type | 報告書様式 |
|--------------|------------|-----------|
| `party-income` | individual | SYUUSHI07_11 KUBUN1 |
| `party-income` | corporation | SYUUSHI07_11 KUBUN2 |
| `party-income` | political_organization | SYUUSHI07_11 KUBUN3 |
| `mediated-party-income` | individual | SYUUSHI07_12 KUBUN1 |
| `mediated-party-income` | corporation | SYUUSHI07_12 KUBUN2 |
| `mediated-party-income` | political_organization | SYUUSHI07_12 KUBUN3 |

## 重複チェック

name、address、donor_type の組み合わせに複合UNIQUE制約を設定することで、重複登録を防止し、高速な検索を実現する。

**注意点:**
- 同姓同名で同住所の個人と法人が存在する場合は、`donor_type`により区別される
- 住所がNULLの場合も一意性制約の対象となる（PostgreSQLのUNIQUE制約はNULLを許容）

## データ整合性制御 (PostgreSQL Trigger)

### trigger: validate_transaction_donor_insert

`transaction_donors` テーブルへのINSERT/UPDATE時に発火し、以下をチェック:

1. donor_typeが有効な値（individual/corporation/political_organization）であること
2. 対象取引の `transaction_type` が `income` であること
3. 対象取引の `category_key` が許可リストに含まれること
4. donor_type制限があるカテゴリの場合、donor_typeが一致すること
5. 条件を満たさない場合は RAISE EXCEPTION でエラーを返す

```sql
CREATE OR REPLACE FUNCTION validate_transaction_donor()
RETURNS TRIGGER AS $$
DECLARE
  v_transaction_type VARCHAR(255);
  v_category_key VARCHAR(255);
  v_donor_type VARCHAR(50);
  v_allowed_categories TEXT[] := ARRAY[
    'individual-donations',
    'specific-individual-donations',
    'corporate-donations',
    'political-donations',
    'mediated-donations',
    'party-income',
    'mediated-party-income'
  ];
  -- donor_type制限があるカテゴリ
  v_individual_only_categories TEXT[] := ARRAY[
    'individual-donations',
    'specific-individual-donations'
  ];
  v_corporation_only_categories TEXT[] := ARRAY[
    'corporate-donations'
  ];
  v_political_org_only_categories TEXT[] := ARRAY[
    'political-donations'
  ];
BEGIN
  -- 取引情報を取得
  SELECT transaction_type, category_key
  INTO v_transaction_type, v_category_key
  FROM transactions
  WHERE id = NEW.transaction_id;

  -- donor情報を取得
  SELECT donor_type
  INTO v_donor_type
  FROM donors
  WHERE id = NEW.donor_id;

  -- donor_typeの妥当性チェック
  IF v_donor_type NOT IN ('individual', 'corporation', 'political_organization') THEN
    RAISE EXCEPTION 'Unknown donor_type: %', v_donor_type;
  END IF;

  -- 収入取引のみ許可
  IF v_transaction_type != 'income' THEN
    RAISE EXCEPTION 'Donor can only be assigned to income transactions, not: %', v_transaction_type;
  END IF;

  -- カテゴリが許可リストに含まれているかチェック
  IF NOT (v_category_key = ANY(v_allowed_categories)) THEN
    RAISE EXCEPTION 'Donor cannot be assigned to this income transaction category: %', v_category_key;
  END IF;

  -- donor_type制限があるカテゴリの整合性チェック
  IF v_category_key = ANY(v_individual_only_categories) THEN
    IF v_donor_type != 'individual' THEN
      RAISE EXCEPTION 'Category "%" requires donor_type "individual", but got "%"', v_category_key, v_donor_type;
    END IF;
  ELSIF v_category_key = ANY(v_corporation_only_categories) THEN
    IF v_donor_type != 'corporation' THEN
      RAISE EXCEPTION 'Category "%" requires donor_type "corporation", but got "%"', v_category_key, v_donor_type;
    END IF;
  ELSIF v_category_key = ANY(v_political_org_only_categories) THEN
    IF v_donor_type != 'political_organization' THEN
      RAISE EXCEPTION 'Category "%" requires donor_type "political_organization", but got "%"', v_category_key, v_donor_type;
    END IF;
  END IF;
  -- mediated-donations, party-income, mediated-party-income は任意のdonor_typeを許可

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER validate_transaction_donor_insert
  BEFORE INSERT OR UPDATE ON transaction_donors
  FOR EACH ROW
  EXECUTE FUNCTION validate_transaction_donor();
```

### trigger: validate_donor_occupation

`donors` テーブルへのINSERT/UPDATE時に発火し、以下をチェック:

1. `donor_type='individual'`の場合、`occupation`がNULLでないこと（報告書要件）
2. `donor_type`が'corporation'または'political_organization'の場合、`occupation`がNULLであること
3. 条件を満たさない場合は RAISE EXCEPTION でエラーを返す

```sql
CREATE OR REPLACE FUNCTION validate_donor_occupation()
RETURNS TRIGGER AS $$
BEGIN
  -- 個人の場合はoccupationが必須
  IF NEW.donor_type = 'individual' THEN
    IF NEW.occupation IS NULL OR TRIM(NEW.occupation) = '' THEN
      RAISE EXCEPTION 'Occupation is required for individual donors';
    END IF;
  -- 法人・政治団体の場合はoccupationはNULLであるべき
  ELSIF NEW.donor_type IN ('corporation', 'political_organization') THEN
    IF NEW.occupation IS NOT NULL THEN
      RAISE EXCEPTION 'Occupation must be NULL for non-individual donors';
    END IF;
  END IF;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER validate_donor_occupation_insert
  BEFORE INSERT OR UPDATE ON donors
  FOR EACH ROW
  EXECUTE FUNCTION validate_donor_occupation();
```

### trigger: validate_donor_address_required

`donors` テーブルへのINSERT/UPDATE時に発火し、住所が存在することをチェック:

1. `address`がNULLまたは空文字列の場合は警告（エラーではない）
2. 報告書出力時には必須だが、入力時点では未確定の場合があるため警告レベルとする

```sql
CREATE OR REPLACE FUNCTION validate_donor_address()
RETURNS TRIGGER AS $$
BEGIN
  -- 住所が未入力の場合は警告（NOTICEレベル）
  IF NEW.address IS NULL OR TRIM(NEW.address) = '' THEN
    RAISE NOTICE 'Address is empty for donor: %. This may cause issues when generating reports.', NEW.name;
  END IF;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER validate_donor_address_insert
  BEFORE INSERT OR UPDATE ON donors
  FOR EACH ROW
  EXECUTE FUNCTION validate_donor_address();
```

## Prisma Schema定義

```prisma
model Donor {
  id        BigInt    @id @default(autoincrement())
  donorType DonorType @map("donor_type")
  name      String    @db.VarChar(120)
  address   String?   @db.VarChar(120)
  occupation String? @db.VarChar(50)
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  transactionDonors TransactionDonor[]

  @@unique([name, address, donorType])
  @@map("donors")
}

enum DonorType {
  individual
  corporation
  political_organization
}

model TransactionDonor {
  id            BigInt      @id @default(autoincrement())
  transactionId BigInt      @map("transaction_id")
  donorId       BigInt      @map("donor_id")
  createdAt     DateTime    @default(now()) @map("created_at")

  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  donor       Donor       @relation(fields: [donorId], references: [id], onDelete: Cascade)

  @@unique([transactionId, donorId])
  @@unique([transactionId])
  @@index([transactionId], name: "idx_transaction_donors_transaction")
  @@index([donorId], name: "idx_transaction_donors_donor")
  @@map("transaction_donors")
}
```

**Transaction モデルへの追加:**

```prisma
model Transaction {
  // ... 既存のフィールド

  transactionDonors TransactionDonor[]

  // ... 既存のリレーション
}
```

## マイグレーション戦略

1. **マイグレーションファイルの作成**
   - DonorType enumの作成
   - `donors` テーブルの作成
   - `transaction_donors` テーブルの作成
   - PostgreSQL trigger関数の作成（3種類）
   - トリガーの設定

2. **既存データへの影響**
   - 既存の `transactions` テーブルには影響なし
   - donor情報は新規取引から段階的に追加

3. **ロールバック対応**
   - trigger削除 → `transaction_donors` テーブル削除 → `donors` テーブル削除 → DonorType enum削除の順

## counterpart との分離

donorとcounterpartは以下のように明確に分離される:

| 観点 | donor | counterpart |
|------|-------|-------------|
| 用途 | 寄附・パーティー対価の寄附者情報 | 支出先・一部収入元の取引先情報 |
| 種別管理 | donor_type (individual/corporation/political_organization) | なし（種別管理不要） |
| 職業情報 | 個人の場合に保持 | なし |
| 対象取引 | *-donations, party-income, mediated-* | expense系, loans, grants等 |
| 報告書様式 | SYUUSHI07_07, SYUUSHI07_08, SYUUSHI07_11, SYUUSHI07_12 | SYUUSHI07_03~06, SYUUSHI07_14, SYUUSHI07_15 |

**重要:** 同一の個人・法人がdonorとcounterpartの両方として登録される場合があるが、これは正常な状態である。例えば、ある企業から寄附を受け取り（donor）、同じ企業に対して広告費を支払う（counterpart）というケースが存在する。

## DBレベルでのおかしなデータ構造の防止

以下の制約により、DBレベルで不正なデータ構造を防止する:

### 1. donor_typeの値制限
- PostgreSQL CHECK制約により、'individual', 'corporation', 'political_organization'以外の値を拒否

### 2. occupationの整合性
- triggerにより、individualの場合は必須、それ以外の場合は禁止を強制

### 3. transaction種別の制限
- triggerにより、income以外の取引にdonorを紐付けることを禁止

### 4. category_keyの制限
- triggerにより、寄附・パーティー関連以外のcategory_keyにdonorを紐付けることを禁止

### 5. donor_typeとcategory_keyの整合性（一部）
- triggerにより、donor_type制限があるカテゴリでは対応するdonor_typeのみ許可
- 例: `individual-donations`にはindividualのdonorのみ紐付け可能
- `mediated-donations`, `party-income`, `mediated-party-income`は任意のdonor_typeを許可

### 6. 重複donorの防止
- UNIQUE(name, address, donor_type)により、完全に同一のdonorが重複登録されることを防止

### 7. 1取引1donor制約
- UNIQUE(transaction_id)により、1つの取引に複数のdonorが紐付くことを防止

### 8. 住所未入力の警告
- triggerによりNOTICEを出力し、報告書生成時のエラーを事前に防ぐ

## スコープ外

以下は本設計のスコープ外とし、別途設計する:

1. donor編集・削除UI
2. donor登録・選択UI
3. 取引とdonorを紐付けるユースケース実装
4. XML出力時のdonor情報のマッピング（SYUUSHI07_07等への変換）
5. donorのマージ機能（同一人物の重複登録を統合）
6. donorの検索・フィルタリング機能

## 参考

- 政治資金収支報告書 XMLデータフォーマット仕様書: [docs/reference/report-format.md](docs/reference/report-format.md)
  - SYUUSHI07_07 (その7): 寄附の明細
  - SYUUSHI07_08 (その8): 寄附のあっせんによるものの明細
  - SYUUSHI07_09 (その9): 政党匿名寄附の明細
  - SYUUSHI07_10 (その10): 政治資金パーティーの対価に係る収入の明細
  - SYUUSHI07_11 (その11): 政治資金パーティーの対価の支払をした者の明細
  - SYUUSHI07_12 (その12): 政治資金パーティーの対価の支払のあっせんをした者の明細
- Counterpartテーブル設計: [docs/20251215_1053_counterpartテーブル設計.md](20251215_1053_counterpartテーブル設計.md)
