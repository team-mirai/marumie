# 取引先情報管理機能設計

## 概要

政治資金報告書XML生成に必要な取引先（Counterpart）情報を効率的に管理するための機能。大量のTransactionに対してCounterpartを紐付け、マスタ管理を行う。

## 背景と目的

### 現状の課題

- 報告書XML生成時に支払先の氏名・住所が必要だが、現在は仮データ`"（仮）取引先名称"`を返している
- 数千〜数万件のTransactionに対して効率的にCounterpart情報を紐付ける必要がある
- 同じCounterpartが繰り返し出現するため、過去の紐付け情報を活用した効率化が必要

### 目的

1. Transactionに対するCounterpartの効率的な紐付け
2. Counterpartマスタの管理（作成・編集・削除）
3. 過去の紐付け履歴からの自動提案
4. 一括編集による作業効率化

## スコープ

### 対象となるCounterpart

- **支出先**: お店、会社、個人事業主など（expense transaction）
- **借入先**: 金融機関、個人など（loan income transaction）
- **本部・支部**: 政党本部、支部組織など（grant income transaction）

### 対象外

- **寄附者**: 個人寄附者・法人寄附者は別テーブル（Donor）で管理するため対象外

## データモデル

### 既存のスキーマ

```prisma
model Counterpart {
  id        BigInt   @id @default(autoincrement())
  name      String   @db.VarChar(120)
  address   String   @db.VarChar(120)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  transactionCounterparts TransactionCounterpart[]

  @@unique([name, address])
  @@map("counterparts")
}

model TransactionCounterpart {
  id            BigInt      @id @default(autoincrement())
  transactionId BigInt      @map("transaction_id")
  counterpartId BigInt      @map("counterpart_id")
  createdAt     DateTime    @default(now())

  transaction Transaction @relation(...)
  counterpart Counterpart @relation(...)

  @@unique([transactionId, counterpartId])
  @@unique([transactionId])
  @@map("transaction_counterparts")
}
```

### 制約

- Counterpartは`name + address`の組み合わせでユニーク
- Transactionに対するCounterpartの紐付けは1:1（`@@unique([transactionId])`）

## アーキテクチャ設計

### Bounded Context配置

`admin/src/server/contexts/report/`配下に機能を追加：

```
contexts/report/
├─ domain/
│  ├─ models/
│  │  └─ counterpart.ts                    # Counterpart エンティティ、ドメインロジック
│  └─ repositories/
│     └─ counterpart-repository.interface.ts
│
├─ application/
│  ├─ usecases/
│  │  ├─ assign-counterpart-usecase.ts     # 単一紐付け
│  │  ├─ bulk-assign-counterpart-usecase.ts # 一括紐付け
│  │  ├─ suggest-counterpart-usecase.ts    # 自動提案
│  │  └─ manage-counterpart-usecase.ts     # マスタ管理CRUD
│  └─ services/
│     └─ counterpart-suggester.ts          # 提案アルゴリズム（拡張可能）
│
├─ infrastructure/
│  └─ repositories/
│     └─ prisma-counterpart.repository.ts
│
└─ presentation/
   ├─ loaders/
   │  ├─ transactions-with-counterparts-loader.ts # Transaction一覧取得
   │  └─ counterparts-loader.ts                    # Counterpartマスタ取得
   └─ actions/
      ├─ assign-counterpart.ts             # 単一紐付け
      ├─ bulk-assign-counterpart.ts        # 一括紐付け
      ├─ create-counterpart.ts             # 新規作成
      ├─ update-counterpart.ts             # 編集
      └─ delete-counterpart.ts             # 削除
```

### Repository Interface

```typescript
interface ICounterpartRepository {
  // 基本CRUD
  findById(id: bigint): Promise<Counterpart | null>
  findByNameAndAddress(name: string, address: string): Promise<Counterpart | null>
  findAll(filters: CounterpartFilters): Promise<Counterpart[]>
  create(data: CreateCounterpartInput): Promise<Counterpart>
  update(id: bigint, data: UpdateCounterpartInput): Promise<Counterpart>
  delete(id: bigint): Promise<void>

  // 提案機能用
  findByUsageFrequency(
    politicalOrganizationId: bigint,
    limit: number
  ): Promise<CounterpartWithUsage[]>

  findByPartnerName(
    politicalOrganizationId: bigint,
    partnerName: string
  ): Promise<CounterpartWithUsage[]>

  // 使用状況
  getUsageCount(id: bigint): Promise<number>
  getTransactionsByCounterpart(
    counterpartId: bigint,
    filters: TransactionFilters
  ): Promise<Transaction[]>
}

interface CounterpartFilters {
  politicalOrganizationId: bigint
  searchQuery?: string  // name or address
  limit?: number
  offset?: number
}

interface CounterpartWithUsage extends Counterpart {
  usageCount: number
  lastUsedAt?: Date
}
```

### Suggester Service（拡張可能な設計）

複数の提案ストラテジーを組み合わせてスコアリング：

```typescript
interface SuggestionStrategy {
  suggest(
    transaction: Transaction,
    context: SuggestionContext
  ): Promise<CounterpartSuggestion[]>
}

interface SuggestionContext {
  politicalOrganizationId: bigint
  repository: ICounterpartRepository
}

interface CounterpartSuggestion {
  counterpart: Counterpart
  score: number
  reason: string  // デバッグ・表示用
}

// Strategy 1: 会計ソフトの取引先名から提案
class PartnerNameStrategy implements SuggestionStrategy {
  // debitPartner/creditPartner と過去の紐付け履歴をマッチング
}

// Strategy 2: カテゴリ・金額が類似した取引から提案
class CategoryAmountStrategy implements SuggestionStrategy {
  // 同じカテゴリで金額が近い過去の取引からCounterpartを提案
}

// Strategy 3: 単純な使用頻度順
class FrequencyStrategy implements SuggestionStrategy {
  // 全体的な使用頻度が高いCounterpartを提案
}

class CounterpartSuggester {
  constructor(
    private strategies: SuggestionStrategy[],
    private repository: ICounterpartRepository
  ) {}

  async suggest(
    transaction: Transaction,
    limit: number = 5
  ): Promise<CounterpartSuggestion[]> {
    const context: SuggestionContext = {
      politicalOrganizationId: transaction.politicalOrganizationId,
      repository: this.repository
    }

    // 各ストラテジーから提案を収集
    const allSuggestions: CounterpartSuggestion[] = []
    for (const strategy of this.strategies) {
      const suggestions = await strategy.suggest(transaction, context)
      allSuggestions.push(...suggestions)
    }

    // Counterpart IDごとにスコアを集約
    const aggregated = this.aggregateScores(allSuggestions)

    // スコア降順でソート、上位N件を返す
    return aggregated
      .sort((a, b) => b.score - a.score)
      .slice(0, limit)
  }

  private aggregateScores(
    suggestions: CounterpartSuggestion[]
  ): CounterpartSuggestion[] {
    // 同じCounterpartの提案をスコア合算
    // ...
  }
}
```

### Usecases

#### assign-counterpart-usecase.ts

```typescript
interface AssignCounterpartInput {
  transactionId: bigint
  counterpartId: bigint
}

async function assignCounterpart(
  input: AssignCounterpartInput
): Promise<void> {
  // 1. Transactionの存在確認
  // 2. Counterpartの存在確認
  // 3. TransactionCounterpartの作成 or 更新
}
```

#### bulk-assign-counterpart-usecase.ts

```typescript
interface BulkAssignCounterpartInput {
  transactionIds: bigint[]
  counterpartId: bigint
}

async function bulkAssignCounterpart(
  input: BulkAssignCounterpartInput
): Promise<{ successCount: number; failedIds: bigint[] }> {
  // トランザクションで一括更新
}
```

#### suggest-counterpart-usecase.ts

```typescript
interface SuggestCounterpartInput {
  transactionId: bigint
  limit?: number
}

async function suggestCounterpart(
  input: SuggestCounterpartInput
): Promise<CounterpartSuggestion[]> {
  // 1. Transactionの取得
  // 2. CounterpartSuggesterを使って提案生成
  // 3. 結果を返す
}
```

## UI設計

### ページ構成

#### 1. メインページ: Transaction一覧 with インライン編集

**URL**: `/admin/report/{orgId}/{year}/counterparts`

**目的**: Transactionに対するCounterpartの紐付け作業

**レイアウト**:

```
┌─────────────────────────────────────────────────────────────────────┐
│ 取引先紐付け管理                                   [マスタ管理へ →] │
├─────────────────────────────────────────────────────────────────────┤
│                                                                       │
│ ┌─ フィルタバー ─────────────────────────────────────────────────┐ │
│ │ [☑ 未紐付けのみ]  [カテゴリ ▼]  [期間 ▼]  [検索キーワード...] │ │
│ └───────────────────────────────────────────────────────────────┘ │
│                                                                       │
│ ┌─ 一括操作バー ─────────────────────────────────────────────────┐│
│ │ 選択中: 3件    [一括紐付け]                                     ││
│ └───────────────────────────────────────────────────────────────┘│
│                                                                       │
│ ┌─ Transaction一覧テーブル ─────────────────────────────────────┐ │
│ │ [☑] │ 日付       │ 金額      │ カテゴリ    │ 取引先           │ │
│ │─────┼───────────┼──────────┼────────────┼─────────────────│ │
│ │ [☑] │ 2024-06-01 │ ¥5,000   │ 事務所費    │ [○○商店 ▼]     │ │
│ │ [☑] │ 2024-06-15 │ ¥5,200   │ 事務所費    │ [○○商店 ▼]     │ │
│ │ [ ] │ 2024-07-01 │ ¥8,000   │ 光熱水費    │ [東京電力 ▼]   │ │
│ │ [ ] │ 2024-07-10 │ ¥50,000  │ 組織活動費  │ [未設定 ▼]     │ │
│ │ [ ] │ 2024-07-15 │ ¥12,000  │ 備品消耗品  │ [未設定 ▼]     │ │
│ │                                                                   │ │
│ │ [< 前へ]  1 / 50  [次へ >]                                       │ │
│ └───────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
```

**Combobox展開時**:

```
┌─ Counterpart選択 ────────────────────────────────┐
│ [検索...                                    ]    │
│                                                   │
│ ─ 提案（このTransactionに基づく） ─              │
│ ○ ○○商店                                        │
│   東京都渋谷区〇〇1-2-3                          │
│   理由: 同じ取引先名で過去5回使用                │
│                                                   │
│ ○ △△ストア                                      │
│   東京都新宿区△△2-3-4                          │
│   理由: 同じカテゴリで金額が近い                 │
│                                                   │
│ ─ よく使うCounterpart ─                          │
│ ○ 東京電力                                       │
│   東京都千代田区内幸町1-1-3                     │
│   使用回数: 12回                                 │
│                                                   │
│ ─ すべてのCounterpart ─                          │
│ ○ ××事務所                                      │
│   神奈川県横浜市〇〇区1-1-1                     │
│                                                   │
│ [+ 新規Counterpart作成]                          │
└───────────────────────────────────────────────┘
```

**新規Counterpart作成ダイアログ**:

```
┌─ 新規Counterpart作成 ─────────────────────────┐
│                                                 │
│ 名前 *                                          │
│ [                                          ]    │
│                                                 │
│ 住所 *                                          │
│ [                                          ]    │
│                                                 │
│ ※ 同じ名前・住所の組み合わせは登録できません   │
│                                                 │
│                        [キャンセル]  [作成]    │
└─────────────────────────────────────────────┘
```

**一括紐付けモーダル**:

```
┌─ 一括紐付け ──────────────────────────────────┐
│                                                 │
│ 選択したTransaction: 3件                       │
│                                                 │
│ 紐付けるCounterpart *                           │
│ [○○商店                               ▼]      │
│  東京都渋谷区〇〇1-2-3                          │
│                                                 │
│ ─ プレビュー ─                                  │
│ • 2024-06-01  ¥5,000   事務所費                │
│ • 2024-06-15  ¥5,200   事務所費                │
│ • 2024-06-20  ¥4,800   事務所費                │
│                                                 │
│ これらのTransactionに「○○商店」を紐付けます    │
│                                                 │
│                        [キャンセル]  [紐付け]  │
└─────────────────────────────────────────────┘
```

#### 2. サブページ: Counterpartマスタ管理

**URL**: `/admin/report/{orgId}/counterparts/master`

**目的**: Counterpartの一覧表示・編集・削除・マージ

**レイアウト**:

```
┌─────────────────────────────────────────────────────────────────────┐
│ Counterpartマスタ管理                        [← Transaction一覧へ] │
├─────────────────────────────────────────────────────────────────────┤
│                                                                       │
│ [+ 新規作成]  [検索...                                          ]    │
│                                                                       │
│ ┌─ Counterpart一覧テーブル ─────────────────────────────────────┐ │
│ │ 名前              │ 住所                           │ 使用数    │ │
│ │──────────────────┼───────────────────────────────┼──────────│ │
│ │ ○○商店          │ 東京都渋谷区〇〇1-2-3          │ 12件 [編集]││
│ │ 東京電力          │ 東京都千代田区内幸町1-1-3      │ 8件  [編集]││
│ │ △△事務所        │ 神奈川県横浜市〇〇区1-1-1     │ 3件  [編集]││
│ │ ××ストア        │ 東京都新宿区△△2-3-4          │ 1件  [編集]││
│ │                                                                   │ │
│ │ [< 前へ]  1 / 10  [次へ >]                                       │ │
│ └───────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
```

**編集ダイアログ**:

```
┌─ Counterpart編集 ─────────────────────────────┐
│                                                 │
│ 名前 *                                          │
│ [○○商店                                   ]    │
│                                                 │
│ 住所 *                                          │
│ [東京都渋谷区〇〇1-2-3                     ]    │
│                                                 │
│ 使用状況: 12件のTransactionで使用中            │
│                                                 │
│                        [削除]  [キャンセル]     │
│                                      [保存]     │
└─────────────────────────────────────────────┘
```

**削除確認ダイアログ**:

```
┌─ Counterpart削除確認 ─────────────────────────┐
│                                                 │
│ 「○○商店」を削除しますか？                     │
│                                                 │
│ このCounterpartは12件のTransactionで            │
│ 使用されています。                              │
│                                                 │
│ 削除すると、これらのTransactionの紐付けが       │
│ 解除されます。                                  │
│                                                 │
│                        [キャンセル]  [削除]    │
└─────────────────────────────────────────────┘
```

### UI技術スタック

- **Table**: TanStack Table v8
  - ソート、フィルタ、ページネーション
  - 仮想スクロール対応（大量データ）

- **Combobox**: shadcn/ui Command + Popover
  - キーボードナビゲーション
  - 検索・フィルタリング
  - 自動提案表示

- **Modal**: shadcn/ui Dialog
  - 一括紐付け
  - 新規作成・編集・削除確認

- **Form**: React Hook Form + Zod
  - バリデーション
  - エラーハンドリング

- **State管理**: Optimistic UI
  - Server Actions + useOptimistic
  - 楽観的UI更新（紐付け操作の即時反映）

### パフォーマンス最適化

#### 1. ページネーション

- Transaction一覧: 50件/ページ
- Counterpartマスタ: 50件/ページ
- 必要に応じて仮想スクロールに切り替え可能

#### 2. Debounced検索

- Combobox検索: 300ms debounce
- テーブル検索: 500ms debounce

#### 3. 楽観的UI更新

```typescript
// 紐付け操作時
const [optimisticTransactions, addOptimisticTransaction] = useOptimistic(
  transactions,
  (state, newCounterpart) => {
    // 即座にUIを更新
    return state.map(tx =>
      tx.id === selectedId
        ? { ...tx, counterpart: newCounterpart }
        : tx
    )
  }
)

async function handleAssign(counterpartId: bigint) {
  // 1. 楽観的UI更新
  addOptimisticTransaction({ id: counterpartId, name: "..." })

  // 2. サーバーアクション実行
  await assignCounterpartAction({ transactionId, counterpartId })
}
```

#### 4. データプリフェッチ

- Combobox展開時に提案データを事前ロード
- よく使うCounterpartのキャッシュ

## データフロー

### 1. Transaction一覧表示

```
User → Page Component
  → transactionsWithCounterpartsLoader()
    → ReportTransactionRepository.findWithCounterparts()
      → Prisma query (JOIN counterparts)
  → Render table with counterpart data
```

### 2. Counterpart提案表示

```
User → Opens Combobox
  → suggestCounterpartAction({ transactionId })
    → suggestCounterpartUsecase()
      → CounterpartSuggester.suggest()
        → PartnerNameStrategy.suggest()
        → CategoryAmountStrategy.suggest()
        → FrequencyStrategy.suggest()
        → Aggregate & sort by score
  → Display suggestions in Combobox
```

### 3. Counterpart紐付け

```
User → Selects Counterpart from Combobox
  → assignCounterpartAction({ transactionId, counterpartId })
    → assignCounterpartUsecase()
      → Validate transaction & counterpart exist
      → Upsert TransactionCounterpart
      → revalidatePath()
  → Update UI optimistically
```

### 4. 一括紐付け

```
User → Selects multiple Transactions → Opens Bulk Modal → Selects Counterpart
  → bulkAssignCounterpartAction({ transactionIds, counterpartId })
    → bulkAssignCounterpartUsecase()
      → Prisma transaction
        → Delete existing TransactionCounterparts
        → Insert new TransactionCounterparts (bulk)
      → revalidatePath()
  → Update UI optimistically
```

## エラーハンドリング

### 1. バリデーションエラー

- 名前・住所の必須チェック
- 文字数制限（name: 120文字、address: 120文字）
- 重複チェック（name + addressのユニーク制約）

### 2. 削除時エラー

- 使用中のCounterpartを削除する場合は確認ダイアログ表示
- 削除時にTransactionCounterpartも一緒に削除（CASCADE）

### 3. ネットワークエラー

- Server Actionのエラーをtry-catchでハンドリング
- ユーザーにToast通知で表示
- 楽観的UI更新をロールバック

## セキュリティ

### 認可

- すべてのloaders/actionsで組織IDの認可チェック
- ユーザーが所属する組織のデータのみアクセス可能

### バリデーション

- Server Actionsでの入力バリデーション（Zod）
- XSS対策（React の自動エスケープ）
- SQL Injection対策（Prisma のパラメータバインディング）

## テストシナリオ

### 1. Transaction一覧表示

- [ ] 未紐付けTransactionのみ表示
- [ ] カテゴリでフィルタリング
- [ ] 期間でフィルタリング
- [ ] キーワード検索
- [ ] ページネーション動作

### 2. Counterpart紐付け

- [ ] Comboboxで提案が表示される
- [ ] 提案からCounterpartを選択して紐付け
- [ ] 新規Counterpart作成してそのまま紐付け
- [ ] 楽観的UI更新が動作する
- [ ] エラー時にロールバックされる

### 3. 一括紐付け

- [ ] 複数Transactionを選択
- [ ] 一括紐付けモーダルが開く
- [ ] プレビューが表示される
- [ ] 一括紐付けが実行される

### 4. Counterpartマスタ管理

- [ ] Counterpart一覧が表示される
- [ ] 新規Counterpart作成
- [ ] 既存Counterpart編集
- [ ] Counterpart削除（使用中の場合は確認）
- [ ] 重複チェックが動作する

### 5. 提案機能

- [ ] PartnerNameStrategyが動作する
- [ ] CategoryAmountStrategyが動作する
- [ ] FrequencyStrategyが動作する
- [ ] スコアリングが正しく集約される

## 制限事項

- Counterpartの削除は関連するTransactionCounterpartも一緒に削除される（CASCADE）
- マージ機能は初期実装では含まない（手動で統合が必要）
- 提案アルゴリズムの精度は実運用でのフィードバックにより改善が必要

## 実装順序

段階的に動作確認しながら実装を進めるため、以下の4段階で実装する。各段階で単体動作確認が可能。

### 第1段階: Counterpartマスタ管理（基本CRUD）

**目的**: データモデルとインフラ層の動作確認

**実装内容**:
- Domain層
  - `counterpart.ts`: Counterpartエンティティ、ドメインロジック
  - `counterpart-repository.interface.ts`: Repository Interface（基本CRUDのみ）
- Infrastructure層
  - `prisma-counterpart.repository.ts`: 基本CRUD実装
- Application層
  - `manage-counterpart-usecase.ts`: CRUD操作のusecase
- Presentation層
  - `counterparts-loader.ts`: Counterpart一覧取得
  - `create-counterpart.ts`: 新規作成action
  - `update-counterpart.ts`: 編集action
  - `delete-counterpart.ts`: 削除action
- UI層
  - `/admin/report/{orgId}/counterparts/master/page.tsx`: マスタ管理画面
  - Counterpart一覧テーブル（shadcn/ui Table）
  - 新規作成・編集・削除ダイアログ

**動作確認**:
- [ ] Counterpart一覧が表示される
- [ ] 新規Counterpart作成ができる
- [ ] 既存Counterpart編集ができる
- [ ] Counterpart削除ができる
- [ ] 重複チェックが動作する（name + address）

**依存関係**: なし（独立して実装可能）

---

### 第2段階: Transaction一覧とCounterpart表示

**目的**: TransactionとCounterpartの紐付けデータを表示

**実装内容**:
- Infrastructure層（拡張）
  - `prisma-report-transaction.repository.ts`: Counterpart JOINクエリ追加
- Presentation層
  - `transactions-with-counterparts-loader.ts`: Transaction一覧取得（Counterpart含む）
- UI層
  - `/admin/report/{orgId}/{year}/counterparts/page.tsx`: Transaction一覧画面
  - Transaction一覧テーブル（TanStack Table）
  - フィルタ機能（未紐付けのみ、カテゴリ、期間、検索）
  - ソート機能
  - ページネーション

**動作確認**:
- [ ] Transaction一覧が表示される
- [ ] 紐付け済みCounterpartが表示される
- [ ] 未紐付けフィルタが動作する
- [ ] カテゴリ・期間フィルタが動作する
- [ ] ソート・ページネーションが動作する

**依存関係**: 第1段階（Counterpartマスタが必要）

---

### 第3段階: Counterpart紐付け機能（単一）

**目的**: 1件ずつCounterpartを紐付ける基本機能

**実装内容**:
- Application層
  - `assign-counterpart-usecase.ts`: 単一紐付けusecase
- Presentation層
  - `assign-counterpart.ts`: 紐付けaction
- UI層（拡張）
  - CounterpartComboboxコンポーネント
  - Counterpart一覧表示（shadcn/ui Command）
  - 検索機能
  - 新規Counterpart作成（インラインダイアログ）
  - 楽観的UI更新

**動作確認**:
- [ ] Comboboxが開く
- [ ] Counterpart一覧が表示される
- [ ] 検索でフィルタリングできる
- [ ] Counterpart選択で紐付けができる
- [ ] インラインで新規Counterpart作成ができる
- [ ] 楽観的UI更新が動作する

**依存関係**: 第2段階（Transaction一覧が必要）

---

### 第4段階: 一括紐付け機能と提案機能

**目的**: 作業効率化機能の実装

**実装内容**:

#### 4-1. 一括紐付け
- Application層
  - `bulk-assign-counterpart-usecase.ts`: 一括紐付けusecase
- Presentation層
  - `bulk-assign-counterpart.ts`: 一括紐付けaction
- UI層（拡張）
  - 行選択機能（TanStack Table）
  - 一括紐付けモーダル
  - プレビュー表示

#### 4-2. 提案機能
- Domain層（拡張）
  - `counterpart-repository.interface.ts`: 提案用メソッド追加
- Infrastructure層（拡張）
  - `prisma-counterpart.repository.ts`: 提案用クエリ実装
- Application層
  - `counterpart-suggester.ts`: 提案サービス
    - `FrequencyStrategy`: 使用頻度順提案（まず実装）
    - `PartnerNameStrategy`: 取引先名マッチング（後で実装）
    - `CategoryAmountStrategy`: カテゴリ・金額類似（後で実装）
  - `suggest-counterpart-usecase.ts`: 提案usecase
- Presentation層
  - `suggest-counterpart.ts`: 提案取得action（オプション）
- UI層（拡張）
  - Combobox内での提案表示
  - セクション分け（提案 / よく使う / すべて）

**動作確認**:
- [ ] 複数Transaction選択ができる
- [ ] 一括紐付けモーダルが開く
- [ ] プレビューが表示される
- [ ] 一括紐付けが実行される
- [ ] Comboboxで提案が表示される
- [ ] 使用頻度順提案が動作する
- [ ] セクション分けが表示される

**依存関係**: 第3段階（単一紐付けが必要）

---

### 各段階の所要目安

実装の複雑度を示す指標（実際の時間ではなく相対的な複雑度）:

- 第1段階: ★★☆☆☆（基本CRUD、比較的単純）
- 第2段階: ★★★☆☆（TanStack Table導入、フィルタ実装）
- 第3段階: ★★★★☆（Combobox、楽観的UI、複雑な状態管理）
- 第4段階: ★★★☆☆（一括操作は単純、提案アルゴリズムは拡張性重視）

### 実装順序の利点

1. **独立した動作確認**: 各段階で機能が完結するため、動作確認しやすい
2. **段階的なリスク低減**: 複雑な機能（提案）を後回しにできる
3. **早期フィードバック**: 第1段階でマスタ管理が使えるため、データ準備が早期に可能
4. **柔軟な調整**: 各段階で仕様変更があっても影響範囲が限定的

### 最小限の実装で動かす場合

もし最速で動作させたい場合は、以下の簡略版も可能：

- **第1段階**: そのまま
- **第2段階**: フィルタなし、基本表示のみ
- **第3段階**: 提案なし、単純なセレクトボックス
- **第4段階**: スキップ（手動で1件ずつ紐付け）

## 用語集

- **Counterpart**: 取引先。支払先、借入先、本部・支部などを指す
- **Transaction**: 会計ソフトから取り込んだ取引データ
- **紐付け**: TransactionとCounterpartを関連付ける操作
- **提案**: 過去の紐付け履歴やパターンから自動的にCounterpartを推薦する機能
- **一括紐付け**: 複数のTransactionに対して同じCounterpartを一度に紐付ける操作
