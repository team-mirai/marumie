# 寄付者CSVインポート確定フェーズ設計

## 目的

**管理者が5000件以上の寄付者情報を1件ずつ手動入力する必要がある困りごとを解消するため**、CSVプレビュー後のインポート確定機能を提供する。

---

## 1. 概要

既に実装済みのプレビューフェーズに続き、ユーザーが「インポート実行」ボタンをクリックした際の処理を設計する。

### 処理フロー

```
┌──────────────────────────────────────────────────────────────────┐
│                      インポート確定フェーズ                         │
├──────────────────────────────────────────────────────────────────┤
│  1. ユーザーが「インポート実行」ボタンをクリック                      │
│  2. クライアントからサーバーアクションを呼び出し                      │
│     - 再度CSV内容をパース＆バリデーション                            │
│     - 全行がvalidかを確認                                          │
│  3. Donorの作成または既存Donor検索                                  │
│     - matchingDonor がある行: 既存Donorを使用                       │
│     - matchingDonor がない行: 新規Donor作成                         │
│  4. TransactionDonorの一括紐付け                                   │
│  5. キャッシュ無効化                                                │
│  6. 結果をtoastで通知                                               │
│     - 成功: "○件のインポートが完了しました"                          │
│     - 失敗: "インポートに失敗しました: {エラー内容}"                  │
└──────────────────────────────────────────────────────────────────┘
```

---

## 2. UI設計

### 2.1 インポートボタン

プレビュー結果の下に「インポート実行」ボタンを配置する。

| 条件 | ボタンの状態 |
|------|------------|
| 全行が valid | 有効 (enabled) |
| 1行以上が invalid/transaction_not_found/type_mismatch | 無効 (disabled) |
| インポート処理中 | 無効 + ローディング表示 |

ボタンには件数を表示する：
- 「○件をインポート」（valid行数を表示）

### 2.2 toast通知

sonnerを使用した通知を表示する。

**成功時:**
```typescript
toast.success(`${importedCount}件のインポートが完了しました`);
```

**失敗時:**
```typescript
toast.error(`インポートに失敗しました: ${errorMessage}`);
```

### 2.3 インポート成功後の動作

1. toast.success で成功通知を表示
2. ファイル入力をリセット（プレビュー結果もクリア）
3. 画面遷移は行わない（同じ画面で続けてインポートできるようにする）

---

## 3. アーキテクチャ

### 3.1 新規作成ファイル

```
report/
├── presentation/
│   └── actions/
│       └── import-donor-csv.ts        # サーバーアクション（新規）
└── application/
    └── usecases/
        └── import-donor-csv-usecase.ts # インポートUsecase（新規）
```

### 3.2 既存ファイルの変更

```
client/components/donor-csv-import/
├── DonorCsvImportClient.tsx           # インポートボタン追加
└── DonorCsvPreview.tsx                # インポートボタンのUI追加
```

---

## 4. 各レイヤーの責務

### 4.1 Presentation層（import-donor-csv.ts）

サーバーアクションとして以下を実行：

1. リクエストの受け取り（File, politicalOrganizationId）
2. ImportDonorCsvUsecase の呼び出し
3. 成功時: `revalidatePath("/import/donors")` でキャッシュ無効化
4. エラーハンドリング: ユーザーフレンドリーなメッセージに変換

**戻り値型:**
```typescript
type ImportDonorCsvResult =
  | { ok: true; importedCount: number; createdDonorCount: number }
  | { ok: false; error: string };
```

### 4.2 Application層（ImportDonorCsvUsecase）

**入力:**
```typescript
interface ImportDonorCsvInput {
  csvContent: string;
  politicalOrganizationId: string;
}
```

**出力:**
```typescript
interface ImportDonorCsvOutput {
  importedCount: number;      // 紐付けしたTransaction数
  createdDonorCount: number;  // 新規作成したDonor数
}
```

**処理フロー:**

1. PreviewDonorCsvUsecase と同様のパース＆バリデーション
2. 無効な行がある場合は例外をスロー
3. 新規Donorの一括作成
   - matchingDonor がない行を抽出
   - 重複を除去（同一CSV内で同じ name + address + donorType がある場合）
   - IDonorRepository.create() で作成
4. TransactionDonorの一括紐付け
   - ITransactionDonorRepository.replaceMany() を使用
   - 既存の紐付けは置換される

**依存インターフェース:**
- IDonorCsvLoader
- IDonorCsvRecordConverter
- IDonorCsvValidator
- ITransactionWithDonorRepository
- IDonorRepository
- ITransactionDonorRepository

### 4.3 Client層（DonorCsvImportClient.tsx / DonorCsvPreview.tsx）

DonorCsvPreview に以下を追加：
- インポートボタン（件数表示付き）
- ローディング状態の管理
- インポートアクションの呼び出し
- toast通知の表示

DonorCsvImportClient に以下を追加：
- インポート成功時のファイルリセット処理

---

## 5. 考慮事項の決定

既存設計ドキュメント（docs/20251230_0124_donor一括CSV取り込み設計.md）で検討事項として挙げられていた項目について、本設計での方針を記載する。

### 5.1 CSVファイル内の重複（同一transaction_no）

**方針: 後勝ち**

同一のtransaction_noが複数行ある場合、最後の行で上書きする。

理由:
- ユーザーがCSVを編集して再アップロードする際、末尾に修正行を追加するケースが多い
- エラーとすると、ユーザーにCSV修正を強いることになり使い勝手が悪い

### 5.2 既存紐付けの扱い

**方針: 置換（既存設計通り）**

`ITransactionDonorRepository.replaceMany()` により、インポート対象のTransactionの既存紐付けは新しい紐付けに置換される。

### 5.3 大量データ対応

**方針: 5000行まで**

- プレビュー時に5000行を超える場合はエラーを表示
- 既存のDonorCsvValidator にチェック処理を追加

---

## 6. エラーハンドリング

| エラー種別 | Presentation層での対応 |
|-----------|----------------------|
| バリデーションエラー（invalid行あり） | `{ ok: false, error: "CSVにエラーがあります。プレビューを確認してください" }` |
| DB保存エラー | `{ ok: false, error: "データベースへの保存に失敗しました。時間をおいて再試行してください" }` |
| 予期しないエラー | `{ ok: false, error: "予期しないエラーが発生しました" }` |

---

## 7. E2Eテスト

既存のE2Eテストファイル（`admin/e2e/tests/import-donors.spec.ts`）に以下のテストケースを追加する。

### 7.1 追加するテストケース

**インポートボタンの表示**
- 全件がvalidの場合、インポートボタンが有効になる
- エラーがある場合、インポートボタンが無効になる

**インポート実行**
- インポートボタンをクリックすると成功toastが表示される
- インポート成功後、ファイル入力がリセットされる
- インポート成功後、プレビューが消える

### 7.2 テストデータ

既存のサンプルCSV（`data/sample_donor_import.csv`）を使用。必要に応じて、全件validなテスト用CSVを追加する。

---

## 8. チェックリスト（実装時に確認）

- [ ] Presentation層はUsecaseのみを呼び出し、ビジネスロジックを含んでいない
- [ ] Application層（Usecase）はリポジトリインターフェースに依存し、実装クラスに依存していない
- [ ] actionsで適切に`revalidatePath`を呼び出している
- [ ] toast通知が成功/失敗で適切に表示される
- [ ] ファイル入力がインポート成功後にリセットされる
- [ ] 5000行制限のバリデーションが機能している
- [ ] E2Eテストが全て通る
