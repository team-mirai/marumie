generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id        String   @id @default(uuid())
  authId    String   @unique @map("auth_id")
  email     String   @unique @db.VarChar(255)
  role      UserRole @default(user)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("users")
}

model PoliticalOrganization {
  id               BigInt            @id @default(autoincrement())
  displayName      String            @map("display_name") @db.VarChar(255)
  description      String?
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")
  slug             String            @unique @db.VarChar(255)
  orgName          String?           @map("org_name") @db.VarChar(255)
  balanceSnapshots BalanceSnapshot[]
  reportProfiles   OrganizationReportProfile[]
  transactions     Transaction[]

  @@map("political_organizations")
}

model Transaction {
  id                       BigInt                   @id @default(autoincrement())
  politicalOrganizationId  BigInt                   @map("political_organization_id")
  transactionNo            String                   @map("transaction_no") @db.VarChar(255)
  transactionDate          DateTime                 @map("transaction_date") @db.Date
  financialYear            Int                      @map("financial_year")
  transactionType          TransactionType          @map("transaction_type")
  debitAccount             String                   @map("debit_account") @db.VarChar(255)
  debitSubAccount          String?                  @map("debit_sub_account") @db.VarChar(255)
  debitDepartment          String?                  @map("debit_department") @db.VarChar(255)
  debitPartner             String?                  @map("debit_partner") @db.VarChar(255)
  debitTaxCategory         String?                  @map("debit_tax_category") @db.VarChar(255)
  debitAmount              Decimal                  @map("debit_amount") @db.Decimal(15, 2)
  creditAccount            String                   @map("credit_account") @db.VarChar(255)
  creditSubAccount         String?                  @map("credit_sub_account") @db.VarChar(255)
  creditDepartment         String?                  @map("credit_department") @db.VarChar(255)
  creditPartner            String?                  @map("credit_partner") @db.VarChar(255)
  creditTaxCategory        String?                  @map("credit_tax_category") @db.VarChar(255)
  creditAmount             Decimal                  @map("credit_amount") @db.Decimal(15, 2)
  description              String?
  createdAt                DateTime                 @default(now()) @map("created_at")
  updatedAt                DateTime                 @updatedAt @map("updated_at")
  memo                     String?
  friendlyCategory         String?                  @map("friendly_category")
  categoryKey              String                   @map("category_key") @db.VarChar(255)
  label                    String                   @default("") @db.VarChar(255)
  hash                     String                   @default("") @db.VarChar(255)
  politicalOrganization    PoliticalOrganization    @relation(fields: [politicalOrganizationId], references: [id], onDelete: Cascade)
  transactionCounterparts  TransactionCounterpart[]
  transactionDonors        TransactionDonor[]

  @@unique([politicalOrganizationId, transactionNo])
  @@index([politicalOrganizationId, financialYear, transactionType, transactionDate(sort: Desc)])
  @@map("transactions")
}

model Counterpart {
  id        BigInt   @id @default(autoincrement())
  name      String   @db.VarChar(120)
  address   String?  @db.VarChar(120)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  transactionCounterparts TransactionCounterpart[]

  @@unique([name, address])
  @@map("counterparts")
}

model TransactionCounterpart {
  id            BigInt      @id @default(autoincrement())
  transactionId BigInt      @map("transaction_id")
  counterpartId BigInt      @map("counterpart_id")
  createdAt     DateTime    @default(now()) @map("created_at")

  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  counterpart Counterpart @relation(fields: [counterpartId], references: [id], onDelete: Cascade)

  @@unique([transactionId, counterpartId])
  @@unique([transactionId])
  @@index([transactionId], name: "idx_transaction_counterparts_transaction")
  @@index([counterpartId], name: "idx_transaction_counterparts_counterpart")
  @@map("transaction_counterparts")
}

model BalanceSnapshot {
  id                      BigInt                @id @default(autoincrement())
  politicalOrganizationId BigInt                @map("political_organization_id")
  snapshotDate            DateTime              @map("snapshot_date") @db.Date
  balance                 Decimal               @db.Decimal(15, 2)
  createdAt               DateTime              @default(now()) @map("created_at")
  updatedAt               DateTime              @updatedAt @map("updated_at")
  politicalOrganization   PoliticalOrganization @relation(fields: [politicalOrganizationId], references: [id], onDelete: Cascade)

  @@index([politicalOrganizationId, snapshotDate(sort: Desc), updatedAt(sort: Desc)])
  @@map("balance_snapshots")
}

model Donor {
  id                BigInt            @id @default(autoincrement())
  donorType         DonorType         @map("donor_type")
  name              String            @db.VarChar(120)
  address           String?           @db.VarChar(120)
  occupation        String?           @db.VarChar(50)
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")

  transactionDonors TransactionDonor[]

  @@unique([name, address, donorType])
  @@map("donors")
}

model TransactionDonor {
  id            BigInt      @id @default(autoincrement())
  transactionId BigInt      @map("transaction_id")
  donorId       BigInt      @map("donor_id")
  createdAt     DateTime    @default(now()) @map("created_at")

  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  donor       Donor       @relation(fields: [donorId], references: [id], onDelete: Cascade)

  @@unique([transactionId, donorId])
  @@unique([transactionId])
  @@index([transactionId], name: "idx_transaction_donors_transaction")
  @@index([donorId], name: "idx_transaction_donors_donor")
  @@map("transaction_donors")
}

model OrganizationReportProfile {
  id                      BigInt   @id @default(autoincrement())
  politicalOrganizationId BigInt   @map("political_organization_id")
  financialYear           Int      @map("financial_year")

  officialName            String?  @map("official_name") @db.VarChar(120)
  officialNameKana        String?  @map("official_name_kana") @db.VarChar(120)
  officeAddress           String?  @map("office_address") @db.VarChar(80)
  officeAddressBuilding   String?  @map("office_address_building") @db.VarChar(60)

  details                 Json     @default("{}")

  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  politicalOrganization   PoliticalOrganization @relation(fields: [politicalOrganizationId], references: [id], onDelete: Cascade)

  @@unique([politicalOrganizationId, financialYear])
  @@map("organization_report_profiles")
}

enum TransactionType {
  income
  expense
  non_cash_journal
  offset_income
  offset_expense
}

enum UserRole {
  admin
  user
}

enum DonorType {
  individual
  corporation
  political_organization
}
